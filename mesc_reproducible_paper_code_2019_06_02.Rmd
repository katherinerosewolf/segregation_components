---
title: "Segregation Components Paper Code"
author: "Katherine Rose Wolf"
date: "June 12, 2019"
output: html_document
---

# CODE SETUP

```{r load packages}

library(rmarkdown)
library(knitr)
library(plyr)
library(data.table)
library(Hmisc)
library(extrafontdb)
library(extrafont)
library(NADA)
library(grid)
library(gridExtra)
library(lattice)
library(tmap)
library(sf)
library(tidycensus)
library(tigris)
library(rgeos)
library(sjPlot)
library(stargazer)
library(readxl)
library(tidyverse)

```


```{r rmarkdown options, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```


```{r census api key and options for tidycensus}

# install the census api key
census_api_key("eae31d12c8d9c2c9ee288e096e0c03830744aaef", 
               install = TRUE, 
               overwrite = TRUE)

readRenviron("~/.Renviron")

# have tidycensus store old shapefiles for future use
options(tigris_use_cache = TRUE)

```

# CREATE SUBDIRECTORIES

```{r create subdirectories}
if(!dir.exists("raw_data"))
  dir.create("raw_data")

if(!dir.exists("intermediate_data"))
  dir.create("intermediate_data")
```


# LOAD NECESSARY FILES

```{r create file download function}

# create function that downloads files
file_downloader <-
  function(desired_filename_as_string, 
           web_address_as_string, 
           folder_as_string) {
    
    path <-  # specify the file path
      file.path(
        folder_as_string,
        desired_filename_as_string) 
    
    if(!file.exists(path))  # checks if file exists already
      download.file(url = web_address_as_string,  # if not, downloads/saves file
                    destfile = path, 
                    mode = "wb")
  }

```


```{r census data, results = "hide"}

# last updated by census bureau 	19-Jul-2012 07:01	391M

# download zip file of census dp1 shapefiles
file_downloader(
  desired_filename_as_string = "tract_2010_census_dp1.zip",
  web_address_as_string = 
    "http://www2.census.gov/geo/tiger/TIGER2010DP1/Tract_2010Census_DP1.zip", 
  folder_as_string = "raw_data"
  )

# unzip it to the intermediate file directory
unzip(
  file.path(
    "raw_data", 
    "tract_2010_census_dp1.zip"), 
  exdir = "intermediate_data")

# read the shapefile
census_data_shapefile <- 
  read_sf(
    file.path(
      "intermediate_data", 
      "Tract_2010Census_DP1.shp"
      )
    )

```

```{r ruca data}

# last tested 2019-06-05 1:17 a.m. PT

file_downloader(
  desired_filename_as_string = "ruca_2010_raw.xlsx", 
  web_address_as_string = 
    "https://www.ers.usda.gov/webdocs/DataFiles/53241/ruca2010.xlsx?v=0", 
  folder_as_string = "raw_data"
  )

ruca_2010_raw <- 
  read_xlsx(
    file.path(
      "raw_data", 
      "ruca_2010_raw.xlsx"
      )
    )

```

```{r speciation parameter codes, results = "hide"}

# downloaded June 5, 2019, 8:45 p.m. PT, last updated June 5, 2019, per EPA website

# download the speciation paramter codes
file_downloader(
  desired_filename_as_string = "speciation_parameter_codes.csv",
  web_address_as_string = "https://aqs.epa.gov/aqsweb/documents/codetables/methods_speciation.csv", 
  folder_as_string = "raw_data"
  )

# read the parameter codes into memory
speciation_parameter_codes <- 
  read_csv(
    file.path("raw_data", 
              "speciation_parameter_codes.csv"
              )
  )

```

## air pollution data files

```{r pm2.5 total frm}

# make list of files to download
pm25_frm_files <- 
  c("https://aqs.epa.gov/aqsweb/airdata/daily_88101_2005.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2006.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2007.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2008.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2009.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2010.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2011.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2012.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2013.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2014.zip",
    "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2015.zip")


# make a list of filenames to which to save the downloaded data by using the above filenames and regular expressions
list_of_zip_filenames <-  # make list of what the filenames will be
  map_chr(pm_25_frm_files,  # witness the `map` function
          str_extract, 
          "daily_.+\\.zip")   # witness the regular expression!

# download the total particulate matter and speciation data files
map2(list_of_zip_filenames, 
     pm_25_frm_files, 
     file_downloader, 
     folder_as_string = "raw_data")

# unzip all the files and save them to disk
map(
  file.path(
    "raw_data",
    list_of_zip_filenames
    ),
  unzip,
  exdir = "intermediate_data"
  )

```


```{r download and format air pollution data files, results = "hide"}

# # files downloaded 2019-06-05 ~ 10 p.m. PT, 
# # updated 2019-05-28 per the internet
# 
# # make a list of the web addresses of the total particulate matter and speciation data files
# 
# pm25_non_frm_files <- 
#   c("https://aqs.epa.gov/aqsweb/airdata/daily_88502_2005.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2006.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2007.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2008.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2009.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2010.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2011.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2012.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2013.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2014.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2015.zip")
# 
#   
# speciation_files <- 
#   c("https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2005.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2006.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2007.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2008.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2009.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2010.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2011.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2012.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2013.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2014.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_SPEC_2015.zip")
#   
#     
#     
# list_of_speciation_files_to_download <-   
#   c("https://aqs.epa.gov/aqsweb/airdata/daily_88101_2005.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2006.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2007.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2008.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2009.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2010.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2011.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2012.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2013.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2014.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88101_2015.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2005.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2006.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2007.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2008.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2009.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2010.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2011.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2012.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2013.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2014.zip",
#     "https://aqs.epa.gov/aqsweb/airdata/daily_88502_2015.zip",
# )
# 
# # make a list of filenames to which to save the downloaded data by using the above filenames and regular expressions
# list_of_zip_filenames <-  # make list of what the filenames will be
#   map_chr(list_of_speciation_files_to_download,  # witness the `map` function
#           str_extract, 
#           "daily_.+\\.zip")   # witness the regular expression!
# 
# # download the total particulate matter and speciation data files
# map2(list_of_zip_filenames, 
#      list_of_speciation_files_to_download, 
#      file_downloader, 
#      folder_as_string = "raw_data")
# 
# # # unzip all the files and save them to disk
# # map(
# #   file.path(
# #     "raw_data", 
# #     list_of_zip_filenames
# #     ),
# #   unzip,
# #   exdir = "intermediate_data"
# #   )
# # 
# # # replace ".zip" with ".csv" in list_of_zip_filenames
# # list_of_csv_filenames <-
# #   map(list_of_zip_filenames,
# #       str_replace,
# #       "zip",  
# #       "csv")
# # 
# # # make list of tibble names by removing the ".zip" extension
# # list_of_tibble_names <-
# #   map(list_of_zip_filenames,
# #       str_replace,
# #       ".zip",
# #       "")
# # 
# # # read .csv files into tibbles!
# # if(
# #   !file.exists(
# #     file.path(
# #       "intermediate_data",
# #       "list_of_air_pollution_tibbles.rdata"
# #       )
# #     )
# #   ) {  # checks if tibbles already exist
# #   list_of_air_pollution_tibbles <-  # if not reads .csv files into tibbles
# #     map(
# #       file.path(
# #         "intermediate_data", 
# #         list_of_csv_filenames), 
# #       read_csv
# #       )  
# #   names(list_of_air_pollution_tibbles) <-  # names the tibbles
# #     list_of_tibble_names
# #   save(
# #     list_of_air_pollution_tibbles,  # saves the tibbles to disk to avoid doing this again
# #     file = file.path(
# #       "intermediate_data",
# #       "list_of_air_pollution_tibbles.rdata"
# #       )
# #     )
# # } else {
# #     load(file = "list_of_air_pollution_tibbles.rdata")  # loads the tibbles if they don't already exist
# # }
# # 
# # 
# # # function to convert column names to snake case
# # column_name_fixer <- 
# #   function(tibble) {
# #   new_names <- 
# #     tibble %>% 
# #     colnames() %>%  # gets the column names from the tibble
# #     tolower() %>%  # converts the column names to lowercase
# #     {gsub(" ", "_", .)}  # replaces spaces with "_"
# #   colnames(tibble) <-  
# #     new_names  # rename the columns in the original tibble
# #   return(tibble)
# #   }
# # 
# # # fix air data column names
# # list_of_air_pollution_tibbles_renamed <-
# #   map(list_of_air_pollution_tibbles,
# #       column_name_fixer)
# # 
# # # combine air data tibbles into one big tibble
# # all_air_data <-
# #   bind_rows(list_of_air_pollution_tibbles_renamed)
# # 
# # # save all air data to disk
# # save(
# #     all_air_data,  # saves the tibbles to disk to avoid doing this again
# #     file = file.path(
# #       "intermediate_data",
# #       "all_air_data.rdata"
# #       )
# #     )


```

## clean air pollution data

## american community survey data
