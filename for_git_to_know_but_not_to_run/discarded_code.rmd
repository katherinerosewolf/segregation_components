---
title: "discarded code too good to delete"
author: "Katherine Rose Wolf"
date: "June 27, 2019"
output: html_document
---
# DISCARDED CODE TOO GOOD TO DELETE

#### old functions

```{r old functions, eval=FALSE, include=FALSE}

# function to read decennial data without asking about downloads
read_decennial_auto <- 
  function (year, states, table_contents = NULL, areas = NULL, 
    geo_headers = NULL, summary_level = NULL, geo_comp = "total", 
    show_progress = TRUE) 
{
    if (Sys.getenv("PATH_TO_CENSUS") == "") {
        message(paste("Please set up the path to downloaded census data, following the instruction at", 
            "https://github.com/GL-Li/totalcensus."))
        return(NULL)
    }
    if (is.null(summary_level)) 
        summary_level <- "*"
    states <- toupper(states)
    path_to_census <- Sys.getenv("PATH_TO_CENSUS")
    generated_data <- paste0(path_to_census, "/generated_data")
    if (!file.exists(generated_data)) {
        download_generated_data_auto()
    }
    else {
        version_file <- paste0(generated_data, "/version.txt")
        if (!file.exists(version_file)) {
            download_generated_data_auto()
        }
        else {
            version = readChar(version_file, 5)
            if (version != "0.6.0") {
                download_generated_data_auto()
            }
        }
    }
    if (year == 2010) {
        ext <- ".ur1"
    }
    else if (year == 2000) {
        ext <- ".uf1"
    }
    not_downloaded <- c()
    for (st in states) {
        geo_file <- paste0(path_to_census, "/census", year, "/", 
            st, "/", tolower(st), "geo", year, ext)
        if (!file.exists(geo_file)) {
            not_downloaded <- c(not_downloaded, st)
        }
    }
    if (length(not_downloaded) > 0) {
            download_census("decennial", year, not_downloaded)
    }
    options(warn = -1)
    if (is.null(areas) + is.null(geo_headers) == 0) {
        stop("Must keep at least one of arguments areas and geo_headers NULL")
    }
    if (any(grepl("P0010001", table_contents))) {
        message("P0010001 is the population column.")
    }
    table_contents <- table_contents[!grepl("P0010001", table_contents)]
    table_contents <- c("population = P0010001", table_contents) %>% 
        unique()
    content_names <- organize_tablecontents(table_contents) %>% 
        .[, name]
    table_contents <- organize_tablecontents(table_contents) %>% 
        .[, reference]
    if (!is.null(areas)) {
        dt <- read_decennial_areas_(year, states, table_contents, 
            areas, summary_level, geo_comp, show_progress)
    }
    else {
        dt <- read_decennial_geoheaders_(year, states, table_contents, 
            geo_headers, summary_level, geo_comp, show_progress)
    }
    setnames(dt, table_contents, content_names)
    options(warn = 0)
    return(dt)
  }

# function to download acs data without asking
read_acs5year_auto <- 
  function (year, states, table_contents = NULL, areas = NULL, 
    geo_headers = NULL, summary_level = NULL, geo_comp = "total", 
    with_margin = FALSE, dec_fill = NULL, show_progress = TRUE) 
{
    if (Sys.getenv("PATH_TO_CENSUS") == "") {
        message(paste("Please set up the path to downloaded census data", 
            "following the instruction at", "https://github.com/GL-Li/totalcensus."))
        return(NULL)
    }
    path_to_census <- Sys.getenv("PATH_TO_CENSUS")
    generated_data <- paste0(path_to_census, "/generated_data")
    if (!file.exists(generated_data)) {
        download_generated_data_auto()
    }
    else {
        version_file <- paste0(generated_data, "/version.txt")
        if (!file.exists(version_file)) {
            download_generated_data_auto()
        }
        else {
            version = readChar(version_file, 5)
            if (version != "0.6.0") {
                download_generated_data_auto()
            }
        }
    }
    not_downloaded <- c()
    for (st in states) {
        if (!file.exists(paste0(path_to_census, "/acs5year/", 
            year, "/g", year, "5", tolower(st), ".csv"))) {
            not_downloaded <- c(not_downloaded, st)
        }
    }
    if (length(not_downloaded) > 0) {
            download_census("acs5", year, not_downloaded)
    }
    if (is.null(summary_level)) 
        summary_level <- "*"
    states <- toupper(states)
    if (is.null(areas) + is.null(geo_headers) == 0) {
        stop("Must keep at least one of arguments areas and geo_headers NULL")
    }
    if (any(grepl("B01003_001", table_contents))) {
        message("B01003_001 is the population column.")
    }
    table_contents <- table_contents[!grepl("B01003_001", table_contents)]
    table_contents <- c("population = B01003_001", table_contents) %>% 
        unique()
    content_names <- organize_tablecontents(table_contents) %>% 
        .[, name]
    table_contents <- organize_tablecontents(table_contents) %>% 
        .[, reference] %>% toupper()
    options(warn = -1)
    if (!is.null(areas)) {
        dt <- read_acs5year_areas_(year, states, table_contents, 
            areas, summary_level, geo_comp, with_margin, dec_fill, 
            show_progress)
    }
    else {
        geo_headers <- unique(geo_headers)
        dt <- read_acs5year_geoheaders_(year, states, table_contents, 
            geo_headers, summary_level, geo_comp, with_margin, 
            dec_fill, show_progress)
    }
    setnames(dt, table_contents, content_names)
    if (with_margin) {
        setnames(dt, paste0(table_contents, "_m"), paste0(content_names, 
            "_margin"))
    }
    options(warn = 0)
    return(dt)
  }

```


#### census shapefile with data

```{r census shapefile with dp1 data, eval=FALSE, include=FALSE, results=}

# source http://www2.census.gov/geo/tiger/TIGER2010DP1/Tract_2010Census_DP1.zip?#
# downloaded 19 June 2019
# last updated by census bureau 19-Jul-2012 07:01	391M

if(
  !file.exists(
    file.path(
      "intermediate_data", 
      "census_data_shapefile.rdata"
      )
    )
) {
  # download zip file of census dp1 shapefiles
  file_downloader(
    desired_filename_as_string = "tract_2010_census_dp1.zip",
    web_address_as_string = 
      "http://www2.census.gov/geo/tiger/TIGER2010DP1/Tract_2010Census_DP1.zip", 
    folder_as_string = "raw_data"
    )

  # unzip it to the intermediate file directory
  unzip(
    file.path(
      "raw_data", 
      "tract_2010_census_dp1.zip"), 
    exdir = "intermediate_data")

  # read the shapefile
  census_data_shapefile <- 
    read_sf(
      file.path(
        "intermediate_data", 
        "Tract_2010Census_DP1.shp"
        )
      )
  
  # fix column names
  census_data_shapefile <-
    column_name_fixer(
      census_data_shapefile
    )
  
  # remove the data

  # save the shapefile
  save(
    census_data_shapefile,
    file = file.path(
      "intermediate_data", 
      "census_data_shapefile.rdata"
    )
  )

  # remove the shapefile from memory
  rm(census_data_shapefile)
  gc()
}

```


```{r census less detailed clipped cartographic boundary file, eval=FALSE, include=FALSE}

# source "https://www2.census.gov/geo/tiger/GENZ2010/gz_2010_%s_140_00_500k.zip"
# where %s is the state FIPS code
# downloaded 20 June 2019
# last modified 1 March 2012 (all)

if(
  !file.exists(
    file.path(
      "intermediate_data",
      "tigris_cbf_no_data.rdata"
      )
    )
  ) {
  
  # make vector of state abbreviations
  state_abbreviation_character_vector_no_pr <- 
      c("AK", "AL", "AR", "AZ", "CA", "CO", "CT", "DC", "DE", "FL", "GA", "HI", "IA", "ID", "IL", "IN", "KS", "KY", "LA", "MA", "MD", "ME", "MI", "MN", "MO", "MS",  "MT", "NC", "ND", "NE", "NH", "NJ", "NM", "NV", "NY", "OH", "OK", "OR", "PA", "PR", "RI", "SC", "SD", "TN", "TX", "UT", "VA", "VI", "VT", "WA", "WI", "WV", "WY")
  
  # download the data
  tigris_cbf_no_data <- 
    rbind_tigris(
    map(
      state_abbreviation_character_vector_no_pr, 
      function(x) {
        tracts(
          x, 
          cb = TRUE, 
          year = 2010, 
          class = 'sf'
          )
        }
      )
  )
  
  # save the result to disk
  save(
    tigris_cbf_no_data, 
    file = 
      file.path(
        "raw_data", 
        "tigris_cbf_no_data.rdata"
      )
  )
  
  # remove the files
  rm(
    tigris_cbf_no_data, 
    state_abbreviation_character_vector_no_pr
  )
  gc()
}

```


#### census tidycensus variable pulls (DO NOT RUN)

```{r total_pop_sf1_p1 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "total_pop_sf1_p1_tibble.rdata"
      )
    )
  ) {

total_pop_sf1_p1_list <- 
  list()

  # pull the actual data
  total_pop_sf1_p1_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "AL", 
      year = 2010)
  
  total_pop_sf1_p1_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "AK", 
      year = 2010)
  
  total_pop_sf1_p1_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "AZ", 
      year = 2010)
  
  total_pop_sf1_p1_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "AR", 
      year = 2010)
  
  total_pop_sf1_p1_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "CA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "CO", 
      year = 2010)
  
  total_pop_sf1_p1_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "CT", 
      year = 2010)
  
  total_pop_sf1_p1_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "DE", 
      year = 2010)
  
  total_pop_sf1_p1_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "FL", 
      year = 2010)
  
  total_pop_sf1_p1_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "GA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "HI", 
      year = 2010)
  
  total_pop_sf1_p1_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "ID", 
      year = 2010)
  
  total_pop_sf1_p1_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "IL", 
      year = 2010)
  
  total_pop_sf1_p1_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "IN", 
      year = 2010)
  
  total_pop_sf1_p1_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "IA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "KS", 
      year = 2010)
  
  total_pop_sf1_p1_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "KY", 
      year = 2010)
  
  total_pop_sf1_p1_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "LA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "ME", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MD", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MI", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MN", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MS", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MO", 
      year = 2010)
  
  total_pop_sf1_p1_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "MT", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NE", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NV", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NH", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NJ", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NM", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NY", 
      year = 2010)
  
  total_pop_sf1_p1_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "NC", 
      year = 2010)
  
  total_pop_sf1_p1_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "ND", 
      year = 2010)
  
  total_pop_sf1_p1_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "OH", 
      year = 2010)
  
  total_pop_sf1_p1_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "OK", 
      year = 2010)
  
  total_pop_sf1_p1_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "OR", 
      year = 2010)
  
  total_pop_sf1_p1_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "PA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "RI", 
      year = 2010)
  
  total_pop_sf1_p1_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "SC", 
      year = 2010)
  
  total_pop_sf1_p1_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "SD", 
      year = 2010)
  
  total_pop_sf1_p1_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "TN", 
      year = 2010)
  
  total_pop_sf1_p1_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "TX", 
      year = 2010)
  
  total_pop_sf1_p1_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "UT", 
      year = 2010)
  
  total_pop_sf1_p1_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "VT", 
      year = 2010)
  
  total_pop_sf1_p1_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "VA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "WA", 
      year = 2010)
  
  total_pop_sf1_p1_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "WV", 
      year = 2010)
  
  total_pop_sf1_p1_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "WI", 
      year = 2010)
  
  total_pop_sf1_p1_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = total_pop_sf1_p1, 
      state = "WY", 
      year = 2010)
  
  total_pop_sf1_p1_tibble <- 
    bind_rows(total_pop_sf1_p1_list)
  
  save(
    total_pop_sf1_p1_list, 
    file = 
      file.path(
        "intermediate_data", 
        "total_pop_sf1_p1_list.rdata"
      )
    )
  
  save(
    total_pop_sf1_p1_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "total_pop_sf1_p1_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    total_pop_sf1_p1_list, 
    total_pop_sf1_p1_tibble
    )
  gc()
}

```


```{r race_sf1_p5 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "race_sf1_p5_tibble.rdata"
      )
    )
  ) {

race_sf1_p5_list <- 
  list()

  # pull the actual data
  race_sf1_p5_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "AL", 
      year = 2010)
  
  race_sf1_p5_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "AK", 
      year = 2010)
  
  race_sf1_p5_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "AZ", 
      year = 2010)
  
  race_sf1_p5_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "AR", 
      year = 2010)
  
  race_sf1_p5_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "CA", 
      year = 2010)
  
  race_sf1_p5_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "CO", 
      year = 2010)
  
  race_sf1_p5_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "CT", 
      year = 2010)
  
  race_sf1_p5_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "DE", 
      year = 2010)
  
  race_sf1_p5_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "FL", 
      year = 2010)
  
  race_sf1_p5_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "GA", 
      year = 2010)
  
  race_sf1_p5_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "HI", 
      year = 2010)
  
  race_sf1_p5_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "ID", 
      year = 2010)
  
  race_sf1_p5_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "IL", 
      year = 2010)
  
  race_sf1_p5_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "IN", 
      year = 2010)
  
  race_sf1_p5_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "IA", 
      year = 2010)
  
  race_sf1_p5_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "KS", 
      year = 2010)
  
  race_sf1_p5_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "KY", 
      year = 2010)
  
  race_sf1_p5_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "LA", 
      year = 2010)
  
  race_sf1_p5_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "ME", 
      year = 2010)
  
  race_sf1_p5_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MD", 
      year = 2010)
  
  race_sf1_p5_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MA", 
      year = 2010)
  
  race_sf1_p5_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MI", 
      year = 2010)
  
  race_sf1_p5_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MN", 
      year = 2010)
  
  race_sf1_p5_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MS", 
      year = 2010)
  
  race_sf1_p5_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MO", 
      year = 2010)
  
  race_sf1_p5_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "MT", 
      year = 2010)
  
  race_sf1_p5_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NE", 
      year = 2010)
  
  race_sf1_p5_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NV", 
      year = 2010)
  
  race_sf1_p5_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NH", 
      year = 2010)
  
  race_sf1_p5_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NJ", 
      year = 2010)
  
  race_sf1_p5_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NM", 
      year = 2010)
  
  race_sf1_p5_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NY", 
      year = 2010)
  
  race_sf1_p5_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "NC", 
      year = 2010)
  
  race_sf1_p5_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "ND", 
      year = 2010)
  
  race_sf1_p5_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "OH", 
      year = 2010)
  
  race_sf1_p5_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "OK", 
      year = 2010)
  
  race_sf1_p5_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "OR", 
      year = 2010)
  
  race_sf1_p5_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "PA", 
      year = 2010)
  
  race_sf1_p5_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "RI", 
      year = 2010)
  
  race_sf1_p5_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "SC", 
      year = 2010)
  
  race_sf1_p5_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "SD", 
      year = 2010)
  
  race_sf1_p5_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "TN", 
      year = 2010)
  
  race_sf1_p5_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "TX", 
      year = 2010)
  
  race_sf1_p5_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "UT", 
      year = 2010)
  
  race_sf1_p5_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "VT", 
      year = 2010)
  
  race_sf1_p5_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "VA", 
      year = 2010)
  
  race_sf1_p5_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "WA", 
      year = 2010)
  
  race_sf1_p5_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "WV", 
      year = 2010)
  
  race_sf1_p5_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "WI", 
      year = 2010)
  
  race_sf1_p5_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = race_sf1_p5, 
      state = "WY", 
      year = 2010)
  
  race_sf1_p5_tibble <- 
    bind_rows(race_sf1_p5_list)
  
  save(
    race_sf1_p5_list, 
    file = 
      file.path(
        "intermediate_data", 
        "race_sf1_p5_list.rdata"
      )
    )
  
  save(
    race_sf1_p5_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "race_sf1_p5_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    race_sf1_p5_list, 
    race_sf1_p5_tibble
    )
  gc()
}

```


```{r sex_by_age_sf1_p12 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "sex_by_age_sf1_p12_tibble.rdata"
      )
    )
  ) {

sex_by_age_sf1_p12_list <- 
  list()

  # pull the actual data
  sex_by_age_sf1_p12_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "AL", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "AK", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "AZ", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "AR", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "CA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "CO", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "CT", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "DE", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "FL", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "GA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "HI", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "ID", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "IL", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "IN", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "IA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "KS", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "KY", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "LA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "ME", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MD", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MI", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MN", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MS", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MO", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "MT", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NE", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NV", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NH", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NJ", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NM", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NY", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "NC", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "ND", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "OH", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "OK", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "OR", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "PA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "RI", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "SC", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "SD", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "TN", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "TX", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "UT", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "VT", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "VA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "WA", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "WV", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "WI", 
      year = 2010)
  
  sex_by_age_sf1_p12_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = sex_by_age_sf1_p12, 
      state = "WY", 
      year = 2010)
  
  sex_by_age_sf1_p12_tibble <- 
    bind_rows(sex_by_age_sf1_p12_list)
  
  save(
    sex_by_age_sf1_p12_list, 
    file = 
      file.path(
        "intermediate_data", 
        "sex_by_age_sf1_p12_list.rdata"
      )
    )
  
  save(
    sex_by_age_sf1_p12_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "sex_by_age_sf1_p12_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    sex_by_age_sf1_p12_list, 
    sex_by_age_sf1_p12_tibble
    )
  gc()
}

```


```{r age_median_sf1_p13 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "age_median_sf1_p13_tibble.rdata"
      )
    )
  ) {

age_median_sf1_p13_list <- 
  list()

  # pull the actual data
  age_median_sf1_p13_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "AL", 
      year = 2010)
  
  age_median_sf1_p13_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "AK", 
      year = 2010)
  
  age_median_sf1_p13_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "AZ", 
      year = 2010)
  
  age_median_sf1_p13_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "AR", 
      year = 2010)
  
  age_median_sf1_p13_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "CA", 
      year = 2010)
  
  age_median_sf1_p13_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "CO", 
      year = 2010)
  
  age_median_sf1_p13_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "CT", 
      year = 2010)
  
  age_median_sf1_p13_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "DE", 
      year = 2010)
  
  age_median_sf1_p13_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "FL", 
      year = 2010)
  
  age_median_sf1_p13_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "GA", 
      year = 2010)
  
  age_median_sf1_p13_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "HI", 
      year = 2010)
  
  age_median_sf1_p13_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "ID", 
      year = 2010)
  
  age_median_sf1_p13_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "IL", 
      year = 2010)
  
  age_median_sf1_p13_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "IN", 
      year = 2010)
  
  age_median_sf1_p13_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "IA", 
      year = 2010)
  
  age_median_sf1_p13_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "KS", 
      year = 2010)
  
  age_median_sf1_p13_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "KY", 
      year = 2010)
  
  age_median_sf1_p13_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "LA", 
      year = 2010)
  
  age_median_sf1_p13_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "ME", 
      year = 2010)
  
  age_median_sf1_p13_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MD", 
      year = 2010)
  
  age_median_sf1_p13_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MA", 
      year = 2010)
  
  age_median_sf1_p13_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MI", 
      year = 2010)
  
  age_median_sf1_p13_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MN", 
      year = 2010)
  
  age_median_sf1_p13_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MS", 
      year = 2010)
  
  age_median_sf1_p13_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MO", 
      year = 2010)
  
  age_median_sf1_p13_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "MT", 
      year = 2010)
  
  age_median_sf1_p13_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NE", 
      year = 2010)
  
  age_median_sf1_p13_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NV", 
      year = 2010)
  
  age_median_sf1_p13_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NH", 
      year = 2010)
  
  age_median_sf1_p13_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NJ", 
      year = 2010)
  
  age_median_sf1_p13_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NM", 
      year = 2010)
  
  age_median_sf1_p13_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NY", 
      year = 2010)
  
  age_median_sf1_p13_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "NC", 
      year = 2010)
  
  age_median_sf1_p13_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "ND", 
      year = 2010)
  
  age_median_sf1_p13_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "OH", 
      year = 2010)
  
  age_median_sf1_p13_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "OK", 
      year = 2010)
  
  age_median_sf1_p13_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "OR", 
      year = 2010)
  
  age_median_sf1_p13_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "PA", 
      year = 2010)
  
  age_median_sf1_p13_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "RI", 
      year = 2010)
  
  age_median_sf1_p13_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "SC", 
      year = 2010)
  
  age_median_sf1_p13_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "SD", 
      year = 2010)
  
  age_median_sf1_p13_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "TN", 
      year = 2010)
  
  age_median_sf1_p13_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "TX", 
      year = 2010)
  
  age_median_sf1_p13_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "UT", 
      year = 2010)
  
  age_median_sf1_p13_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "VT", 
      year = 2010)
  
  age_median_sf1_p13_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "VA", 
      year = 2010)
  
  age_median_sf1_p13_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "WA", 
      year = 2010)
  
  age_median_sf1_p13_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "WV", 
      year = 2010)
  
  age_median_sf1_p13_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "WI", 
      year = 2010)
  
  age_median_sf1_p13_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = age_median_sf1_p13, 
      state = "WY", 
      year = 2010)
  
  age_median_sf1_p13_tibble <- 
    bind_rows(age_median_sf1_p13_list)
  
  save(
    age_median_sf1_p13_list, 
    file = 
      file.path(
        "intermediate_data", 
        "age_median_sf1_p13_list.rdata"
      )
    )
  
  save(
    age_median_sf1_p13_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "age_median_sf1_p13_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    age_median_sf1_p13_list, 
    age_median_sf1_p13_tibble
    )
  gc()
}

```


```{r occupancy_sf1_h3 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "occupancy_sf1_h3_tibble.rdata"
      )
    )
  ) {

occupancy_sf1_h3_list <- 
  list()

  # pull the actual data
  occupancy_sf1_h3_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "AL", 
      year = 2010)
  
  occupancy_sf1_h3_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "AK", 
      year = 2010)
  
  occupancy_sf1_h3_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "AZ", 
      year = 2010)
  
  occupancy_sf1_h3_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "AR", 
      year = 2010)
  
  occupancy_sf1_h3_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "CA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "CO", 
      year = 2010)
  
  occupancy_sf1_h3_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "CT", 
      year = 2010)
  
  occupancy_sf1_h3_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "DE", 
      year = 2010)
  
  occupancy_sf1_h3_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "FL", 
      year = 2010)
  
  occupancy_sf1_h3_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "GA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "HI", 
      year = 2010)
  
  occupancy_sf1_h3_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "ID", 
      year = 2010)
  
  occupancy_sf1_h3_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "IL", 
      year = 2010)
  
  occupancy_sf1_h3_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "IN", 
      year = 2010)
  
  occupancy_sf1_h3_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "IA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "KS", 
      year = 2010)
  
  occupancy_sf1_h3_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "KY", 
      year = 2010)
  
  occupancy_sf1_h3_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "LA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "ME", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MD", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MI", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MN", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MS", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MO", 
      year = 2010)
  
  occupancy_sf1_h3_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "MT", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NE", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NV", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NH", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NJ", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NM", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NY", 
      year = 2010)
  
  occupancy_sf1_h3_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "NC", 
      year = 2010)
  
  occupancy_sf1_h3_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "ND", 
      year = 2010)
  
  occupancy_sf1_h3_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "OH", 
      year = 2010)
  
  occupancy_sf1_h3_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "OK", 
      year = 2010)
  
  occupancy_sf1_h3_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "OR", 
      year = 2010)
  
  occupancy_sf1_h3_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "PA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "RI", 
      year = 2010)
  
  occupancy_sf1_h3_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "SC", 
      year = 2010)
  
  occupancy_sf1_h3_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "SD", 
      year = 2010)
  
  occupancy_sf1_h3_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "TN", 
      year = 2010)
  
  occupancy_sf1_h3_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "TX", 
      year = 2010)
  
  occupancy_sf1_h3_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "UT", 
      year = 2010)
  
  occupancy_sf1_h3_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "VT", 
      year = 2010)
  
  occupancy_sf1_h3_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "VA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "WA", 
      year = 2010)
  
  occupancy_sf1_h3_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "WV", 
      year = 2010)
  
  occupancy_sf1_h3_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "WI", 
      year = 2010)
  
  occupancy_sf1_h3_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = occupancy_sf1_h3, 
      state = "WY", 
      year = 2010)
  
  occupancy_sf1_h3_tibble <- 
    bind_rows(occupancy_sf1_h3_list)
  
  save(
    occupancy_sf1_h3_list, 
    file = 
      file.path(
        "intermediate_data", 
        "occupancy_sf1_h3_list.rdata"
      )
    )
  
  save(
    occupancy_sf1_h3_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "occupancy_sf1_h3_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    occupancy_sf1_h3_list, 
    occupancy_sf1_h3_tibble
    )
  gc()
}

```


```{r housing_tenure_sf1_h4 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "housing_tenure_sf1_h4_tibble.rdata"
      )
    )
  ) {

housing_tenure_sf1_h4_list <- 
  list()

  # pull the actual data
  housing_tenure_sf1_h4_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "AL", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "AK", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "AZ", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "AR", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "CA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "CO", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "CT", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "DE", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "FL", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "GA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "HI", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "ID", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "IL", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "IN", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "IA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "KS", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "KY", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "LA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "ME", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MD", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MI", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MN", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MS", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MO", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "MT", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NE", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NV", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NH", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NJ", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NM", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NY", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "NC", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "ND", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "OH", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "OK", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "OR", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "PA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "RI", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "SC", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "SD", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "TN", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "TX", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "UT", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "VT", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "VA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "WA", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "WV", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "WI", 
      year = 2010)
  
  housing_tenure_sf1_h4_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_sf1_h4, 
      state = "WY", 
      year = 2010)
  
  housing_tenure_sf1_h4_tibble <- 
    bind_rows(housing_tenure_sf1_h4_list)
  
  save(
    housing_tenure_sf1_h4_list, 
    file = 
      file.path(
        "intermediate_data", 
        "housing_tenure_sf1_h4_list.rdata"
      )
    )
  
  save(
    housing_tenure_sf1_h4_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "housing_tenure_sf1_h4_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    housing_tenure_sf1_h4_list, 
    housing_tenure_sf1_h4_tibble
    )
  gc()
}

```


```{r housing_tenure_people_sf1_h11 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "housing_tenure_people_sf1_h11_tibble.rdata"
      )
    )
  ) {

housing_tenure_people_sf1_h11_list <- 
  list()

  # pull the actual data
  housing_tenure_people_sf1_h11_list[["AL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "AL", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["AK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "AK", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["AZ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "AZ", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["AR"]] <- 
      get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "AR", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["CA"]] <- 
      get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "CA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["CO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "CO", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["CT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "CT", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["DE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "DE", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["FL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "FL", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["GA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "GA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["HI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "HI", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["ID"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "ID", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["IL"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "IL", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["IN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "IN", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["IA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "IA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["KS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "KS", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["KY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "KY", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["LA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "LA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["ME"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "ME", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MD", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MI", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MN", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MS"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MS", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MO"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MO", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["MT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "MT", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NE"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NE", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NV", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NH", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NJ"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NJ", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NM"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NM", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NY", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["NC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "NC", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["ND"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "ND", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["OH"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "OH", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["OK"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "OK", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["OR"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "OR", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["PA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "PA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["RI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "RI", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["SC"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "SC", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["SD"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "SD", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["TN"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "TN", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["TX"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "TX", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["UT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "UT", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["VT"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "VT", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["VA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "VA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["WA"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "WA", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["WV"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "WV", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["WI"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "WI", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_list[["WY"]] <- 
    get_decennial(
      geography = "tract", 
      variables = housing_tenure_people_sf1_h11, 
      state = "WY", 
      year = 2010)
  
  housing_tenure_people_sf1_h11_tibble <- 
    bind_rows(housing_tenure_people_sf1_h11_list)
  
  save(
    housing_tenure_people_sf1_h11_list, 
    file = 
      file.path(
        "intermediate_data", 
        "housing_tenure_people_sf1_h11_list.rdata"
      )
    )
  
  save(
    housing_tenure_people_sf1_h11_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "housing_tenure_people_sf1_h11_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    housing_tenure_people_sf1_h11_list, 
    housing_tenure_people_sf1_h11_tibble
    )
  gc()
}

```


#### acs tidycensus variable pulls (DO NOT RUN)

```{r total pop b01003 download, eval=FALSE, include=FALSE}

# if(
#   !file.exists(  # checks if tibble already exists
#     file.path(
#       "intermediate_data",
#       "total_pop_tibble_list.rdata"
#       )
#     )
#   ) {
# 
#   # list of dataframes for states
#   total_pop_tibble_list <- 
#     list()
#   
#   # pull the actual data
#   total_pop_tibble_list[["AL"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "AL", 
#       year = 2012)
#   
#   total_pop_tibble_list[["AK"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "AK", 
#       year = 2012)
#   
#   total_pop_tibble_list[["AZ"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "AZ", 
#       year = 2012)
#   
#   total_pop_tibble_list[["AR"]] <- 
#       get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "AR", 
#       year = 2012)
#   
#   total_pop_tibble_list[["CA"]] <- 
#       get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "CA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["CO"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "CO", 
#       year = 2012)
#   
#   total_pop_tibble_list[["CT"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "CT", 
#       year = 2012)
#   
#   total_pop_tibble_list[["DE"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "DE", 
#       year = 2012)
#   
#   total_pop_tibble_list[["FL"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "FL", 
#       year = 2012)
#   
#   total_pop_tibble_list[["GA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "GA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["HI"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "HI", 
#       year = 2012)
#   
#   total_pop_tibble_list[["ID"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "ID", 
#       year = 2012)
#   
#   total_pop_tibble_list[["IL"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "IL", 
#       year = 2012)
#   
#   total_pop_tibble_list[["IN"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "IN", 
#       year = 2012)
#   
#   total_pop_tibble_list[["IA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "IA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["KS"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "KS", 
#       year = 2012)
#   
#   total_pop_tibble_list[["KY"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "KY", 
#       year = 2012)
#   
#   total_pop_tibble_list[["LA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "LA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["ME"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "ME", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MD"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MD", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MI"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MI", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MN"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MN", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MS"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MS", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MO"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MO", 
#       year = 2012)
#   
#   total_pop_tibble_list[["MT"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "MT", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NE"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NE", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NV"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NV", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NH"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NH", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NJ"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NJ", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NM"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NM", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NY"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NY", 
#       year = 2012)
#   
#   total_pop_tibble_list[["NC"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "NC", 
#       year = 2012)
#   
#   total_pop_tibble_list[["ND"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "ND", 
#       year = 2012)
#   
#   total_pop_tibble_list[["OH"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "OH", 
#       year = 2012)
#   
#   total_pop_tibble_list[["OK"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "OK", 
#       year = 2012)
#   
#   total_pop_tibble_list[["OR"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "OR", 
#       year = 2012)
#   
#   total_pop_tibble_list[["PA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "PA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["RI"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "RI", 
#       year = 2012)
#   
#   total_pop_tibble_list[["SC"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "SC", 
#       year = 2012)
#   
#   total_pop_tibble_list[["SD"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "SD", 
#       year = 2012)
#   
#   total_pop_tibble_list[["TN"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "TN", 
#       year = 2012)
#   
#   total_pop_tibble_list[["TX"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "TX", 
#       year = 2012)
#   
#   total_pop_tibble_list[["UT"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "UT", 
#       year = 2012)
#   
#   total_pop_tibble_list[["VT"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "VT", 
#       year = 2012)
#   
#   total_pop_tibble_list[["VA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "VA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["WA"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "WA", 
#       year = 2012)
#   
#   total_pop_tibble_list[["WV"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "WV", 
#       year = 2012)
#   
#   total_pop_tibble_list[["WI"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "WI", 
#       year = 2012)
#   
#   total_pop_tibble_list[["WY"]] <- 
#     get_acs(
#       geography = "tract", 
#       variables = "B01003_001", 
#       state = "WY", 
#       year = 2012)
#   
#   save(
#     total_pop_tibble_list, 
#     file = 
#       file.path(
#         "intermediate_data", 
#         "total_pop_tibble_list.rdata"
#       )
#     )
#   
#   # rm(total_pop_tibble_list)
#   # gc()
# }    

```


```{r edu_cat_b15003 download, eval=FALSE, include=FALSE}

if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "edu_cat_b15003_tibble.rdata"
      )
    )
  ) {

edu_cat_b15003_list <- 
  list()

  # pull the actual data
  edu_cat_b15003_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "AL", 
      year = 2012)
  
  edu_cat_b15003_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "AK", 
      year = 2012)
  
  edu_cat_b15003_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "AZ", 
      year = 2012)
  
  edu_cat_b15003_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "AR", 
      year = 2012)
  
  edu_cat_b15003_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "CA", 
      year = 2012)
  
  edu_cat_b15003_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "CO", 
      year = 2012)
  
  edu_cat_b15003_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "CT", 
      year = 2012)
  
  edu_cat_b15003_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "DE", 
      year = 2012)
  
  edu_cat_b15003_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "FL", 
      year = 2012)
  
  edu_cat_b15003_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "GA", 
      year = 2012)
  
  edu_cat_b15003_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "HI", 
      year = 2012)
  
  edu_cat_b15003_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "ID", 
      year = 2012)
  
  edu_cat_b15003_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "IL", 
      year = 2012)
  
  edu_cat_b15003_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "IN", 
      year = 2012)
  
  edu_cat_b15003_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "IA", 
      year = 2012)
  
  edu_cat_b15003_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "KS", 
      year = 2012)
  
  edu_cat_b15003_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "KY", 
      year = 2012)
  
  edu_cat_b15003_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "LA", 
      year = 2012)
  
  edu_cat_b15003_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "ME", 
      year = 2012)
  
  edu_cat_b15003_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MD", 
      year = 2012)
  
  edu_cat_b15003_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MA", 
      year = 2012)
  
  edu_cat_b15003_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MI", 
      year = 2012)
  
  edu_cat_b15003_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MN", 
      year = 2012)
  
  edu_cat_b15003_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MS", 
      year = 2012)
  
  edu_cat_b15003_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MO", 
      year = 2012)
  
  edu_cat_b15003_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "MT", 
      year = 2012)
  
  edu_cat_b15003_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NE", 
      year = 2012)
  
  edu_cat_b15003_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NV", 
      year = 2012)
  
  edu_cat_b15003_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NH", 
      year = 2012)
  
  edu_cat_b15003_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NJ", 
      year = 2012)
  
  edu_cat_b15003_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NM", 
      year = 2012)
  
  edu_cat_b15003_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NY", 
      year = 2012)
  
  edu_cat_b15003_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "NC", 
      year = 2012)
  
  edu_cat_b15003_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "ND", 
      year = 2012)
  
  edu_cat_b15003_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "OH", 
      year = 2012)
  
  edu_cat_b15003_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "OK", 
      year = 2012)
  
  edu_cat_b15003_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "OR", 
      year = 2012)
  
  edu_cat_b15003_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "PA", 
      year = 2012)
  
  edu_cat_b15003_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "RI", 
      year = 2012)
  
  edu_cat_b15003_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "SC", 
      year = 2012)
  
  edu_cat_b15003_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "SD", 
      year = 2012)
  
  edu_cat_b15003_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "TN", 
      year = 2012)
  
  edu_cat_b15003_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "TX", 
      year = 2012)
  
  edu_cat_b15003_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "UT", 
      year = 2012)
  
  edu_cat_b15003_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "VT", 
      year = 2012)
  
  edu_cat_b15003_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "VA", 
      year = 2012)
  
  edu_cat_b15003_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "WA", 
      year = 2012)
  
  edu_cat_b15003_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "WV", 
      year = 2012)
  
  edu_cat_b15003_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "WI", 
      year = 2012)
  
  edu_cat_b15003_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "WY", 
      year = 2012)
  
  edu_cat_b15003_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = edu_cat_b15003, 
      state = "DC", 
      year = 2012)
  
  edu_cat_b15003_tibble <- 
    bind_rows(edu_cat_b15003_list)
  
  save(
    edu_cat_b15003_list, 
    file = 
      file.path(
        "intermediate_data", 
        "edu_cat_b15003_list.rdata"
      )
    )
  
  save(
    edu_cat_b15003_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "edu_cat_b15003_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    edu_cat_b15003_list, 
    edu_cat_b15003_tibble
    )
  gc()
  
}

```


```{r poverty_ratio_cat_c17002 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "poverty_ratio_cat_c17002_tibble.rdata"
      )
    )
  ) {

poverty_ratio_cat_c17002_list <- 
  list()

  # pull the actual data
  poverty_ratio_cat_c17002_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "AL", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "AK", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "AZ", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "AR", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "CA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "CO", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "CT", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "DE", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "FL", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "GA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "HI", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "ID", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "IL", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "IN", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "IA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "KS", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "KY", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "LA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "ME", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MD", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MI", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MN", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MS", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MO", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "MT", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NE", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NV", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NH", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NJ", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NM", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NY", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "NC", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "ND", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "OH", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "OK", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "OR", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "PA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "RI", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "SC", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "SD", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "TN", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "TX", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "UT", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "VT", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "VA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "WA", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "WV", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "WI", 
      year = 2012)
  
  poverty_ratio_cat_c17002_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "WY", 
      year = 2012)
  
    poverty_ratio_cat_c17002_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = poverty_ratio_cat_c17002, 
      state = "DC", 
      year = 2012)
  
  poverty_ratio_cat_c17002_tibble <- 
    bind_rows(poverty_ratio_cat_c17002_list)
  
  save(
    poverty_ratio_cat_c17002_list, 
    file = 
      file.path(
        "intermediate_data", 
        "poverty_ratio_cat_c17002_list.rdata"
      )
    )
  
  save(
    poverty_ratio_cat_c17002_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "poverty_ratio_cat_c17002_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    poverty_ratio_cat_c17002_list, 
    poverty_ratio_cat_c17002_tibble
    )
  gc()
}

```


```{r income_house_cat_b19001 download, eval=FALSE, include=FALSE}


# if(
#   !file.exists(  # checks if tibble already exists
#     file.path(
#       "intermediate_data",
#       "income_house_cat_b19001_tibble.rdata"
#       )
#     )
#   ) {
# 
# income_house_cat_b19001_list <- 
#   list()

  # pull the actual data
  income_house_cat_b19001_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "AL", 
      year = 2012)
  
  income_house_cat_b19001_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "AK", 
      year = 2012)
  
  income_house_cat_b19001_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "AZ", 
      year = 2012)
  
  income_house_cat_b19001_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "AR", 
      year = 2012)
  
  income_house_cat_b19001_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "CA", 
      year = 2012)
  
  income_house_cat_b19001_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "CO", 
      year = 2012)
  
  income_house_cat_b19001_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "CT", 
      year = 2012)
  
  income_house_cat_b19001_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "DE", 
      year = 2012)
  
  income_house_cat_b19001_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "FL", 
      year = 2012)
  
  income_house_cat_b19001_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "GA", 
      year = 2012)
  
  income_house_cat_b19001_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "HI", 
      year = 2012)
  
  income_house_cat_b19001_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "ID", 
      year = 2012)
  
  income_house_cat_b19001_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "IL", 
      year = 2012)
  
  income_house_cat_b19001_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "IN", 
      year = 2012)
  
  income_house_cat_b19001_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "IA", 
      year = 2012)
  
  income_house_cat_b19001_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "KS", 
      year = 2012)
  
  income_house_cat_b19001_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "KY", 
      year = 2012)
  
  income_house_cat_b19001_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "LA", 
      year = 2012)
  
  income_house_cat_b19001_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "ME", 
      year = 2012)
  
  income_house_cat_b19001_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MD", 
      year = 2012)
  
  income_house_cat_b19001_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MA", 
      year = 2012)
  
  income_house_cat_b19001_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MI", 
      year = 2012)
  
  income_house_cat_b19001_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MN", 
      year = 2012)
  
  income_house_cat_b19001_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MS", 
      year = 2012)
  
  income_house_cat_b19001_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MO", 
      year = 2012)
  
  income_house_cat_b19001_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "MT", 
      year = 2012)
  
  income_house_cat_b19001_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NE", 
      year = 2012)
  
  income_house_cat_b19001_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NV", 
      year = 2012)
  
  income_house_cat_b19001_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NH", 
      year = 2012)
  
  income_house_cat_b19001_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NJ", 
      year = 2012)
  
  income_house_cat_b19001_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NM", 
      year = 2012)
  
  income_house_cat_b19001_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NY", 
      year = 2012)
  
  income_house_cat_b19001_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "NC", 
      year = 2012)
  
  income_house_cat_b19001_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "ND", 
      year = 2012)
  
  income_house_cat_b19001_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "OH", 
      year = 2012)
  
  income_house_cat_b19001_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "OK", 
      year = 2012)
  
  income_house_cat_b19001_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "OR", 
      year = 2012)
  
  income_house_cat_b19001_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "PA", 
      year = 2012)
  
  income_house_cat_b19001_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "RI", 
      year = 2012)
  
  income_house_cat_b19001_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "SC", 
      year = 2012)
  
  income_house_cat_b19001_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "SD", 
      year = 2012)
  
  income_house_cat_b19001_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "TN", 
      year = 2012)
  
  income_house_cat_b19001_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "TX", 
      year = 2012)
  
  income_house_cat_b19001_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "UT", 
      year = 2012)
  
  income_house_cat_b19001_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "VT", 
      year = 2012)
  
  income_house_cat_b19001_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "VA", 
      year = 2012)
  
  income_house_cat_b19001_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "WA", 
      year = 2012)
  
  income_house_cat_b19001_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "WV", 
      year = 2012)
  
  income_house_cat_b19001_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "WI", 
      year = 2012)
  
  income_house_cat_b19001_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "WY", 
      year = 2012)
  
  income_house_cat_b19001_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_cat_b19001, 
      state = "DC", 
      year = 2012)
  
  income_house_cat_b19001_tibble <- 
    bind_rows(income_house_cat_b19001_list)
  
  save(
    income_house_cat_b19001_list, 
    file = 
      file.path(
        "intermediate_data", 
        "income_house_cat_b19001_list.rdata"
      )
    )
  
  save(
    income_house_cat_b19001_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "income_house_cat_b19001_tibble.rdata"
      )
    )
  
#   # remove the generated files
#   rm(
#     income_house_cat_b19001_list, 
#     income_house_cat_b19001_tibble
#     )
#   gc()
# }

```


```{r income_house_median_b19013 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path( 
      "intermediate_data",
      "income_house_median_b19013_tibble.rdata"
      )
    )
  ) {

income_house_median_b19013_list <- 
  list()

  # pull the actual data
  income_house_median_b19013_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "AL", 
      year = 2012)
  
  income_house_median_b19013_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "AK", 
      year = 2012)
  
  income_house_median_b19013_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "AZ", 
      year = 2012)
  
  income_house_median_b19013_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "AR", 
      year = 2012)
  
  income_house_median_b19013_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "CA", 
      year = 2012)
  
  income_house_median_b19013_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "CO", 
      year = 2012)
  
  income_house_median_b19013_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "CT", 
      year = 2012)
  
  income_house_median_b19013_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "DE", 
      year = 2012)
  
  income_house_median_b19013_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "FL", 
      year = 2012)
  
  income_house_median_b19013_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "GA", 
      year = 2012)
  
  income_house_median_b19013_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "HI", 
      year = 2012)
  
  income_house_median_b19013_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "ID", 
      year = 2012)
  
  income_house_median_b19013_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "IL", 
      year = 2012)
  
  income_house_median_b19013_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "IN", 
      year = 2012)
  
  income_house_median_b19013_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "IA", 
      year = 2012)
  
  income_house_median_b19013_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "KS", 
      year = 2012)
  
  income_house_median_b19013_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "KY", 
      year = 2012)
  
  income_house_median_b19013_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "LA", 
      year = 2012)
  
  income_house_median_b19013_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "ME", 
      year = 2012)
  
  income_house_median_b19013_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MD", 
      year = 2012)
  
  income_house_median_b19013_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MA", 
      year = 2012)
  
  income_house_median_b19013_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MI", 
      year = 2012)
  
  income_house_median_b19013_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MN", 
      year = 2012)
  
  income_house_median_b19013_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MS", 
      year = 2012)
  
  income_house_median_b19013_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MO", 
      year = 2012)
  
  income_house_median_b19013_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "MT", 
      year = 2012)
  
  income_house_median_b19013_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NE", 
      year = 2012)
  
  income_house_median_b19013_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NV", 
      year = 2012)
  
  income_house_median_b19013_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NH", 
      year = 2012)
  
  income_house_median_b19013_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NJ", 
      year = 2012)
  
  income_house_median_b19013_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NM", 
      year = 2012)
  
  income_house_median_b19013_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NY", 
      year = 2012)
  
  income_house_median_b19013_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "NC", 
      year = 2012)
  
  income_house_median_b19013_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "ND", 
      year = 2012)
  
  income_house_median_b19013_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "OH", 
      year = 2012)
  
  income_house_median_b19013_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "OK", 
      year = 2012)
  
  income_house_median_b19013_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "OR", 
      year = 2012)
  
  income_house_median_b19013_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "PA", 
      year = 2012)
  
  income_house_median_b19013_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "RI", 
      year = 2012)
  
  income_house_median_b19013_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "SC", 
      year = 2012)
  
  income_house_median_b19013_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "SD", 
      year = 2012)
  
  income_house_median_b19013_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "TN", 
      year = 2012)
  
  income_house_median_b19013_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "TX", 
      year = 2012)
  
  income_house_median_b19013_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "UT", 
      year = 2012)
  
  income_house_median_b19013_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "VT", 
      year = 2012)
  
  income_house_median_b19013_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "VA", 
      year = 2012)
  
  income_house_median_b19013_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "WA", 
      year = 2012)
  
  income_house_median_b19013_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "WV", 
      year = 2012)
  
  income_house_median_b19013_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "WI", 
      year = 2012)
  
  income_house_median_b19013_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "WY", 
      year = 2012)
  
  income_house_median_b19013_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = income_house_median_b19013, 
      state = "DC", 
      year = 2012)
  
  income_house_median_b19013_tibble <- 
    bind_rows(income_house_median_b19013_list)
  
  save(
    income_house_median_b19013_list, 
    file = 
      file.path(
        "intermediate_data", 
        "income_house_median_b19013_list.rdata"
      )
    )
  
  save(
    income_house_median_b19013_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "income_house_median_b19013_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    income_house_median_b19013_list, 
    income_house_median_b19013_tibble
    )
  gc()
}

```


```{r earnings_sex_cat_b20001 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "earnings_sex_cat_b20001_tibble.rdata"
      )
    )
  ) {

earnings_sex_cat_b20001_list <- 
  list()

  # pull the actual data
  earnings_sex_cat_b20001_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "AL", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "AK", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "AZ", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "AR", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "CA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "CO", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "CT", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "DE", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "FL", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "GA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "HI", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "ID", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "IL", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "IN", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "IA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "KS", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "KY", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "LA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "ME", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MD", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MI", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MN", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MS", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MO", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "MT", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NE", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NV", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NH", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NJ", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NM", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NY", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "NC", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "ND", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "OH", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "OK", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "OR", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "PA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "RI", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "SC", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "SD", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "TN", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "TX", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "UT", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "VT", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "VA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "WA", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "WV", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "WI", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "WY", 
      year = 2012)
  
  earnings_sex_cat_b20001_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_sex_cat_b20001, 
      state = "DC", 
      year = 2012)
  
  earnings_sex_cat_b20001_tibble <- 
    bind_rows(earnings_sex_cat_b20001_list)
  
  save(
    earnings_sex_cat_b20001_list, 
    file = 
      file.path(
        "intermediate_data", 
        "earnings_sex_cat_b20001_list.rdata"
      )
    )
  
  save(
    earnings_sex_cat_b20001_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "earnings_sex_cat_b20001_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    earnings_sex_cat_b20001_list, 
    earnings_sex_cat_b20001_tibble
    )
  gc()
}

```


```{r earnings_median_b20002 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "earnings_median_b20002_tibble.rdata"
      )
    )
  ) {

earnings_median_b20002_list <- 
  list()

  # pull the actual data
  earnings_median_b20002_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "AL", 
      year = 2012)
  
  earnings_median_b20002_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "AK", 
      year = 2012)
  
  earnings_median_b20002_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "AZ", 
      year = 2012)
  
  earnings_median_b20002_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "AR", 
      year = 2012)
  
  earnings_median_b20002_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "CA", 
      year = 2012)
  
  earnings_median_b20002_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "CO", 
      year = 2012)
  
  earnings_median_b20002_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "CT", 
      year = 2012)
  
  earnings_median_b20002_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "DE", 
      year = 2012)
  
  earnings_median_b20002_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "FL", 
      year = 2012)
  
  earnings_median_b20002_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "GA", 
      year = 2012)
  
  earnings_median_b20002_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "HI", 
      year = 2012)
  
  earnings_median_b20002_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "ID", 
      year = 2012)
  
  earnings_median_b20002_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "IL", 
      year = 2012)
  
  earnings_median_b20002_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "IN", 
      year = 2012)
  
  earnings_median_b20002_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "IA", 
      year = 2012)
  
  earnings_median_b20002_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "KS", 
      year = 2012)
  
  earnings_median_b20002_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "KY", 
      year = 2012)
  
  earnings_median_b20002_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "LA", 
      year = 2012)
  
  earnings_median_b20002_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "ME", 
      year = 2012)
  
  earnings_median_b20002_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MD", 
      year = 2012)
  
  earnings_median_b20002_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MA", 
      year = 2012)
  
  earnings_median_b20002_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MI", 
      year = 2012)
  
  earnings_median_b20002_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MN", 
      year = 2012)
  
  earnings_median_b20002_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MS", 
      year = 2012)
  
  earnings_median_b20002_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MO", 
      year = 2012)
  
  earnings_median_b20002_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "MT", 
      year = 2012)
  
  earnings_median_b20002_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NE", 
      year = 2012)
  
  earnings_median_b20002_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NV", 
      year = 2012)
  
  earnings_median_b20002_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NH", 
      year = 2012)
  
  earnings_median_b20002_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NJ", 
      year = 2012)
  
  earnings_median_b20002_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NM", 
      year = 2012)
  
  earnings_median_b20002_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NY", 
      year = 2012)
  
  earnings_median_b20002_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "NC", 
      year = 2012)
  
  earnings_median_b20002_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "ND", 
      year = 2012)
  
  earnings_median_b20002_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "OH", 
      year = 2012)
  
  earnings_median_b20002_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "OK", 
      year = 2012)
  
  earnings_median_b20002_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "OR", 
      year = 2012)
  
  earnings_median_b20002_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "PA", 
      year = 2012)
  
  earnings_median_b20002_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "RI", 
      year = 2012)
  
  earnings_median_b20002_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "SC", 
      year = 2012)
  
  earnings_median_b20002_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "SD", 
      year = 2012)
  
  earnings_median_b20002_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "TN", 
      year = 2012)
  
  earnings_median_b20002_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "TX", 
      year = 2012)
  
  earnings_median_b20002_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "UT", 
      year = 2012)
  
  earnings_median_b20002_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "VT", 
      year = 2012)
  
  earnings_median_b20002_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "VA", 
      year = 2012)
  
  earnings_median_b20002_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "WA", 
      year = 2012)
  
  earnings_median_b20002_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "WV", 
      year = 2012)
  
  earnings_median_b20002_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "WI", 
      year = 2012)
  
  earnings_median_b20002_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "WY", 
      year = 2012)
  
  earnings_median_b20002_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = earnings_median_b20002, 
      state = "DC", 
      year = 2012)
  
  earnings_median_b20002_tibble <- 
    bind_rows(earnings_median_b20002_list)
  
  save(
    earnings_median_b20002_list, 
    file = 
      file.path(
        "intermediate_data", 
        "earnings_median_b20002_list.rdata"
      )
    )
  
  save(
    earnings_median_b20002_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "earnings_median_b20002_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    earnings_median_b20002_list, 
    earnings_median_b20002_tibble
    )
  gc()
}

```


```{r employment_cat_b23025 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "employment_cat_b23025_tibble.rdata"
      )
    )
  ) {

employment_cat_b23025_list <- 
  list()

  # pull the actual data
  employment_cat_b23025_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "AL", 
      year = 2012)
  
  employment_cat_b23025_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "AK", 
      year = 2012)
  
  employment_cat_b23025_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "AZ", 
      year = 2012)
  
  employment_cat_b23025_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "AR", 
      year = 2012)
  
  employment_cat_b23025_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "CA", 
      year = 2012)
  
  employment_cat_b23025_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "CO", 
      year = 2012)
  
  employment_cat_b23025_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "CT", 
      year = 2012)
  
  employment_cat_b23025_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "DE", 
      year = 2012)
  
  employment_cat_b23025_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "FL", 
      year = 2012)
  
  employment_cat_b23025_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "GA", 
      year = 2012)
  
  employment_cat_b23025_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "HI", 
      year = 2012)
  
  employment_cat_b23025_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "ID", 
      year = 2012)
  
  employment_cat_b23025_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "IL", 
      year = 2012)
  
  employment_cat_b23025_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "IN", 
      year = 2012)
  
  employment_cat_b23025_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "IA", 
      year = 2012)
  
  employment_cat_b23025_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "KS", 
      year = 2012)
  
  employment_cat_b23025_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "KY", 
      year = 2012)
  
  employment_cat_b23025_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "LA", 
      year = 2012)
  
  employment_cat_b23025_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "ME", 
      year = 2012)
  
  employment_cat_b23025_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MD", 
      year = 2012)
  
  employment_cat_b23025_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MA", 
      year = 2012)
  
  employment_cat_b23025_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MI", 
      year = 2012)
  
  employment_cat_b23025_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MN", 
      year = 2012)
  
  employment_cat_b23025_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MS", 
      year = 2012)
  
  employment_cat_b23025_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MO", 
      year = 2012)
  
  employment_cat_b23025_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "MT", 
      year = 2012)
  
  employment_cat_b23025_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NE", 
      year = 2012)
  
  employment_cat_b23025_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NV", 
      year = 2012)
  
  employment_cat_b23025_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NH", 
      year = 2012)
  
  employment_cat_b23025_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NJ", 
      year = 2012)
  
  employment_cat_b23025_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NM", 
      year = 2012)
  
  employment_cat_b23025_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NY", 
      year = 2012)
  
  employment_cat_b23025_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "NC", 
      year = 2012)
  
  employment_cat_b23025_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "ND", 
      year = 2012)
  
  employment_cat_b23025_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "OH", 
      year = 2012)
  
  employment_cat_b23025_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "OK", 
      year = 2012)
  
  employment_cat_b23025_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "OR", 
      year = 2012)
  
  employment_cat_b23025_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "PA", 
      year = 2012)
  
  employment_cat_b23025_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "RI", 
      year = 2012)
  
  employment_cat_b23025_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "SC", 
      year = 2012)
  
  employment_cat_b23025_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "SD", 
      year = 2012)
  
  employment_cat_b23025_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "TN", 
      year = 2012)
  
  employment_cat_b23025_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "TX", 
      year = 2012)
  
  employment_cat_b23025_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "UT", 
      year = 2012)
  
  employment_cat_b23025_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "VT", 
      year = 2012)
  
  employment_cat_b23025_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "VA", 
      year = 2012)
  
  employment_cat_b23025_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "WA", 
      year = 2012)
  
  employment_cat_b23025_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "WV", 
      year = 2012)
  
  employment_cat_b23025_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "WI", 
      year = 2012)
  
  employment_cat_b23025_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "WY", 
      year = 2012)
  
  employment_cat_b23025_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = employment_cat_b23025, 
      state = "DC", 
      year = 2012)
  
  employment_cat_b23025_tibble <- 
    bind_rows(employment_cat_b23025_list)
  
  save(
    employment_cat_b23025_list, 
    file = 
      file.path(
        "intermediate_data", 
        "employment_cat_b23025_list.rdata"
      )
    )
  
  save(
    employment_cat_b23025_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "employment_cat_b23025_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    employment_cat_b23025_list, 
    employment_cat_b23025_tibble
    )
  gc()
}

```


```{r home_value_cat_b25075 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "home_value_cat_b25075_tibble.rdata"
      )
    )
  ) {

home_value_cat_b25075_list <- 
  list()

  # pull the actual data
  home_value_cat_b25075_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "AL", 
      year = 2012)
  
  home_value_cat_b25075_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "AK", 
      year = 2012)
  
  home_value_cat_b25075_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "AZ", 
      year = 2012)
  
  home_value_cat_b25075_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "AR", 
      year = 2012)
  
  home_value_cat_b25075_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "CA", 
      year = 2012)
  
  home_value_cat_b25075_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "CO", 
      year = 2012)
  
  home_value_cat_b25075_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "CT", 
      year = 2012)
  
  home_value_cat_b25075_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "DE", 
      year = 2012)
  
  home_value_cat_b25075_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "FL", 
      year = 2012)
  
  home_value_cat_b25075_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "GA", 
      year = 2012)
  
  home_value_cat_b25075_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "HI", 
      year = 2012)
  
  home_value_cat_b25075_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "ID", 
      year = 2012)
  
  home_value_cat_b25075_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "IL", 
      year = 2012)
  
  home_value_cat_b25075_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "IN", 
      year = 2012)
  
  home_value_cat_b25075_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "IA", 
      year = 2012)
  
  home_value_cat_b25075_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "KS", 
      year = 2012)
  
  home_value_cat_b25075_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "KY", 
      year = 2012)
  
  home_value_cat_b25075_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "LA", 
      year = 2012)
  
  home_value_cat_b25075_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "ME", 
      year = 2012)
  
  home_value_cat_b25075_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MD", 
      year = 2012)
  
  home_value_cat_b25075_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MA", 
      year = 2012)
  
  home_value_cat_b25075_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MI", 
      year = 2012)
  
  home_value_cat_b25075_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MN", 
      year = 2012)
  
  home_value_cat_b25075_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MS", 
      year = 2012)
  
  home_value_cat_b25075_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MO", 
      year = 2012)
  
  home_value_cat_b25075_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "MT", 
      year = 2012)
  
  home_value_cat_b25075_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NE", 
      year = 2012)
  
  home_value_cat_b25075_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NV", 
      year = 2012)
  
  home_value_cat_b25075_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NH", 
      year = 2012)
  
  home_value_cat_b25075_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NJ", 
      year = 2012)
  
  home_value_cat_b25075_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NM", 
      year = 2012)
  
  home_value_cat_b25075_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NY", 
      year = 2012)
  
  home_value_cat_b25075_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "NC", 
      year = 2012)
  
  home_value_cat_b25075_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "ND", 
      year = 2012)
  
  home_value_cat_b25075_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "OH", 
      year = 2012)
  
  home_value_cat_b25075_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "OK", 
      year = 2012)
  
  home_value_cat_b25075_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "OR", 
      year = 2012)
  
  home_value_cat_b25075_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "PA", 
      year = 2012)
  
  home_value_cat_b25075_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "RI", 
      year = 2012)
  
  home_value_cat_b25075_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "SC", 
      year = 2012)
  
  home_value_cat_b25075_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "SD", 
      year = 2012)
  
  home_value_cat_b25075_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "TN", 
      year = 2012)
  
  home_value_cat_b25075_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "TX", 
      year = 2012)
  
  home_value_cat_b25075_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "UT", 
      year = 2012)
  
  home_value_cat_b25075_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "VT", 
      year = 2012)
  
  home_value_cat_b25075_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "VA", 
      year = 2012)
  
  home_value_cat_b25075_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "WA", 
      year = 2012)
  
  home_value_cat_b25075_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "WV", 
      year = 2012)
  
  home_value_cat_b25075_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "WI", 
      year = 2012)
  
  home_value_cat_b25075_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "WY", 
      year = 2012)
  
  home_value_cat_b25075_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_cat_b25075, 
      state = "DC", 
      year = 2012)
  
  home_value_cat_b25075_tibble <- 
    bind_rows(home_value_cat_b25075_list)
  
  save(
    home_value_cat_b25075_list, 
    file = 
      file.path(
        "intermediate_data", 
        "home_value_cat_b25075_list.rdata"
      )
    )
  
  save(
    home_value_cat_b25075_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "home_value_cat_b25075_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    home_value_cat_b25075_list, 
    home_value_cat_b25075_tibble
    )
  gc()
}

```


```{r home_value_median_b25077 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "home_value_median_b25077_tibble.rdata"
      )
    )
  ) {

home_value_median_b25077_list <- 
  list()

  # pull the actual data
  home_value_median_b25077_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "AL", 
      year = 2012)
  
  home_value_median_b25077_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "AK", 
      year = 2012)
  
  home_value_median_b25077_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "AZ", 
      year = 2012)
  
  home_value_median_b25077_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "AR", 
      year = 2012)
  
  home_value_median_b25077_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "CA", 
      year = 2012)
  
  home_value_median_b25077_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "CO", 
      year = 2012)
  
  home_value_median_b25077_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "CT", 
      year = 2012)
  
  home_value_median_b25077_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "DE", 
      year = 2012)
  
  home_value_median_b25077_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "FL", 
      year = 2012)
  
  home_value_median_b25077_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "GA", 
      year = 2012)
  
  home_value_median_b25077_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "HI", 
      year = 2012)
  
  home_value_median_b25077_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "ID", 
      year = 2012)
  
  home_value_median_b25077_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "IL", 
      year = 2012)
  
  home_value_median_b25077_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "IN", 
      year = 2012)
  
  home_value_median_b25077_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "IA", 
      year = 2012)
  
  home_value_median_b25077_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "KS", 
      year = 2012)
  
  home_value_median_b25077_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "KY", 
      year = 2012)
  
  home_value_median_b25077_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "LA", 
      year = 2012)
  
  home_value_median_b25077_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "ME", 
      year = 2012)
  
  home_value_median_b25077_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MD", 
      year = 2012)
  
  home_value_median_b25077_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MA", 
      year = 2012)
  
  home_value_median_b25077_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MI", 
      year = 2012)
  
  home_value_median_b25077_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MN", 
      year = 2012)
  
  home_value_median_b25077_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MS", 
      year = 2012)
  
  home_value_median_b25077_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MO", 
      year = 2012)
  
  home_value_median_b25077_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "MT", 
      year = 2012)
  
  home_value_median_b25077_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NE", 
      year = 2012)
  
  home_value_median_b25077_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NV", 
      year = 2012)
  
  home_value_median_b25077_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NH", 
      year = 2012)
  
  home_value_median_b25077_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NJ", 
      year = 2012)
  
  home_value_median_b25077_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NM", 
      year = 2012)
  
  home_value_median_b25077_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NY", 
      year = 2012)
  
  home_value_median_b25077_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "NC", 
      year = 2012)
  
  home_value_median_b25077_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "ND", 
      year = 2012)
  
  home_value_median_b25077_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "OH", 
      year = 2012)
  
  home_value_median_b25077_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "OK", 
      year = 2012)
  
  home_value_median_b25077_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "OR", 
      year = 2012)
  
  home_value_median_b25077_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "PA", 
      year = 2012)
  
  home_value_median_b25077_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "RI", 
      year = 2012)
  
  home_value_median_b25077_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "SC", 
      year = 2012)
  
  home_value_median_b25077_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "SD", 
      year = 2012)
  
  home_value_median_b25077_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "TN", 
      year = 2012)
  
  home_value_median_b25077_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "TX", 
      year = 2012)
  
  home_value_median_b25077_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "UT", 
      year = 2012)
  
  home_value_median_b25077_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "VT", 
      year = 2012)
  
  home_value_median_b25077_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "VA", 
      year = 2012)
  
  home_value_median_b25077_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "WA", 
      year = 2012)
  
  home_value_median_b25077_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "WV", 
      year = 2012)
  
  home_value_median_b25077_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "WI", 
      year = 2012)
  
  home_value_median_b25077_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "WY", 
      year = 2012)
  
  home_value_median_b25077_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = home_value_median_b25077, 
      state = "DC", 
      year = 2012)
  
  home_value_median_b25077_tibble <- 
    bind_rows(home_value_median_b25077_list)
  
  save(
    home_value_median_b25077_list, 
    file = 
      file.path(
        "intermediate_data", 
        "home_value_median_b25077_list.rdata"
      )
    )
  
  save(
    home_value_median_b25077_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "home_value_median_b25077_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    home_value_median_b25077_list, 
    home_value_median_b25077_tibble
    )
  gc()
}

```


```{r health_insurance_cat_c27010 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "health_insurance_cat_c27010_tibble.rdata"
      )
    )
  ) {

health_insurance_cat_c27010_list <- 
  list()

  # pull the actual data
  health_insurance_cat_c27010_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "AL", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "AK", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "AZ", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "AR", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "CA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "CO", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "CT", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "DE", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "FL", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "GA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "HI", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "ID", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "IL", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "IN", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "IA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "KS", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "KY", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "LA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "ME", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MD", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MI", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MN", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MS", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MO", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "MT", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NE", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NV", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NH", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NJ", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NM", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NY", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "NC", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "ND", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "OH", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "OK", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "OR", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "PA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "RI", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "SC", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "SD", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "TN", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "TX", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "UT", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "VT", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "VA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "WA", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "WV", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "WI", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "WY", 
      year = 2012)
  
  health_insurance_cat_c27010_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = health_insurance_cat_c27010, 
      state = "DC", 
      year = 2012)
  
  health_insurance_cat_c27010_tibble <- 
    bind_rows(health_insurance_cat_c27010_list)
  
  save(
    health_insurance_cat_c27010_list, 
    file = 
      file.path(
        "intermediate_data", 
        "health_insurance_cat_c27010_list.rdata"
      )
    )
  
  save(
    health_insurance_cat_c27010_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "health_insurance_cat_c27010_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    health_insurance_cat_c27010_list, 
    health_insurance_cat_c27010_tibble
    )
  gc()
}

```


```{r ling_iso_b16002 download, eval=FALSE, include=FALSE}


if(
  !file.exists(  # checks if tibble already exists
    file.path(
      "intermediate_data",
      "ling_iso_b16002_tibble.rdata"
      )
    )
  ) {

ling_iso_b16002_list <- 
  list()

  # pull the actual data
  ling_iso_b16002_list[["AL"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "AL", 
      year = 2012)
  
  ling_iso_b16002_list[["AK"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "AK", 
      year = 2012)
  
  ling_iso_b16002_list[["AZ"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "AZ", 
      year = 2012)
  
  ling_iso_b16002_list[["AR"]] <- 
      get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "AR", 
      year = 2012)
  
  ling_iso_b16002_list[["CA"]] <- 
      get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "CA", 
      year = 2012)
  
  ling_iso_b16002_list[["CO"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "CO", 
      year = 2012)
  
  ling_iso_b16002_list[["CT"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "CT", 
      year = 2012)
  
  ling_iso_b16002_list[["DE"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "DE", 
      year = 2012)
  
  ling_iso_b16002_list[["FL"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "FL", 
      year = 2012)
  
  ling_iso_b16002_list[["GA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "GA", 
      year = 2012)
  
  ling_iso_b16002_list[["HI"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "HI", 
      year = 2012)
  
  ling_iso_b16002_list[["ID"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "ID", 
      year = 2012)
  
  ling_iso_b16002_list[["IL"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "IL", 
      year = 2012)
  
  ling_iso_b16002_list[["IN"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "IN", 
      year = 2012)
  
  ling_iso_b16002_list[["IA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "IA", 
      year = 2012)
  
  ling_iso_b16002_list[["KS"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "KS", 
      year = 2012)
  
  ling_iso_b16002_list[["KY"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "KY", 
      year = 2012)
  
  ling_iso_b16002_list[["LA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "LA", 
      year = 2012)
  
  ling_iso_b16002_list[["ME"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "ME", 
      year = 2012)
  
  ling_iso_b16002_list[["MD"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MD", 
      year = 2012)
  
  ling_iso_b16002_list[["MA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MA", 
      year = 2012)
  
  ling_iso_b16002_list[["MI"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MI", 
      year = 2012)
  
  ling_iso_b16002_list[["MN"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MN", 
      year = 2012)
  
  ling_iso_b16002_list[["MS"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MS", 
      year = 2012)
  
  ling_iso_b16002_list[["MO"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MO", 
      year = 2012)
  
  ling_iso_b16002_list[["MT"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "MT", 
      year = 2012)
  
  ling_iso_b16002_list[["NE"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NE", 
      year = 2012)
  
  ling_iso_b16002_list[["NV"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NV", 
      year = 2012)
  
  ling_iso_b16002_list[["NH"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NH", 
      year = 2012)
  
  ling_iso_b16002_list[["NJ"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NJ", 
      year = 2012)
  
  ling_iso_b16002_list[["NM"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NM", 
      year = 2012)
  
  ling_iso_b16002_list[["NY"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NY", 
      year = 2012)
  
  ling_iso_b16002_list[["NC"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "NC", 
      year = 2012)
  
  ling_iso_b16002_list[["ND"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "ND", 
      year = 2012)
  
  ling_iso_b16002_list[["OH"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "OH", 
      year = 2012)
  
  ling_iso_b16002_list[["OK"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "OK", 
      year = 2012)
  
  ling_iso_b16002_list[["OR"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "OR", 
      year = 2012)
  
  ling_iso_b16002_list[["PA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "PA", 
      year = 2012)
  
  ling_iso_b16002_list[["RI"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "RI", 
      year = 2012)
  
  ling_iso_b16002_list[["SC"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "SC", 
      year = 2012)
  
  ling_iso_b16002_list[["SD"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "SD", 
      year = 2012)
  
  ling_iso_b16002_list[["TN"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "TN", 
      year = 2012)
  
  ling_iso_b16002_list[["TX"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "TX", 
      year = 2012)
  
  ling_iso_b16002_list[["UT"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "UT", 
      year = 2012)
  
  ling_iso_b16002_list[["VT"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "VT", 
      year = 2012)
  
  ling_iso_b16002_list[["VA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "VA", 
      year = 2012)
  
  ling_iso_b16002_list[["WA"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "WA", 
      year = 2012)
  
  ling_iso_b16002_list[["WV"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "WV", 
      year = 2012)
  
  ling_iso_b16002_list[["WI"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "WI", 
      year = 2012)
  
  ling_iso_b16002_list[["WY"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "WY", 
      year = 2012)
  
  ling_iso_b16002_list[["DC"]] <- 
    get_acs(
      geography = "tract", 
      variables = ling_iso_b16002, 
      state = "DC", 
      year = 2012)
  
  ling_iso_b16002_tibble <- 
    bind_rows(ling_iso_b16002_list)
  
  save(
    ling_iso_b16002_list, 
    file = 
      file.path(
        "intermediate_data", 
        "ling_iso_b16002_list.rdata"
      )
    )
  
  save(
    ling_iso_b16002_tibble, 
    file = 
      file.path(
        "intermediate_data", 
        "ling_iso_b16002_tibble.rdata"
      )
    )
  
  # remove the generated files
  rm(
    ling_iso_b16002_list, 
    ling_iso_b16002_tibble
    )
  gc()
}

```


#### acs data from census geodatabase (SKIP!)

```{r acs data from geodatabase download, eval=FALSE, include=FALSE}

if(
  !file.exists(
    file.path(
      "intermediate_data", 
      "acs_data_from_gdb.rdata"
      )
    )
  ) {

#   # make list of files to download
#   acs_gdb_addresses <- 
#     sprintf(
#       "https://www2.census.gov/geo/tiger/TIGER_DP/2012ACS/ACS_2012_5YR_TRACT_%02d.gdb.zip", 
#       setdiff(1:56, 
#               c(3, 7, 14, 43, 52)  # these are not states
#               )
#       )
#   
#     # make a list of filenames for the downloaded data using the above filenames
#   acs_gdb_filenames <-  # make list of what the filenames will be
#     map_chr(acs_gdb_addresses,  # witness the `map` function
#             str_extract, 
#             "ACS_2012_5YR_TRACT_[0-9][0-9].gdb.zip")   # witness the regular expression!
#   
#   # download the files
#   map2(acs_gdb_filenames, 
#        acs_gdb_addresses, 
#        file_downloader, 
#        folder_as_string = "raw_data")
# }

file_downloader(
  desired_filename_as_string = "acs_raw_gdb.zip", 
  web_address_as_string = "https://www2.census.gov/geo/tiger/TIGER_DP/2012ACS/ACS_2012_5YR_TRACT_GIANTTABLE.gdb.zip", 
  folder_as_string = "raw_data"
)
 
  # unzip it to the intermediate file directory
  unzip(
    file.path(
      "raw_data", 
      "acs_raw_gdb.zip"), 
    exdir = "intermediate_data")

  # read the shapefile
  acs_data_from_gdb <- 
    st_read(
      file.path(
        "intermediate_data", 
        "ACS_2012_5YR_TRACT.gdb"
        ), 
      layer = "ACS_2012_5YR_TRACT"
      )
  
  # fix column names
  acs_data_from_gdb <-
    column_name_fixer(
      acs_data_from_gdb
    )


  # save the shapefile
  save(
    acs_data_from_gdb,
    file = file.path(
      "intermediate_data", 
      "acs_data_from_gdb.rdata"
    )
  )

  # remove the shapefile from memory
  rm(acs_data_from_gdb)
  gc()
}
   
```


#### select acs variables from shapefile-derived table (SKIP!)

```{r acs gdb variable lists, eval=FALSE, include=FALSE}

# educational attainment for the population 25 years and over
# universe: population 25 years and over
edu_cat_b15003_gdb_e <- 
  c("B15003e1",  # total
    "B15003e2",  # no schooling completed
    "B15003e3",  # nursery school
    "B15003e4",  # kindergarten
    "B15003e5",  # 1st grade
    "B15003e6",  # 2nd grade
    "B15003e7",  # 3rd grade
    "B15003e8",  # 4th grade
    "B15003e9",  # 5th grade
    "B15003e10",  # 6th grade
    "B15003e11",  # 7th grade
    "B15003e12",  # 8th grade
    "B15003e13",  # 9th grade
    "B15003e14",  # 10th grade
    "B15003e15",  # 11th grade
    "B15003e16",  # 12th grade
    "B15003e17",  # regular high school diploma
    "B15003e18",  # GED or alternative credential
    "B15003e19",  # some college, less than 1 year
    "B15003e20",  # some college, 1 or more years, no degree
    "B15003e21",  # associate's degree
    "B15003e22",  # bachelor's degree
    "B15003e23",  # master's degree
    "B15003e24",  # professional school degree
    "B15003e25")  # doctorate degree

edu_cat_b15003_gdb_m <- 
  str_replace(
    edu_cat_b15003_gdb_e, 
    "e", 
    "m"
  )

# ratio of income to poverty level in the past 12 months
# universe: population for whom poverty status is determined
poverty_ratio_cat_c17002_gdb_e <-
  c("C17002e1",  # total
    "C17002e2",  # under .50
    "C17002e3",  # .50 to .99
    "C17002e4",  # 1.00 to 1.24
    "C17002e5",  # 1.25 to 1.49
    "C17002e6",  # 1.50 to 1.84
    "C17002e7",  # 1.85 to 1.99
    "C17002e8")  # 2.00 and over

poverty_ratio_cat_c17002_gdb_m <- 
  str_replace(
    poverty_ratio_cat_c17002_gdb_e, 
    "e", 
    "m"
  )

# household income in the past 12 months (in 2012 inflation-adjusted dollars)
# universe: households
income_house_cat_b19001_gdb_e <-
  c("B19001e1",  # total
    "B19001e2",  # less than $10,000
    "B19001e3",  # $10,000 to $14,999
    "B19001e4",  # $15,000 to $19,999
    "B19001e5",  # $20,000 to $24,999
    "B19001e6",  # $25,000 to $29,999
    "B19001e7",  # $30,000 to $34,999
    "B19001e8",  # $35,000 to $39,999
    "B19001e9",  # $40,000 to $44,999
    "B19001e10",  # $45,000 to $49,999
    "B19001e11",  # $50,000 to $59,999
    "B19001e12",  # $60,000 to $74,999
    "B19001e13",  # $75,000 to $99,999
    "B19001e14",  # $100,000 to $124,999
    "B19001e15",  # $125,000 to $149,999
    "B19001e16",  # $150,000 to $199,999
    "B19001e17")  # $200,000 or more

income_house_cat_b19001_gdb_m <- 
  str_replace(
    income_house_cat_b19001_gdb_e, 
    "e", 
    "m"
  )

# median household income in the past 12 months (in 2012 inflation-adjusted dollars)
# universe: households
income_house_median_b19013_gdb_e <-
  c("B19013e1")

income_house_median_b19013_gdb_m <- 
  str_replace(
    income_house_median_b19013_gdb_e, 
    "e", 
    "m"
  )

# sex by earnings in the past 12 months (in 2012 inflation-adjusted dollars) for the population 16 years and over with earnings in the past 12 months
# universe: population 16 years and over with earnings
earnings_sex_cat_b20001_gdb_e <-
  c("B20001e1",  # total
    "B20001e2",  # male
    "B20001e3",  # $1 to $2,499 or loss
    "B20001e4",  # $2,500 to $4,999
    "B20001e5",  # $5,000 to $7,499
    "B20001e6",  # $7,500 to $9,999
    "B20001e7",  # $10,000 to $12,499
    "B20001e8",  # $12,500 to $14,999
    "B20001e9",  # $15,000 to $17,499
    "B20001e10",  # $17,500 to $19,999
    "B20001e11",  # $20,000 to $22,499
    "B20001e12",  # $22,500 to $24,999
    "B20001e13",  # $25,000 to $29,999
    "B20001e14",  # $30,000 to $34,999
    "B20001e15",  # $35,000 to $39,999
    "B20001e16",  # $40,000 to $44,999
    "B20001e17",  # $45,000 to $49,999
    "B20001e18",  # $50,000 to $54,999
    "B20001e19",  # $55,000 to $64,999
    "B20001e20",  # $65,000 to $74,999
    "B20001e21",  # $75,000 to $99,999
    "B20001e22",  # $100,000 or more
    "B20001e23",  # Female:
    "B20001e24",  # $1 to $2,499 or loss
    "B20001e25",  # $2,500 to $4,999
    "B20001e26",  # $5,000 to $7,499
    "B20001e27",  # $7,500 to $9,999
    "B20001e28",  # $10,000 to $12,499
    "B20001e29",  # $12,500 to $14,999
    "B20001e30",  # $15,000 to $17,499
    "B20001e31",  # $17,500 to $19,999
    "B20001e32",  # $20,000 to $22,499
    "B20001e33",  # $22,500 to $24,999
    "B20001e34",  # $25,000 to $29,999
    "B20001e35",  # $30,000 to $34,999
    "B20001e36",  # $35,000 to $39,999
    "B20001e37",  # $40,000 to $44,999
    "B20001e38",  # $45,000 to $49,999
    "B20001e39",  # $50,000 to $54,999
    "B20001e40",  # $55,000 to $64,999
    "B20001e41",  # $65,000 to $74,999
    "B20001e42",  # $75,000 to $99,999
    "B20001e43")  # $100,000 or more

earnings_sex_cat_b20001_gdb_m <- 
  str_replace(
    earnings_sex_cat_b20001_gdb_e, 
    "e", 
    "m"
  )

# median earnings in the past 12 months (in 2012 inflation-adjusted dollars) by sex for the population 16 years and over with earnings in the past 12 months
# universe: population 16 years and over with earnings
earnings_median_b20002_gdb_e <-
  c("B20002e1",  # total
    "B20002e2",  # male
    "B20002e3")  # female

earnings_median_b20002_gdb_m <- 
  str_replace(
    earnings_median_b20002_gdb_e, 
    "e", 
    "m"
  )

# employment status for the population 16 years and over
# universe: population 16 years and over
employment_cat_b23025_gdb_e <-  # divide 5 by 3
  c("B23025e1",  # total
    "B23025e2",    # in labor force
    "B23025e3",      # civilian labor force
    "B23025e4",        # employed
    "B23025e5",        # unemployed
    "B23025e6",      # armed forces
    "B23025e7")    # not in labor force

employment_cat_b23025_gdb_m <- 
  str_replace(
    employment_cat_b23025_gdb_e, 
    "e", 
    "m"
  )
  
# value
# universe: owner-occupied housing units
home_value_cat_b25075_gdb_e <-
  c("B25075e1",  # total
    "B25075e2",  # less than $10,000
    "B25075e3",  # $10,000 to $14,999
    "B25075e4",  # $15,000 to $19,999
    "B25075e5",  # $20,000 to $24,999
    "B25075e6",  # $25,000 to $29,999
    "B25075e7",  # $30,000 to $34,999
    "B25075e8",  # $35,000 to $39,999
    "B25075e9",  # $40,000 to $49,999
    "B25075e10",  # $50,000 to $59,999
    "B25075e11",  # $60,000 to $69,999
    "B25075e12",  # $70,000 to $79,999
    "B25075e13",  # $80,000 to $89,999
    "B25075e14",  # $90,000 to $99,999
    "B25075e15",  # $100,000 to $124,999
    "B25075e16",  # $125,000 to $149,999
    "B25075e17",  # $150,000 to $174,999
    "B25075e18",  # $175,000 to $199,999
    "B25075e19",  # $200,000 to $249,999
    "B25075e20",  # $250,000 to $299,999
    "B25075e21",  # $300,000 to $399,999
    "B25075e22",  # $400,000 to $499,999
    "B25075e23",  # $500,000 to $749,999
    "B25075e24",  # $750,000 to $999,999
    "B25075e25")  # $1,000,000 or more

home_value_cat_b25075_gdb_m <- 
  str_replace(
    home_value_cat_b25075_gdb_e, 
    "e", 
    "m"
  )

# median value (dollars)
# universe: owner-occupied housing units
home_value_median_b25077_gdb_e <-
  c("B25077e1")  # median value (dollars)

home_value_median_b25077_gdb_m <- 
  str_replace(
    home_value_median_b25077_gdb_e, 
    "e", 
    "m"
  )

# types of health insurance coverage by age
# universe: civilian noninstitutionalized population
health_insurance_cat_c27010_gdb_e <-
  c("C27010e1",  # total
    "C27010e2",    # under 18 years
    "C27010e3",      # with private health insurance only
    "C27010e4",      # with public coverage only
    "C27010e5",      # with both private and public coverage
    "C27010e6",      # no health insurance coverage
    "C27010e7",    # 18 to 34 years
    "C27010e8",      # with private health insurance only
    "C27010e9",      # with public coverage only
    "C27010e10",      # with both private and public coverage
    "C27010e11",      # no health insurance coverage
    "C27010e12",    # 35 to 64 years
    "C27010e13",      # with private health insurance only
    "C27010e14",      # with public coverage only
    "C27010e15",      # with both private and public coverage
    "C27010e16",      # no health insurance coverage
    "C27010e17",    # 65 years and over
    "C27010e18",      # with private health insurance only
    "C27010e19",      # with public coverage only
    "C27010e20",      # with both private and public coverage
    "C27010e21")      # no health insurance coverage

health_insurance_cat_c27010_gdb_m <- 
  str_replace(
    health_insurance_cat_c27010_gdb_e, 
    "e", 
    "m"
  )

# household language by households in which no one 14 and over speaks english only or speaks a language other than english at home and speaks english "very well"
# universe: households
ling_iso_b16002_gdb_e <-
  c("B16002e1",  # total
    "B16002e2",    # English only
    "B16002e3",    # Spanish:
    "B16002e4",      # No one 14 and over speaks English only or speaks English "very well"
    "B16002e5",      # At least one person 14 and over speaks English only or speaks English "very well"
    "B16002e6",    # Other Indo-European languages:
    "B16002e7",      # No one 14 and over speaks English only or speaks English "very well"
    "B16002e8",      # At least one person 14 and over speaks English only or speaks English "very well"
    "B16002e9",    # Asian and Pacific Island languages:
    "B16002e10",      # No one 14 and over speaks English only or speaks English "very well"
    "B16002e11",      # At least one person 14 and over speaks English only or speaks English "very well"
    "B16002e12",    # Other languages: 
    "B16002e13",      # No one 14 and over speaks English only or speaks English "very well"
    "B16002e14")     # At least one person 14 and over speaks English only or speaks English "very well"

ling_iso_b16002_gdb_m <- 
  str_replace(
    ling_iso_b16002_gdb_e, 
    "e", 
    "m"
  )

big_acs_gdb_var_list <- 
  list(
    edu_cat_b15003_gdb_e,
    edu_cat_b15003_gdb_m,
    poverty_ratio_cat_c17002_gdb_e,
    poverty_ratio_cat_c17002_gdb_m,
    income_house_cat_b19001_gdb_e,
    income_house_cat_b19001_gdb_m,
    income_house_median_b19013_gdb_e,
    income_house_median_b19013_gdb_m,
    earnings_sex_cat_b20001_gdb_e,
    earnings_sex_cat_b20001_gdb_m,
    earnings_median_b20002_gdb_e,
    earnings_median_b20002_gdb_m,
    employment_cat_b23025_gdb_e,
    employment_cat_b23025_gdb_m,
    home_value_cat_b25075_gdb_e,
    home_value_cat_b25075_gdb_m,
    home_value_median_b25077_gdb_e,
    home_value_median_b25077_gdb_m,
    health_insurance_cat_c27010_gdb_e,
    health_insurance_cat_c27010_gdb_m,
    ling_iso_b16002_gdb_e,
    ling_iso_b16002_gdb_m
  )

all_acs_gdb_vars <- 
  big_acs_gdb_var_list %>% 
  reduce(c)

```


```{r acs gdb select variables, eval=FALSE, include=FALSE}

select_acs_tibble <- 
  acs_data_from_gdb %>% 
  select(all_acs_gdb_vars)
  
```


#### old code versions

```{r old speciator function, eval=FALSE, include=FALSE}

speciator <- 
  function(speciation_file_link) {
    
    # extract the file name from the link
    speciation_zip_filename <-
      str_extract(
        speciation_file_link,
        "daily_.+\\.zip"
        )
    
    # create rdata file name
    speciation_rdata_filename <- 
      str_replace(
        speciation_zip_filename,
        "zip",
        "rdata"
        )
    
     if(
      !file.exists(  # checks if tibble already exists
        file.path(
          "intermediate_data",
          speciation_rdata_filename
          )
        )
      ) {
       
       # download the file
       file_downloader(
         desired_filename_as_string = speciation_zip_filename,
         web_address_as_string = speciation_file_link,
         folder_as_string = "raw_data"
       )
    
       # unzip the file
       unzip(
         file.path(
           "raw_data",
           speciation_zip_filename
           ), 
         exdir = "intermediate_data"
         )
      
       # replace ".zip" with ".csv" in speciation_zip_filename
       speciation_csv_filename <- 
         str_replace(
           speciation_zip_filename, 
           "zip", 
           "csv")
      
       speciation_tibble_name <- 
         str_replace(
           speciation_zip_filename, 
           ".zip",
           ""
         )
      
       # read .csv file into a tibble
         speciation_tibble <- 
           read_csv(
             file.path(
               "intermediate_data",
               speciation_csv_filename
               )
             )
         
       # fix column names
       speciation_tibble <-
         column_name_fixer(
           speciation_tibble
         )
       
       # # load organic carbon codes
       # if (!exists("organic_carbon_codes")) {
       # load(
       #   file = 
       #     file.path(
       #       "intermediate_data", 
       #       "organic_carbon_codes.rdata"
       #       )
       #   )
       # }
       #  
       # # keep only actual component measurements and necessary columns
       # # NOTE: NO LONGER DOING THIS
       # speciation_tibble_shrunk <- 
       #   speciation_tibble %>% 
       #   filter(parameter_code > 88100) %>% 
       #   filter(!(parameter_code %in% organic_carbon_codes)) %>% 
       #   select(
       #     -c(
       #       pollutant_standard, 
       #       units_of_measure, 
       #       aqi, 
       #       method_name, 
       #       local_site_name, 
       #       address, 
       #       county_name)
       #   )
       
       # rename it to its filename
       assign(
         speciation_tibble_name, 
         speciation_tibble
       )
        
       # save the result to disk
       save(
         list = speciation_tibble_name,
         file = 
           file.path(
             "intermediate_data",
             speciation_rdata_filename
             )
       )
       
       # delete .csv file from disk
       map(
         file.path(
           "intermediate_data",
           speciation_csv_filename
           ),
         file.remove
         )
      
       # remove files
       rm(
         speciation_tibble
         )
       gc()
     }
    
    # remove files
    rm(
      speciation_zip_filename, 
      speciation_rdata_filename
    )
    gc()
  }

```


#### parameter and species codes

```{r speciation parameter codes, eval=FALSE, include=FALSE, results=}

# source https://aqs.epa.gov/aqsweb/documents/codetables/methods_speciation.csv
# downloaded 2019 June 11
# last updated 

if(
  !file.exists(
    file.path(
      "intermediate_data", 
      "speciation_parameter_codes.rdata"
      )
    )
  ) {
  
  # download the speciation paramter codes
  file_downloader(
    desired_filename_as_string = "speciation_parameter_codes.csv",
    web_address_as_string = "https://aqs.epa.gov/aqsweb/documents/codetables/methods_speciation.csv", 
    folder_as_string = "raw_data"
    )

  # read the parameter codes into memory
  speciation_parameter_codes <- 
    read_csv(
      file.path("raw_data", 
                "speciation_parameter_codes.csv"
                )
    )
  
  # fix column names
  speciation_parameter_codes <-
    column_name_fixer(
     speciation_parameter_codes
    )

  # save the rdata file
  save(
    speciation_parameter_codes,
    file = file.path(
      "intermediate_data", 
      "speciation_parameter_codes.rdata"
    )
  )

  # remove the rdata from memory
  rm(speciation_parameter_codes)
  gc()
}

```


```{r make parameter and species lists, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "speciation_parameter_codes.rdata"
      )
)

# make a list of all the species and their codes
species_and_codes <- 
  speciation_parameter_codes %>% 
  select(parameter, parameter_code) %>% 
  distinct

# make a list of the organic carbon species and codes
organic_carbon_rows <- 
  species_and_codes %>% 
  filter(str_detect(parameter, "OC"))

# make a numeric vector of the organic carbon species and codes
organic_carbon_codes <-
  organic_carbon_rows %>% 
  select(parameter_code) %>% 
  pull()

save(
  species_and_codes, 
  file = 
    file.path(
      "intermediate_data", 
      "species_and_codes.rdata"
    )
  )

save(
  organic_carbon_codes, 
  file = 
    file.path(
      "intermediate_data", 
      "organic_carbon_codes.rdata"
    )
  )

# remove created data from memory
rm(
  organic_carbon_rows,
  organic_carbon_codes, 
  speciation_parameter_codes,
  species_and_codes)
gc()

```


#### old segregation calculations

```{r calculating segregation NOTE: USES ARCGIS, eval=FALSE, include=FALSE}

# load(
#   file = 
#     file.path(
#       "raw_data", 
#       "tigris_shapefiles_no_data.rdata"
#     )
#   )

census_adjacent <- 
  read.csv(
    file = 
      file.path(
        "raw_data", 
        "censusadjacent.csv"
      )
  )

load(
  file = 
    file.path(
      "intermediate_data", 
      "ruca_urban_only.rdata"
    )
)

load(
   file = 
      file.path(
        "intermediate_data",
        "sf1_totalcensus_tibble.rdata"
        )
   )

# fix column names 
sf1_totalcensus_seg_tibble <- 
  column_name_fixer(
    sf1_totalcensus_tibble
)

# import census data (Black, Black/other, total)
seg_vars <- 
  sf1_totalcensus_seg_tibble %>% 
  select(
    geoid, 
    p0050001, 
    p0050004
  )

seg_vars <- 
  seg_vars %>% 
  mutate(
    tot_pop_no_black = p0050001 - p0050004
  )

colnames(seg_vars)[1] <- 
  "selfneighbor"


# segregation index with nodes

# keep nodes
censusadjacentyesnodes <- census_adjacent
censusadjacentyesnodes <- censusadjacentyesnodes[c(-5)]
censusadjacentyesnodes <- as.data.frame(censusadjacentyesnodes[c(-4)])
censusadjacentyesnodes$src_GEOID10 <- 
  as.factor(censusadjacentyesnodes$src_GEOID10)
censusadjacentyesnodes$nbr_GEOID10 <- 
  as.factor(censusadjacentyesnodes$nbr_GEOID10)

# get adjacent blocks into single column as single character w/ commas
require(data.table)
cayncon <- 
  setDT(censusadjacentyesnodes)[,.(nbr_GEOID10=paste(nbr_GEOID10, collapse = ",")), by=src_GEOID10]
cayncon$src_GEOID10 <- as.character(cayncon$src_GEOID10)

# add own census tract to tracts
cayncon$selfandfriends <- paste(cayncon$src_GEOID10, cayncon$nbr_GEOID10, sep=",")
str(cayncon)

# save file to disk
save(cayncon,
     file="cayncon.rdata")
# load(file="cayncon.rdata")


#### racial isolation index with nodes urban tracts ####

monitorct <- 
  cayncon

# neighbors for each census tract plus itself
temp <- strsplit(monitorct$selfandfriends, split=",")
ltemp <- sapply(temp, length)
ct.nb <- data.frame(censustract = rep(NA, sum(ltemp)), selfneighbor = NA)
ct.nb[1:ltemp[1], "censustract"] <- monitorct[1, "src_GEOID10"]
ct.nb[1:ltemp[1], "selfneighbor"] <- temp[[1]]
for (i in 2:length(temp)) {
  st <- sum(ltemp[1:i-1])
  ct.nb[(st+1):(st+ltemp[i]), "censustract"] <- monitorct[i, "src_GEOID10"]
  ct.nb[(st+1):(st+ltemp[i]), "selfneighbor"] <- temp[[i]]
}

# fix geoid for seg_vars 
seg_vars <- 
  seg_vars %>% 
  mutate(
    selfneighbortest = 
      str_replace(
        selfneighbor, 
        "14000US",
        ""
      )
  )

# fix geoid for ct.nb 
ct.nb <- 
  ct.nb %>% 
  mutate(
    selfneighbortest = 
      str_pad(
        string = selfneighbor, 
        width = 11, 
        side = "left", 
        pad = "0")
  )
  
# merge the popoulation info
segindcalcbasis <- 
  merge(seg_vars, 
        ct.nb, 
        by="selfneighbortest")

# aggregate by census tract
aggregatevars <- 
  segindcalcbasis %>% 
  select(
    censustract,
    p0050001, 
    p0050004, 
    tot_pop_no_black
  )

aggregatedcensus <- 
  aggregate(. ~ censustract, 
            data = aggregatevars, sum)

aggregatedcensus$finalsegregationindex <- 
  aggregatedcensus$p0050004/aggregatedcensus$p0050001

range(aggregatedcensus$finalsegregationindex)

aggregatedcensus$GEOID10 <- aggregatedcensus$censustract

ri_yes_nodes_urban_tracts <- 
  aggregatedcensus[c("GEOID10",
                     "finalsegregationindex")]

ri_yes_nodes_urban_tracts$GEOID10 <- as.factor(ri_yes_nodes_urban_tracts$GEOID10)

colnames(ri_yes_nodes_urban_tracts) <- c("tract_id","ri_nodes_urban")

ri_final <- 
  ri_yes_nodes_urban_tracts %>% 
  mutate(
    geoid = 
        str_pad(
        string = tract_id, 
        width = 11, 
        side = "left", 
        pad = "0")
  ) %>% 
  arrange(geoid)

save(
  ri_final, 
  file = 
    file.path(
      "intermediate_data", 
      "ri_final"
    )
)


```


```{r doing intersections of buffers within tracts working plotting code}


# # plot buffer intersections
# ggplot() +
#   geom_sf(data = one_tract, colour = "light gray", fill = NA) +
#   geom_sf(data = buffer_intersections_with_the_tract, colour = "dark gray", fill = NA) 

# replace origin with monitor id

# # figuring out how the results of st_intersection work
# row_3_within <- 
#   within_tract_intersection_areas[3,]
# 
# row_4_within <- 
#     within_tract_intersection_areas[4,]
# 
# str(within_tract_intersection_areas)
# 
# ggplot() +
#   geom_sf(data = one_tract, colour = "light gray", fill = NA) +
#   geom_sf(data = row_3_within, colour = "dark gray", fill = NA) +
#   geom_sf(data = row_4_within, colour = "dark gray", fill = NA) 
#   
# plot(row_3_within)
# plot(row_4_within)

# # remove everything in memory (for travis!)
# rm(list = ls())
# gc()


```


```{r calculate areas}

# load weights
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_tract_intersections.rdata"
    )
)

# make area function
areator <- 
  function(sf_of_some_kind) {
    sf_of_some_kind %>% 
      mutate(
        intersect_area = 
          st_area(geometry)
      )
  }

# calculate areas
buffer_tract_areas <- 
  map(
    .f = areator, 
    .x = buffer_tract_intersections
  )

# save areas to disk
save(
  buffer_tract_areas,
  file = 
    file.path(
      "intermediate_data", 
      "buffer_tract_areas.rdata"
    )
)

# remove unneeded files
rm(buffer_tract_intersections, 
   buffer_tract_areas)
gc()


```


```{r calculate weights}

# load intersections
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_tract_intersections.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_tract_areas.rdata"
    )
)

# sum weights
monitor_weight_by_tract <- 
  buffer_tract_areas$buffer_tract_area_1000_m %>% 
  group_by(monitor_id)
  summarize(
    
  )
  
# remove everything in memory
rm(list = ls())
gc()

```

### joining the above to air data

```{r join tracts to air data, eval=FALSE, include=FALSE}

# load needed files
load(
  file = 
    file.path(
      "intermediate_data", 
      "monitors_to_tracts.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers_one_km_to_tracts,rdata"
    )
)

load(
  file = 
    file.path(
      "travis_cache", 
      "air_pollutant_tibble.rdata"
      )
  )

# make tibble with only monitor ids and geoids for buffer file
little_monitors_to_tracts <- 
  monitors_to_tracts %>% 
  st_drop_geometry() %>% 
  select(monitor_id, 
         geoid10) %>% 
  mutate(geoid_containing_tract = geoid10) %>% 
  select(monitor_id, 
         geoid_containing_tract)

# make tibble with only monitor ids and geoids for buffer file
little_buffers_one_km_to_tracts <- 
  buffers_one_km_to_tracts %>% 
  st_drop_geometry() %>% 
  select(
    monitor_id, 
    geoid10
    ) 

# join air pollution data to tracts
air_with_containing_tracts <- 
  left_join(
    air_pollutant_tibble, 
    little_monitors_to_tracts, 
    by = "monitor_id"
  )

# save air with containing tracts
save(
  air_with_containing_tracts, 
  file = 
    file.path(
      "intermediate_data", 
      "air_with_containing_tracts.rdata"
      )
  )

rm(monitors_to_tracts, 
   buffers_one_km_to_tracts, 
   air_pollutant_tibble, 
   little_monitors_to_tracts,
   little_buffers_one_km_to_tracts, 
   air_with_containing_tracts
)
gc()

```


```{r monitor subset for date, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "air_with_containing_tracts.rdata"
      )
  )

load(
  file = 
    file.path(
      "intermediate_data", 
      "sparse_monitors.rdata"
      )
  )

extra_sparse_monitors <- 
  sparse_monitors %>% 
  select(monitor_id, 
         monitor_type)

air_tracts_types <- 
  left_join(
    air_with_containing_tracts, 
    extra_sparse_monitors, 
    by = "monitor_id"
  )

data_for_monitor_operations <- 
  air_tracts_types %>% 
  select(
    monitor_id, 
    monitor_type,
    parameter_code, 
    date_local)

dates_by_monitor <- 
  data_for_monitor_operations %>% 
  group_by(monitor_id, monitor_type) %>% 
  summarize(
    first_date = min(date_local), 
    last_date = max(date_local)
  ) %>% 
  ungroup() %>% 
  distinct(monitor_id, .keep_all = TRUE)

dates_by_monitor_pm_only <- 
  dates_by_monitor %>% 
  filter(
    monitor_type == "pm25" | monitor_type == "both"
  ) %>% 
  arrange(first_date, last_date) %>% 
  mutate(monitor_id = factor(monitor_id, unique(monitor_id)))

dates_by_monitor_species_only <- 
  dates_by_monitor %>% 
  filter(
    monitor_type == "species" | monitor_type == "both"
  ) %>% 
  arrange(first_date, last_date) %>% 
  mutate(monitor_id = factor(monitor_id, unique(monitor_id)))

# 1,715 monitors
date_range_plot_pm <- 
  ggplot(dates_by_monitor_pm_only, 
         y = monitor_id) +
  geom_segment(
    aes(x = first_date, 
        xend = last_date, 
        y = monitor_id, 
        yend = monitor_id)
  ) +
  theme(axis.title.x = element_text("monitor"), 
        axis.title.y = element_text("date"), 
        axis.text.y = element_blank())
  
date_range_plot_species <- 
  ggplot(dates_by_monitor_species_only, 
         y = monitor_id) +
  geom_segment(
    aes(x = first_date, 
        xend = last_date, 
        y = monitor_id, 
        yend = monitor_id)
  ) +
  theme(axis.title.x = element_text("monitor"), 
        axis.title.y = element_text("date"), 
        axis.text.y = element_blank())

ggsave("date_range_plot_pm.png",plot=date_range_plot,width=20,height=60,units="cm")
ggsave("date_range_plot_species.png",plot=date_range_plot_species,width=20,height=60,units="cm")





```


```{r intertibblator function}

# create function to both intersect and tibblize
intertibblator <- 
  function(tract, 
           buffer) {
    as_tibble(st_intersection(tract, buffer))
  }


# # calculate intersections as tibbles
# buffer_tract_intersection_tibbles <- 
#   map2(
#     .f = intertibblator, 
#     .x = list_for_projected_tract_sf, 
#     .y = buffers
#   )  %>% 
#   set_names(buffer_tract_area_names)

```


```{r join buffers to tracts}

# load projected tract sf
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
  )

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# make one-element list wrapping the tract shapefile
list_for_projected_tract_sf <- 
  list(projected_tracts)

# remove projected tracts from memory
rm(projected_tracts)
invisible(gc())

# make list of names for new list
buffer_tract_names <- 
  names(buffers) %>% 
  gsub(x = .,
    pattern = "buffer_", 
    replacement = "buffer_tract_"
  )

# use the function on the list!
buffers_tracts <- 
  map2(.f = st_join,
       .x = buffers, 
       .y = list_for_projected_tract_sf, 
       left = TRUE) %>% 
  set_names(buffer_tract_names)

# save data to drive
save(
  buffers_tracts,
  file = 
    file.path(
      "intermediate_data", 
      "buffers_tracts.rdata"
    )
)

# remove files no longer needed
rm(buffers,
   list_for_projected_tract_sf,
   buffer_tract_names,
   buffers_tracts)
invisible(gc())

```


```{r create tract monitor intersections, eval=FALSE, include=FALSE}

# load projected tract sf
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
  )

# make one-element list wrapping the tract shapefile
list_for_projected_tract_sf <- 
  list(projected_tracts)

# remove projected tracts to save memory
rm(projected_tracts)
invisible(gc())

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# make list of names for new list
buffer_tract_area_names <- 
  names(buffers) %>% 
  gsub(x = .,
    pattern = "buffer_", 
    replacement = "buffer_tract_area_"
  )

# calculate intersections without tibblation without unionizing monitors
buffer_tract_intersections <-  
  map2(
    .f = st_intersection, 
    .x = list_for_projected_tract_sf, 
    .y = buffers
  ) %>% 
  set_names(buffer_tract_area_names)

# save data to drive
save(
  buffer_tract_intersections,
  file = 
    file.path(
      "intermediate_data", 
      "buffer_tract_intersections.rdata"
    )
)

# remove created variables
rm(list_for_projected_tract_sf, 
   buffers,
   buffer_tract_area_names,
   buffer_tract_intersections)
invisible(gc())

```


```{r make ueber-function to do buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load mapbuffintersector function
load(
  file = 
    file.path(
      "functions", 
      "mapbuffintersector.rdata"
     )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# list of buffer distances desired in meters
distances <- 
  c("1000", 
    "2000", 
    "2500", 
    "3000", 
    "4000", 
    "5000", 
    "7500", 
    "10000")

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)



# apply buffer function for all tracts for 1000-meter buffer
buffer_intersections_1000_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_1000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_1000_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_1000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_1000_m)
gc()



# apply buffer function for all tracts for 2000-meter buffer
buffer_intersections_2000_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_2000_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_2000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_2000_m)
gc()



# apply buffer function for all tracts for 2500-meter buffer
buffer_intersections_2500_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2500_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_2500_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_2500_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_2500_m)
gc()



# apply buffer function for all tracts for 3000-meter buffer
buffer_intersections_3000_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_3000_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_3000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_3000_m)
gc()



# apply buffer function for all tracts for 4000-meter buffer
buffer_intersections_4000_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_4000_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_4000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_4000_m)
gc()



# apply buffer function for all tracts for 5000-meter buffer
buffer_intersections_5000_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_5000_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_5000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_5000_m)
gc()



# apply buffer function for all tracts for 7500-meter buffer
buffer_intersections_7500_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_7500_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_7500_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_7500_m)
gc()



# apply buffer function for all tracts for 10000-meter buffer
buffer_intersections_10000_m <- 
  map(
    .f = buffintersector, 
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_10000_m, 
  file = 
    file.path(
      "intermediate_data",
      "buffer_intersections_10000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_10000_m)
gc()

```


```{r make function to do all at once, eval=FALSE, include=FALSE}

# make map_buff_intersect function!
mapbuffintersector <- 
  function(distance_character_vector) {
    
    # requires loaded objects 
    #  "buffintersector"
    #  "buffers"
    #  "projected_tracts"
    #  "tract_geoid_characters"
    
    object_name_string <- 
      str_c("buffer_intersections_", distance_character_vector, "_m")
    buffer_subfile_name_string <- 
      str_c("buffer_", distance_character_vector, "_m")
    save_file_name_string <- 
      str_c("buffer_intersections_", distance_character_vector, "_m.rdata")
    
    buffer_subfile_sf <- 
      buffers[[buffer_subfile_name_string]]
      
    # apply buffer intersection function
    intersections <- 
      map(
        .f = buffintersector, 
        .x = tract_geoid_characters,
        buffer_sf = buffer_subfile_sf,
        tract_sf = projected_tracts
      )

    assign(object_name_string, intersections)

    # save the result
    save(
      object_name_string, 
      file = 
        file.path(
          "intermediate_data",
          save_file_name_string
          )
      )
  }

save(
  mapbuffintersector, 
  file = 
    file.path(
      "functions", 
      "mapbuffintersector.rdata"
    )
)

rm(mapbuffintersector)
invisible(gc())
 
```


```{r try the function, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load mapbuffintersector function
load(
  file = 
    file.path(
      "functions", 
      "mapbuffintersector.rdata"
     )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# list of buffer distances desired in meters
distances <- 
  c("1000", 
    "2000", 
    "2500", 
    "3000", 
    "4000", 
    "5000", 
    "7500", 
    "10000")

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# mapbuffintersector("1000")

# apply the mapbuffintersector en masse
try(map(
  .x = distances, 
  .f = mapbuffintersector
))


```



#### buffer debugging detritus

#### buffer work using cartographic boundary shapefiles (cbfs) only


```{r project cbf tracts}

# load needed files
load(
  file = 
    file.path(
      "travis_cache", 
      "tract_cbfs.rdata"
    )
  )

# project the tracts to the NAD 83 Conus Albers Equal Area projection, a flat one, to make distances comparable
cbf_projected_tracts <- 
  tract_cbfs %>% 
  st_transform(crs = 5070) %>% 
  select(  # simplify to only needed variables
    geoid10, 
    censusarea
    ) %>% 
  mutate(  # calculate the total area of each census tract after projection (m2)
    cbf_proj_tract_area = 
      st_area(geometry)
  )

# set attributes for variables in projected tracts
st_agr(cbf_projected_tracts) <-  
  c(geoid10 = "identity", 
    censusarea = "aggregate", 
    cbf_proj_tract_area = "aggregate")

# save cbf projected tracts to disk
save(
  cbf_projected_tracts, 
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
      )
)

# remove objects in environment and clear memory
rm(
  tract_cbfs, 
  cbf_projected_tracts
)
invisible(gc())
```











```{r cbf all buffer intersections for one tract, eval=FALSE, include=FALSE}

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# extract one buffer layer and simplify it
one_buffer_size <- 
  buffers$buffer_10000_m %>% 
  select(monitor_id)

# extract one tract and simplify it
one_tract <- 
  cbf_projected_tracts %>% 
  filter(geoid10 == "02013000100") %>% 
  select(geoid10)

# clip buffers to only the one tract
buffers_in_tract <- 
  one_buffer_size %>% 
  st_intersection(one_tract, .) %>%  # this clips buffers (buffer sf is .)
  rowid_to_column("polygon_id")  # add row numbers to id polygons in next step

# make concordance vector to replace "origin" values (rows) with monitor ids
concordance_vector <- 
  setNames(
    object = buffers_in_tract$monitor_id,  # object to named
    nm = buffers_in_tract$polygon_id  # names (polygon #s)
  )

# find buffer intersections and areas by monitor
cbf_buffer_intersections_one_tract <- 
  buffers_in_tract %>% 
  st_intersection() %>% 
  mutate(area = st_area(geometry),  # add areas
         monitor_id_overlaps =  # add column of monitor ids
           map(
             .x = origins,  # go through the origin column (with polygon #s)
             .f = function(a) concordance_vector[a]  # replace with monitor ids
             )
         ) %>% 
  select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id

save(
  cbf_buffer_intersections_one_tract, 
  file = 
    file.path(
      "intermediate_data", 
      "cbf_buffer_intersections"
    )
)

# remove variables
rm(
  cbf_projected_tracts, 
  buffers,
  one_tract, 
  one_buffer_size, 
  buffers_in_tract, 
  concordance_vector, 
  cbf_buffer_intersections_one_tract
)
invisible(gc())

```


```{r cbf apply buffer function to a single case, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# try the function on a single tract and buffer size
try_the_first <- 
  buffintersector(tract_geoid_as_character = "02013000100", 
                  buffer_sf = buffers$buffer_1000_m, 
                  tract_sf = cbf_projected_tracts)

# remove objects from environment
rm(buffintersector, cbf_projected_tracts, buffers, try_the_first)
invisible(gc())

```


```{r cbf intra-tract 1000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 1000-meter buffer (TIME SUCK)
cbf_buffer_intersections_1000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_1000_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_1000_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_1000_m.rdata"
      )
  )

# remove object from memory
rm(buffintersector, 
   cbf_projected_tracts,
   buffers,
   tract_geoid_characters,
   cbf_buffer_intersections_1000_m)
gc()

```


```{r cbf intra-tract 2000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2000-meter buffer (TIME SUCK)
cbf_buffer_intersections_2000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2000_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_2000_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_2000_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_2000_m)
gc()

```


```{r cbf intra-tract 2500-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2500-meter buffer (TIME SUCK)
cbf_buffer_intersections_2500_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2500_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_2500_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_2500_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_2500_m)
gc()

```


```{r cbf intra-tract 3000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
cbf_buffer_intersections_3000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_3000_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_3000_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_3000_m)
gc()

```


```{r cbf intra-tract 4000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
cbf_buffer_intersections_4000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_4000_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_4000_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_4000_m)
gc()

```


```{r cbf intra-tract 5000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
cbf_buffer_intersections_5000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_5000_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_5000_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_5000_m)
gc()

```


```{r cbf intra-tract 7500-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
cbf_buffer_intersections_7500_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_7500_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_7500_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_7500_m)
gc()

```


```{r cbf intra-tract 10000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "cbf_projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  cbf_projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
cbf_buffer_intersections_10000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = cbf_projected_tracts
  )

# save the result
save(
  cbf_buffer_intersections_10000_m,
  file =
    file.path(
      "intermediate_data",
      "cbf_buffer_intersections_10000_m.rdata"
      )
  )

# remove object from memory
rm(cbf_buffer_intersections_10000_m)
gc()

```





```{r precise (1000) buffers}

# load projected monitor sf
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_monitors.rdata"
    )
  )

# make list in which to store the projected monitor sf
list_of_proj_mon_sf <- 
  list(projected_monitors)

# list of buffer distances desired in meters
distances <- 
  c(1000, 
    2000, 
    2500, 
    3000, 
    4000, 
    5000, 
    7500, 
    10000)

# make list of buffer names
buffer_names <- 
  str_c("buffer_", 
        as.character(distances), 
        "_m",
        sep = "")

# make the buffers
projected_buffers <- 
  map2(.f = st_buffer, 
      .y = distances, 
      .x = list_of_proj_mon_sf) %>% 
  set_names(buffer_names)  # name the list elements

# set relation_to_geometry ("agr") attribute to "constant" and precision to 1 mm
precise_1000_buffers <-
  map(
    .f = function(x) {
      st_agr(x) = 
        c(monitor_id = "identity", 
          monitor_type = "constant")
      st_set_precision(x, precision = 1000)
      return(x)
      },
    .x = projected_buffers
  )

# save the buffers
save(
  precise_1000_buffers, 
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# remove unneeded files
rm(
  projected_monitors,
  projected_buffers,
  list_of_proj_mon_sf, 
  distances, 
  buffer_names, 
  precise_1000_buffers
)
invisible(gc())

```






```{r getting all buffer intersections for one tract, eval=FALSE, include=FALSE}

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# extract one buffer layer and simplify it
one_buffer_size <- 
  buffers$buffer_10000_m %>% 
  select(monitor_id)

# extract one tract and simplify it
one_tract <- 
  projected_tracts %>% 
  filter(geoid10 == "02013000100") %>% 
  select(geoid10)

# clip buffers to only the one tract
buffers_in_tract <- 
  one_buffer_size %>% 
  st_intersection(one_tract, .) %>%  # this clips buffers (buffer sf is .)
  rowid_to_column("polygon_id")  # add row numbers to id polygons in next step

# make concordance vector to replace "origin" values (rows) with monitor ids
concordance_vector <- 
  setNames(
    object = buffers_in_tract$monitor_id,  # object to named
    nm = buffers_in_tract$polygon_id  # names (polygon #s)
  )

# find buffer intersections and areas by monitor
buffer_intersections <- 
  buffers_in_tract %>% 
  st_intersection() %>% 
  mutate(area = st_area(geometry),  # add areas
         monitor_id_overlaps =  # add column of monitor ids
           map(
             .x = origins,  # go through the origin column (with polygon #s)
             .f = function(a) concordance_vector[a]  # replace with monitor ids
             )
         ) %>% 
  select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id

save(
  buffer_intersections, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_intersections"
    )
)

# remove variables
rm(
  projected_tracts, 
  buffers,
  one_tract, 
  one_buffer_size, 
  buffers_in_tract, 
  concordance_vector, 
  buffer_intersections
)
invisible(gc())

```


```{r make buffer intersection function from the above single case}

buffintersector <- 
  function(tract_geoid_as_character, 
           buffer_sf, 
           tract_sf) {
    
    # extract one buffer layer and simplify it
    one_buffer_size <- 
      buffer_sf %>% 
      select(monitor_id)
    
    # extract one tract and simplify it
    one_tract <- 
      tract_sf %>% 
      filter(geoid10 == tract_geoid_as_character) %>% 
      select(geoid10) %>% 
      st_buffer(dist = 0.0)
    
    # clip buffers to only the one tract
    buffers_in_tract <- 
      one_buffer_size %>% 
      st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
      rowid_to_column("polygon_id") %>%   # add row numbers to id polygons in next step
      lwgeom::st_make_valid() %>% 
      st_buffer(dist = 0.0)
    
    # check if nrow from the above is zero, and if so, make a tibble and return it
    if(nrow(buffers_in_tract) == 0) {
      null_tibble <- 
        tibble(geoid10 = tract_geoid_as_character, 
               n.overlaps = as.integer(0), 
               origins = as.integer(0), 
               area = as.numeric(0), 
               monitor_id_overlaps = "none", 
               geometry = "none")

      return(null_tibble)
      
    } else {
    
    # make concordance vector to replace "origin" values (rows) with monitor ids
    concordance_vector <- 
      setNames(
        object = buffers_in_tract$monitor_id,  # object to named
        nm = buffers_in_tract$polygon_id  # names (polygon #s)
      )
    
    # find buffer intersections and areas by monitor
    buffer_intersections <- 
      buffers_in_tract %>% 
      st_intersection() %>% 
      mutate(area = st_area(geometry),  # add areas
             monitor_id_overlaps =  # add column of monitor ids
               map(
                 .x = origins,  # go through the origin column (with polygon #s)
                 .f = function(a) concordance_vector[a]  # replace with monitor ids
                 )
             ) %>% 
      select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
    
    return(buffer_intersections)
    
    }
  }
 
# save the function to disk
save(
  buffintersector, 
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

rm(buffintersector)
invisible(gc())

```


```{r apply buffer function to a single tract, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# try the function on a single tract and buffer size
try_the_first <- 
  buffintersector(tract_geoid_as_character = "02013000100", 
                  buffer_sf = buffers$buffer_1000_m, 
                  tract_sf = projected_tracts)
```


```{r all tract intra-tract 1000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 1000-meter buffer (TIME SUCK)
buffer_intersections_1000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_1000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_1000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_1000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_1000_m)
gc()

```


```{r all tract intra-tract 2000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 1000-meter buffer (TIME SUCK)
buffer_intersections_2000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_2000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_2000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_2000_m)
gc()

```


```{r all tract intra-tract 2500-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2500-meter buffer (TIME SUCK)
buffer_intersections_2500_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2500_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_2500_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_2500_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_2500_m)
gc()

```


```{r all tract intra-tract 3000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
buffer_intersections_3000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_3000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_3000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_3000_m)
gc()

```


```{r all tract intra-tract 4000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
buffer_intersections_4000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_4000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_4000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_4000_m)
gc()

```


```{r all tract intra-tract 5000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
buffer_intersections_5000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_5000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_5000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_5000_m)
gc()

```


```{r all tract intra-tract 7500-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
buffer_intersections_7500_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_7500_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_7500_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_7500_m)
gc()

```


```{r all tract intra-tract 10000-meter buffer intersections, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
buffer_intersections_10000_m <-
  map(
    .f = buffintersector,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# save the result
save(
  buffer_intersections_10000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_10000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_10000_m)
gc()

```



```{r debugging section, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load tract shapefiles
load(
  file = 
    file.path(
      "raw_data", 
      "tract_shapefiles_raw.rdata"
    )
)

# load monitors to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "monitors_to_tracts.rdata"
    )
)

# load column name function
load(
  file = 
    file.path(
      "functions", 
      "column_name_fixer.rdata"
    )
)

# make tibble of monitors and geoids
monitors_and_geoids <- 
  monitors_to_tracts %>% 
  st_drop_geometry() %>% 
  select(monitor_id, geoid10)

# use raw tract shapefiles to get the state ids
state_ids_and_tract_geoids <- 
  tract_shapefiles_raw %>% 
  as_tibble %>% 
  column_name_fixer %>% 
  select(geoid10, statefp10)

# add states to monitors
monitors_and_states <- 
  monitors_and_geoids %>% 
  left_join(state_ids_and_tract_geoids, 
            by = "geoid10")

# add states to tract shapefiles
projected_tracts_and_states <- 
  projected_tracts %>% 
  left_join(state_ids_and_tract_geoids, 
            by = "geoid10")

# filter to state 4
projected_tracts_state_04 <- 
  projected_tracts_and_states %>% 
  filter(statefp10 == "04")

# # apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
# buffer_intersections_10000_m <-
#   map(
#     .f = buffintersector,
#     .x = tract_geoid_characters,
#     buffer_sf = buffers$buffer_10000_m,
#     tract_sf = projected_tracts_and_states
#   )

ggplot() +
  geom_sf(data = projected_tracts_state_04) +
  geom_sf(data = buffers$buffer_10000_m) +
  coord_sf(xlim = c(-1488010, -1488000), 
           ylim = c(1284600, 1284610), 
           expand = FALSE)

mapview::mapView(list(buffers$buffer_10000_m, projected_tracts_state_04), native.crs = TRUE)

# save the result
save(
  buffer_intersections_10000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_intersections_10000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_intersections_10000_m)
gc()

```



### clip imprecise buffers

```{r clipped 1000-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper_precheck_intersect function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precheck_intersect.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts_simple.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts_simple %>% 
  pull(geoid10)

# apply buffer function for all tracts for 1000-meter buffer (TIME SUCK)
# future::plan(strategy = "multiprocess")

buffer_clips_1000_m <-
  map(
    .f = buffclipper_precheck_intersect,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_1000_m,
    tract_sf = projected_tracts_simple, 
    .progress = TRUE
  )

# name the sfs
names(buffer_clips_1000_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_1000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_1000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_1000_m)
invisible(gc())

```


```{r clipped 2000-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2000-meter buffer (TIME SUCK)
buffer_clips_2000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_2000_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_2000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_2000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_2000_m)
invisible(gc())

```


```{r clipped 2500-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2500-meter buffer (TIME SUCK)
buffer_clips_2500_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_2500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_2500_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_2500_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_2500_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_2500_m)
invisible(gc())

```


```{r clipped 3000-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
buffer_clips_3000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_3000_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_3000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_3000_m)
invisible(gc())

```


```{r clipped 4000-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
buffer_clips_4000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_4000_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_4000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_4000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_4000_m)
invisible(gc())

```


```{r clipped 5000-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
buffer_clips_5000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_5000_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_5000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_5000_m)
invisible(gc())

```


```{r clipped 7500-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
buffer_clips_7500_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_7500_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_7500_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_7500_m)
invisible(gc())

```


```{r clipped 10000-meter buffers for all tracts, eval=FALSE, include=FALSE}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
buffer_clips_10000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_10000_m) <- 
  tract_geoid_characters

# save the result
save(
  buffer_clips_10000_m,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_10000_m)
invisible(gc())

```











```{r clipped 1000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 1000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_1000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_1000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_1000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_1000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_1000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_1000_m)
invisible(gc())

```


```{r clipped 2000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_2000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_2000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_2000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_2000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_2000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_2000_m)
invisible(gc())

```


```{r clipped 2500-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 2500-meter buffer (TIME SUCK)
precise_1000_buffer_clips_2500_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_2500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_2500_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_2500_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_2500_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_2500_m)
invisible(gc())

```


```{r clipped 3000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_3000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_3000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_3000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_3000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_3000_m)
invisible(gc())

```


```{r clipped 4000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_4000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_4000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_4000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_4000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_4000_m)
invisible(gc())

```


```{r clipped 5000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_5000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_5000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_5000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_5000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_5000_m)
invisible(gc())

```


```{r clipped 7500-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
precise_1000_buffer_clips_7500_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_7500_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_7500_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_7500_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_7500_m)
invisible(gc())

```


```{r clipped 10000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_10000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_10000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_10000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_10000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_10000_m)
invisible(gc())

```




```{r make buffer intersection function with only 100 precision fix from the above single case}

buffintersectintractor_precise <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(precision = 100) %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }
 
# save the function to disk
save(
  buffintersectintractor_precise, 
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise.rdata"
    )
)

rm(buffintersectintractor_precise)
invisible(gc())

```


```{r make buffer intersection function with only 1000 precision fix from the above single case}

buffintersectintractor_precise_1000 <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(precision = 1000) %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }
 
# save the function to disk
save(
  buffintersectintractor_precise_1000, 
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise_1000.rdata"
    )
)

rm(buffintersectintractor_precise_1000)
invisible(gc())

```


```{r make buffer intersection function with only 1 precision fix from the above single case}

buffintersectintractor_precise_1 <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(precision = 1) %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }
 
# save the function to disk
save(
  buffintersectintractor_precise_1, 
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise_1.rdata"
    )
)

rm(buffintersectintractor_precise_1)
invisible(gc())

```


```{r make buffer intersection function with precision and buffer fix from the above single case}

buffintersectintractor_buff_precise <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(precision = 100) %>% 
        st_buffer(dist = 0) %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }
 
# save the function to disk
save(
  buffintersectintractor_buff_precise, 
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_buff_precise.rdata"
    )
)

rm(buffintersectintractor_buff_precise)
invisible(gc())

```


##### simple bufferintersectintractor with precise-1000 10000-meter buffers

```{r apply buffintersectintractor_simple to precise-1000 10000-meter buffers using safely}

# load buffintersectintractor_simple function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_simple.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

# do 10000-meter file
safely_intersects_simple_10000_m_precise_1000 <- 
  map(
  .f = safely(buffintersectintractor_simple), 
  .x = precise_1000_buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_simple_10000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_simple_10000_m_precise_1000.rdata"
    )
)

rm(precise_1000_buffer_clips_10000_m, 
   safely_intersects_simple_10000_m_precise_1000)
invisible(gc())

```


```{r apply buffintersectintractor_simple to precise-1000 10000-meter buffers using possibly}

# load buffintersectintractor_simple function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_simple.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

# do 10000-m file
possibly_intersects_simple_10000_m_precise_1000 <- 
  map(
  .f = possibly(buffintersectintractor_simple, 
                otherwise = "error"), 
  .x = precise_1000_buffer_clips_10000_m
)

save(
  possibly_intersects_simple_10000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_simple_10000_m_precise_1000.rdata"
    )
)

rm(precise_1000_buffer_clips_10000_m, 
   possibly_intersects_simple_10000_m_precise_1000)
invisible(gc())

```


```{r isolate the erroring tracts buffintersectintractor_simple precise-1000 10000-meter}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_simple_10000_m_precise_1000.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_simple_10000_m_precise_1000_true_false <- 
  possibly_intersects_simple_10000_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_simple_10000_m_precise_1000 <- 
  possibly_intersects_simple_10000_m_precise_1000 %>% 
  subset(errors_simple_10000_m_precise_1000_true_false)

# save the errors
save(
  errors_simple_10000_m_precise_1000, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_simple_10000_m_precise_1000.rdata"
    )
)

```


```{r isolate error cases buffintersectintractor_simple precise-1000 10000-meter}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_simple_10000_m_precise_1000.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_simple_10000_m_precise_1000.rdata"
    )
)

# get the numbers of the tracts with errors
tracts_simple_10000_m_precise_1000_errors <- 
  names(errors_simple_10000_m_precise_1000)

# select the actual tracts with errors
buffers_clips_simple_10000_m_precise_1000_throwing_errors <- 
  precise_1000_buffer_clips_10000_m[tracts_simple_10000_m_precise_1000_errors]

# select the error messages
error_messages_simple_10000_m_precise_1000 <- 
  safely_intersects_simple_10000_m_precise_1000$error[tracts_simple_10000_m_precise_1000_errors]

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_10000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffers_clips_10000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersectintractor(precision_fix)

```


#### precise buffers 1000 tries

```{r figure out which tracts are in common between the three error types}

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_simple_10000_m_precise_1000.rdata"
    )
)

length(errors_simple_10000_m_precise_1000)  # 183



load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_simple_10000_m_precise_1000.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_simple_10000_m_precise_1000.rdata"
    )
)


 
tracts_precise_1000_10000_m_errors <- # 239
  names(errors_precise_1000_10000_m)

tracts_precise_10000_m_errors <- # (100) 222 
  names(errors_precise_10000_m)

tracts_precise_1_10000_m_errors <- # 311
  names(errors_precise_1_10000_m)

tracts_buff_precise_10000_m_errors <- # 221
  names(errors_buff_precise_10000_m)

tracts_simple_10000_m_errors <- # 183
  names(errors_simple_10000_m)


tracts_precise_1000_10000_m_errors # 239

tracts_precise_10000_m_errors (100) # 222 

tracts_precise_1_10000_m_errors # 311

tracts_buff_precise_10000_m_errors # 221

tracts_simple_10000_m_errors # 183


safely_intersects_simple_10000_m$error$`17119404100`
safely_intersects_buff_precise_10000_m$error$`17119404100`
safely_intersects_precise_1_10000_m$error$`17119404100`
safely_intersects_precise_10000_m$error$`17119404100`
safely_intersects_precise_1000_10000_m$error$`17119404100`


intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_1_10000_m_errors
    ) # 61

intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_1000_10000_m_errors
    ) # 71

intersect(  # 100
    tracts_simple_10000_m_errors,
    tracts_precise_10000_m_errors
    ) # 72

intersect(
intersect(
intersect(
  intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_10000_m_errors),
  tracts_buff_precise_10000_m_errors
  ), 
tracts_precise_1_10000_m_errors), 
tracts_precise_1000_10000_m_errors) # 28



tracts_precise_1000_10000_m_errors <- # 239
  names(errors_precise_1000_10000_m)

tracts_precise_10000_m_errors <- # (100) 222 
  names(errors_precise_10000_m)

tracts_precise_1_10000_m_errors <- # 311
  names(errors_precise_1_10000_m)

tracts_buff_precise_10000_m_errors <- # 221
  names(errors_buff_precise_10000_m)

tracts_simple_10000_m_errors <- # 183
  names(errors_simple_10000_m)


errors_precise_1000_10000_m$`17119404100`

errors_precise_10000_m





# 72


intersect(
  intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_10000_m_errors),
  tracts_buff_precise_10000_m_errors
  ) # 72



intersect(
  tracts_simple_10000_m_errors, 
  tracts_buff_precise_10000_m_errors
) # 72

intersect(
  tracts_precise_10000_m_errors, 
  tracts_buff_precise_10000_m_errors
) # 221

# buff appears not to help



```



##### precise (100) bufferintersectintractor

```{r apply buffintersectintractor_precise to 10000-meter buffers using safely}

# load buffintersectintractor_precise function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-meter file
safely_intersects_precise_10000_m <- 
  map(
  .f = safely(buffintersectintractor_precise), 
  .x = buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_precise_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   safely_intersects_precise_10000_m)
invisible(gc())

```


```{r apply buffintersectintractor_precise to 10000-meter buffers using possibly}

# load buffintersectintractor_precise function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-m file
possibly_intersects_precise_10000_m <- 
  map(
  .f = possibly(buffintersectintractor_precise, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m
)

save(
  possibly_intersects_precise_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_precise_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   possibly_intersects_precise_10000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersectintractor_precise 10000-meter}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_precise_10000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_precise_10000_m_true_false <- 
  possibly_intersects_precise_10000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_precise_10000_m <- 
  possibly_intersects_precise_10000_m %>% 
  subset(errors_precise_10000_m_true_false)

# save the errors
save(
  errors_precise_10000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_10000_m.rdata"
    )
)

```


```{r isolate error cases buffintersectintractor_precise 10000-meter}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_10000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tracts_precise_10000_m_errors <- 
  names(errors_precise_10000_m)

# select the actual tracts with errors
buffers_clips_precise_10000_m_throwing_errors <- 
  buffer_clips_10000_m[tracts_precise_10000_m_errors]

# select the error messages
error_messages_precise_10000_m <- 
  safely_intersects_precise_10000_m$error[tracts_precise_10000_m_errors]

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_10000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffers_clips_10000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersectintractor(precision_fix)

```


##### precise = 1 bufferintersectintractor

```{r apply buffintersectintractor_precise_1 to 10000-meter buffers using safely}

# load buffintersectintractor_precise_1 function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise_1.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-meter file
safely_intersects_precise_1_10000_m <- 
  map(
  .f = safely(buffintersectintractor_precise_1), 
  .x = buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_precise_1_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_1_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   safely_intersects_precise_1_10000_m)
invisible(gc())

```


```{r apply buffintersectintractor_precise_1 to 10000-meter buffers using possibly}

# load buffintersectintractor_precise_1 function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise_1.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-m file
possibly_intersects_precise_1_10000_m <- 
  map(
  .f = possibly(buffintersectintractor_precise_1, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m
)

save(
  possibly_intersects_precise_1_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_precise_1_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   possibly_intersects_precise_1_10000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersectintractor_precise_1 10000-meter}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_precise_1_10000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_precise_1_10000_m_true_false <- 
  possibly_intersects_precise_1_10000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_precise_1_10000_m <- 
  possibly_intersects_precise_1_10000_m %>% 
  subset(errors_precise_1_10000_m_true_false)

# save the errors
save(
  errors_precise_1_10000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_1_10000_m.rdata"
    )
)

```


```{r isolate error cases buffintersectintractor_precise_1 10000-meter}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_1_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_1_10000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tracts_precise_1_10000_m_errors <- 
  names(errors_precise_1_10000_m)

# select the actual tracts with errors
buffers_clips_precise_1_10000_m_throwing_errors <- 
  buffer_clips_10000_m[tracts_precise_1_10000_m_errors]

# select the error messages
error_messages_precise_1_10000_m <- 
  safely_intersects_precise_1_10000_m$error[tracts_precise_1_10000_m_errors]

```


##### precise = 1000 bufferintersectintractor

```{r apply buffintersectintractor_precise_1000 to 10000-meter buffers using safely}

# load buffintersectintractor_precise_1000 function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise_1000.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-meter file
safely_intersects_precise_1000_10000_m <- 
  map(
  .f = safely(buffintersectintractor_precise_1000), 
  .x = buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_precise_1000_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_1000_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   safely_intersects_precise_1000_10000_m)
invisible(gc())

```


```{r apply buffintersectintractor_precise_1000 to 10000-meter buffers using possibly}

# load buffintersectintractor_precise_1000 function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_precise_1000.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-m file
possibly_intersects_precise_1000_10000_m <- 
  map(
  .f = possibly(buffintersectintractor_precise_1000, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m
)

save(
  possibly_intersects_precise_1000_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_precise_1000_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   possibly_intersects_precise_1000_10000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersectintractor_precise_1000 10000-meter}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_precise_1000_10000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_precise_1000_10000_m_true_false <- 
  possibly_intersects_precise_1000_10000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_precise_1000_10000_m <- 
  possibly_intersects_precise_1000_10000_m %>% 
  subset(errors_precise_1000_10000_m_true_false)

# save the errors
save(
  errors_precise_1000_10000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_1000_10000_m.rdata"
    )
)

```


```{r isolate error cases buffintersectintractor_precise_1000 10000-meter}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_1000_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_1000_10000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tracts_precise_1000_10000_m_errors <- 
  names(errors_precise_1000_10000_m)

# select the actual tracts with errors
buffers_clips_precise_1000_10000_m_throwing_errors <- 
  buffer_clips_10000_m[tracts_precise_1000_10000_m_errors]

# select the error messages
error_messages_precise_1000_10000_m <- 
  safely_intersects_precise_1000_10000_m$error[tracts_precise_1_10000_m_errors]

```





```{r testing precision}

load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

buffers_10000_precise <- 
  buffers$buffer_10000_m %>% 
  st_set_precision(precision = 1000)

st_precision(buffers_10000_precise)
  

st_precision(precise_1000_buffers$buffer_10000_m)

st_agr(precise_1000_buffers$buffer_10000_m)


```







```{r precise (10000) buffers}

# load projected monitor sf
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_monitors.rdata"
    )
  )

# make list in which to store the projected monitor sf
list_of_proj_mon_sf <- 
  list(projected_monitors)

# list of buffer distances desired in meters
distances <- 
  c(1000, 
    2000, 
    2500, 
    3000, 
    4000, 
    5000, 
    7500, 
    10000)

# make list of buffer names
buffer_names <- 
  str_c("buffer_", 
        as.character(distances), 
        "_m",
        sep = "")

# make the buffers
projected_buffers <- 
  map2(.f = st_buffer, 
      .y = distances, 
      .x = list_of_proj_mon_sf) %>% 
  set_names(buffer_names)  # name the list elements

# set relation_to_geometry ("agr") attribute to "constant" 
agr_buffers <-
  map(
    .f = function(x) {
      st_agr(x) = 
        c(monitor_id = "identity", 
          monitor_type = "constant")
      return(x)
      },
    .x = projected_buffers
  )

# set precision to 1 mm
precise_1000_buffers <-
  map(
    .f = function(x) {
      st_precision(x) <- 1000
      return(x)
      },
    .x = agr_buffers
  )


# save the buffers
save(
  precise_1000_buffers, 
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# remove unneeded files
rm(
  projected_monitors,
  projected_buffers,
  list_of_proj_mon_sf, 
  distances,  
  buffer_names, 
  agr_buffers,
  precise_1000_buffers
)
invisible(gc())

```


```{r clipped 10000-meter precise_1000_buffers for all tracts}

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load precise_1000_buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffers.rdata"
    )
)

# get list of tract geoids
tract_geoid_characters <- 
  projected_tracts %>% 
  pull(geoid10)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
precise_1000_buffer_clips_10000_m <-
  map(
    .f = buffclipper,
    .x = tract_geoid_characters,
    buffer_sf = precise_1000_buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(precise_1000_buffer_clips_10000_m) <- 
  tract_geoid_characters

# save the result
save(
  precise_1000_buffer_clips_10000_m,
  file =
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_10000_m.rdata"
      )
  )

# remove object from memory
rm(precise_1000_buffer_clips_10000_m)
invisible(gc())

```







```{r apply buffintersectintractor_simple to precise 10000-meter buffers using safely}

# load buffintersectintractor_simple function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_simple.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

# do 10000-meter file
safely_intersects_simple_10000_m_precise_1000_m_buffers <- 
  map(
  .f = safely(buffintersectintractor_simple), 
  .x = precise_1000_buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_simple_10000_m_precise_1000_m_buffers,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_simple_10000_m_precise_1000_m_buffers.rdata"
    )
)

rm(precise_1000_buffer_clips_10000_m, 
   safely_intersects_simple_10000_m_precise_1000_m_buffers)
invisible(gc())

```


```{r apply buffintersectintractor_simple to precise 10000-meter buffers using possibly}

# load buffintersectintractor_simple function
load(
  file = 
    file.path(
      "functions", 
      "buffintersectintractor_simple.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

# do 10000-m file
possibly_intersects_simple_10000_m_precise_1000_m_buffers <- 
  map(
  .f = possibly(buffintersectintractor_simple, 
                otherwise = "error"), 
  .x = precise_1000_buffer_clips_10000_m
)

save(
  possibly_intersects_simple_10000_m_precise_1000_m_buffers,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_simple_10000_m_precise_1000_m_buffers.rdata"
    )
)

rm(precise_1000_buffer_clips_10000_m, 
   possibly_intersects_simple_10000_m_precise_1000_m_buffers)
invisible(gc())

```


```{r isolate the erroring tracts buffintersectintractor_simple precise 10000-meter buffers}

# load possibly intersects
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_simple_10000_m_precise_1000_m_buffers.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_simple_10000_m_true_false_precise_1000_m_buffers <- 
  possibly_intersects_simple_10000_m_precise_1000_m_buffers %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_simple_10000_m_precise_1000_m_buffers <- 
  possibly_intersects_simple_10000_m_precise_1000_m_buffers %>% 
  subset(errors_simple_10000_m_true_false_precise_1000_m_buffers)

# save the errors
save(
  errors_simple_10000_m_precise_1000_m_buffers, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_simple_10000_m_precise_1000_m_buffers.rdata"
    )
)

```


```{r isolate error cases buffintersectintractor_simple precise 10000-meter buffers}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "precise_1000_buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_simple_10000_m_precise_1000_m_buffers.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_simple_10000_m_precise_1000_m_buffers.rdata"
    )
)

# get the numbers of the tracts with errors
tracts_simple_10000_m_errors_precise_1000_m_buffers <- 
  names(errors_simple_10000_m_precise_1000_m_buffers)

# select the actual tracts with errors
buffers_clips_simple_10000_m_throwing_errors_precise_1000_m_buffers <- 
  precise_1000_buffer_clips_10000_m[tracts_simple_10000_m_errors_precise_1000_m_buffers]

# select the error messages
error_messages_simple_10000_m_precise_1000_m_buffers <-  # still 183 tracts
  safely_intersects_simple_10000_m_precise_1000_m_buffers$error[tracts_simple_10000_m_errors_precise_1000_m_buffers]


# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_10000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffers_clips_10000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersectintractor(precision_fix)

```








## code dumped 2020-01-09

```{r simple buffclipper for debugging}

buffclipper <- 
  function(tract_geoid_as_character, 
           buffer_sf, 
           tract_sf) {
    
    # extract one buffer layer and simplify it
    one_buffer_size <- 
      buffer_sf %>% 
      select(monitor_id)
    
    # extract one tract and simplify it
    one_tract <- 
      tract_sf %>% 
      filter(geoid10 == tract_geoid_as_character) %>% 
      select(geoid10) # %>% 
      # st_buffer(dist = 0.0)
    
    # clip buffers to only the one tract
    buffers_in_tract <- 
      one_buffer_size %>% 
      st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
      rowid_to_column("polygon_id") # %>%   # add row numbers to id polygons in next step
      # lwgeom::st_make_valid() %>% 
      # st_buffer(dist = 0.0)
    
    # check if nrow from the above is zero, and if so, make a tibble and return it
    if(nrow(buffers_in_tract) == 0) {
      null_tibble <- 
        tibble(geoid10 = tract_geoid_as_character, 
               n.overlaps = as.integer(0), 
               origins = as.integer(0), 
               area = as.numeric(0), 
               monitor_id_overlaps = "none", 
               geometry = "none")

      return(null_tibble)
      
    } else {
      
      return(buffers_in_tract)
    
    }
  }
 
# save the function to disk
save(
  buffclipper, 
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

rm(buffclipper)
invisible(gc())

```


```{r buffer intersection function without precision or buffer fixes for debugging}

buffintersector <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }
 
# save the function to disk
save(
  buffintersector, 
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

rm(buffintersector)
invisible(gc())

```








```{r apply buffintersector using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# list all the relevant file names
clip_file_names <- 
  list.files(
    pattern = "buffer_clips_.*", 
    recursive = TRUE, 
    include.dirs = FALSE
  )

# load them all into the environment
lapply(
  clip_file_names, 
  load, 
  .GlobalEnv
)

# do 1000-m file
safely_intersects_1000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_1000_m
) %>% 
  transpose()

save(
  safely_intersects_1000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_1000_m.rdata"
    )
)

rm(buffer_clips_1000_m, 
   safely_intersects_1000_m)
invisible(gc())



# do 2000-m file
safely_intersects_2000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2000_m
) %>% 
  transpose()

save(
  safely_intersects_2000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2000_m.rdata"
    )
)

rm(buffer_clips_2000_m, 
   safely_intersects_2000_m)
invisible(gc())



# do 2500-m file
safely_intersects_2500_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2500_m
) %>% 
  transpose()

save(
  safely_intersects_2500_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2500_m.rdata"
    )
)

rm(buffer_clips_2500_m, 
   safely_intersects_2500_m)
invisible(gc())



# do 3000-m file
safely_intersects_3000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m
) %>% 
  transpose()

save(
  safely_intersects_3000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m.rdata"
    )
)

rm(buffer_clips_3000_m, 
   safely_intersects_3000_m)
invisible(gc())



# do 4000-m file
safely_intersects_4000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m
) %>% 
  transpose()

save(
  safely_intersects_4000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m.rdata"
    )
)

rm(buffer_clips_4000_m, 
   safely_intersects_4000_m)
invisible(gc())



# do 5000-m file
safely_intersects_5000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m
) %>% 
  transpose()

save(
  safely_intersects_5000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m.rdata"
    )
)

rm(buffer_clips_5000_m, 
   safely_intersects_5000_m)
invisible(gc())



# do 7500-m file
safely_intersects_7500_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m
) %>% 
  transpose()

save(
  safely_intersects_7500_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m.rdata"
    )
)

rm(buffer_clips_7500_m, 
   safely_intersects_7500_m)
invisible(gc())



# do 10000-m file
safely_intersects_10000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   safely_intersects_10000_m)
invisible(gc())

```


```{r apply buffintersector using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# list all the relevant file names
clip_file_names <- 
  list.files(
    pattern = "buffer_clips_.*", 
    recursive = TRUE, 
    include.dirs = FALSE
  )

# load them all into the environment
lapply(
  clip_file_names, 
  load, 
  .GlobalEnv
)



# do 1000-m file
possibly_intersects_1000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_1000_m
)

save(
  possibly_intersects_1000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_1000_m.rdata"
    )
)

rm(buffer_clips_1000_m, 
   possibly_intersects_1000_m)
invisible(gc())



# do 2000-m file
possibly_intersects_2000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2000_m
)

save(
  possibly_intersects_2000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2000_m.rdata"
    )
)

rm(buffer_clips_2000_m, 
   possibly_intersects_2000_m)
invisible(gc())



# do 2500-m file
possibly_intersects_2500_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2500_m
)

save(
  possibly_intersects_2500_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2500_m.rdata"
    )
)

rm(buffer_clips_2500_m, 
   possibly_intersects_2500_m)
invisible(gc())



# do 3000-m file
possibly_intersects_3000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m
)

save(
  possibly_intersects_3000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m.rdata"
    )
)

rm(buffer_clips_3000_m, 
   possibly_intersects_3000_m)
invisible(gc())



# do 4000-m file
possibly_intersects_4000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m
)

save(
  possibly_intersects_4000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m.rdata"
    )
)

rm(buffer_clips_4000_m, 
   possibly_intersects_4000_m)
invisible(gc())



# do 5000-m file
possibly_intersects_5000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m
)

save(
  possibly_intersects_5000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m.rdata"
    )
)

rm(buffer_clips_5000_m, 
   possibly_intersects_5000_m)
invisible(gc())



# do 7500-m file
possibly_intersects_7500_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m
)

save(
  possibly_intersects_7500_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m.rdata"
    )
)

rm(buffer_clips_7500_m, 
   possibly_intersects_7500_m)
invisible(gc())



# do 10000-m file
possibly_intersects_10000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m
)

save(
  possibly_intersects_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   possibly_intersects_10000_m)
invisible(gc())

```


```{r isolate the erroring tracts, eval=FALSE, message=FALSE, include=FALSE}

# list all the relevant file names
possibly_intersect_file_names <- 
  list.files(
    pattern = "possibly_intersects_.*", 
    recursive = TRUE, 
    include.dirs = FALSE
  )

# load them all into the environment
lapply(
  possibly_intersect_file_names, 
  load, 
  .GlobalEnv
)

# make true/false vector for tracts throwing errors
errors_1000_m_true_false <- 
  possibly_intersects_1000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_1000_m <- 
  possibly_intersects_1000_m %>% 
  subset(errors_1000_m_true_false)

errors_2000_m_true_false <- 
  possibly_intersects_2000_m %>% 
  str_detect(pattern = "error")

errors_2000_m <- 
  possibly_intersects_2000_m %>% 
  subset(errors_2000_m_true_false)

errors_2500_m_true_false <- 
  possibly_intersects_2500_m %>% 
  str_detect(pattern = "error")

errors_2500_m <- 
  possibly_intersects_2500_m %>% 
  subset(errors_2000_m_true_false)

errors_3000_m_true_false <- 
  possibly_intersects_3000_m %>% 
  str_detect(pattern = "error")

errors_3000_m <- 
  possibly_intersects_3000_m %>% 
  subset(errors_3000_m_true_false)

errors_4000_m_true_false <- 
  possibly_intersects_4000_m %>% 
  str_detect(pattern = "error")

errors_4000_m <- 
  possibly_intersects_4000_m %>% 
  subset(errors_4000_m_true_false)

errors_5000_m_true_false <- 
  possibly_intersects_5000_m %>% 
  str_detect(pattern = "error")

errors_5000_m <- 
  possibly_intersects_5000_m %>% 
  subset(errors_5000_m_true_false)
  
errors_7500_m_true_false <- 
  possibly_intersects_7500_m %>% 
  str_detect(pattern = "error")

errors_7500_m <- 
  possibly_intersects_7500_m %>% 
  subset(errors_7500_m_true_false)

length(errors_7500_m)

errors_10000_m_true_false <- 
  possibly_intersects_10000_m %>% 
  str_detect(pattern = "error")

errors_10000_m <- 
  possibly_intersects_10000_m %>% 
  subset(errors_10000_m_true_false)



# save the errors
save(
  errors_1000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_1000_m.rdata"
    )
)

save(
  errors_2000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_2000_m.rdata"
    )
)

save(
  errors_2500_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_2500_m.rdata"
    )
)

save(
  errors_3000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m.rdata"
    )
)

save(
  errors_4000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_4000_m.rdata"
    )
)

save(
  errors_5000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m.rdata"
    )
)

save(
  errors_7500_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m.rdata"
    )
)

save(
  errors_10000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m.rdata"
    )
)
  
```


```{r isolate error cases, eval=FALSE, include=FALSE}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tracts_10000_m_errors <- 
  names(errors_10000_m)

# select the actual tracts with errors
buffers_clips_10000_m_throwing_errors <- 
  buffer_clips_10000_m[tracts_10000_m_errors]

# select the error messages
error_messages_10000_m <- 
  safely_intersects_10000_m$error[tracts_10000_m_errors]

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_10000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffers_clips_10000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

```






```{r figure out which tracts are in common between the three error types}

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_1_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_precise_1000_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_buff_precise_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_1_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_precise_1000_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_buff_precise_10000_m.rdata"
    )
)
 
tracts_precise_1000_10000_m_errors <- # 239
  names(errors_precise_1000_10000_m)

tracts_precise_10000_m_errors <- # (100) 222 
  names(errors_precise_10000_m)

tracts_precise_1_10000_m_errors <- # 311
  names(errors_precise_1_10000_m)

tracts_buff_precise_10000_m_errors <- # 221
  names(errors_buff_precise_10000_m)

tracts_simple_10000_m_errors <- # 183
  names(errors_10000_m)


tracts_precise_1000_10000_m_errors # 239

tracts_precise_10000_m_errors (100) # 222 

tracts_precise_1_10000_m_errors # 311

tracts_buff_precise_10000_m_errors # 221

tracts_simple_10000_m_errors # 183


safely_intersects_10000_m$error$`17119404100`
safely_intersects_buff_precise_10000_m$error$`17119404100`
safely_intersects_precise_1_10000_m$error$`17119404100`
safely_intersects_precise_10000_m$error$`17119404100`
safely_intersects_precise_1000_10000_m$error$`17119404100`


intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_1_10000_m_errors
    ) # 61

intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_1000_10000_m_errors
    ) # 71

intersect(  # 100
    tracts_simple_10000_m_errors,
    tracts_precise_10000_m_errors
    ) # 72

intersect(
intersect(
intersect(
  intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_10000_m_errors),
  tracts_buff_precise_10000_m_errors
  ), 
tracts_precise_1_10000_m_errors), 
tracts_precise_1000_10000_m_errors) # 28



tracts_precise_1000_10000_m_errors <- # 239
  names(errors_precise_1000_10000_m)

tracts_precise_10000_m_errors <- # (100) 222 
  names(errors_precise_10000_m)

tracts_precise_1_10000_m_errors <- # 311
  names(errors_precise_1_10000_m)

tracts_buff_precise_10000_m_errors <- # 221
  names(errors_buff_precise_10000_m)

tracts_simple_10000_m_errors <- # 183
  names(errors_10000_m)


errors_precise_1000_10000_m$`17119404100`

errors_precise_10000_m





# 72


intersect(
  intersect(
    tracts_simple_10000_m_errors,
    tracts_precise_10000_m_errors),
  tracts_buff_precise_10000_m_errors
  ) # 72



intersect(
  tracts_simple_10000_m_errors, 
  tracts_buff_precise_10000_m_errors
) # 72

intersect(
  tracts_precise_10000_m_errors, 
  tracts_buff_precise_10000_m_errors
) # 221

# buff appears not to help



```



```{r load hard-core error tracts}

# load the erroring tract ids
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors

tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors

tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors

tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors

# call them hard cores
hard_core_3000_tract_ids <- 
  tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors

hard_core_5000_tract_ids <- 
  tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors

hard_core_7500_tract_ids <- 
  tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors

hard_core_10000_tract_ids <- 
  tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors

# save the hard cores
save(
  hard_core_3000_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_3000_tract_ids.rdata"
    )
)

save(
  hard_core_5000_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_5000_tract_ids.rdata"
    )
)

save(
  hard_core_7500_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_7500_tract_ids.rdata"
    )
)

save(
  hard_core_10000_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_10000_tract_ids.rdata"
    )
)


# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# isolate the erroring tracts
hard_core_3000_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_3000_tract_ids)

hard_core_5000_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_5000_tract_ids)

hard_core_7500_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_7500_tract_ids)

hard_core_10000_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_10000_tract_ids)

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# clip 3000-meter buffers
buffer_clips_3000_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_3000_tract_ids,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = hard_core_3000_raw_tracts
  )

buffer_clips_5000_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_5000_tract_ids,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = hard_core_5000_raw_tracts
  )

buffer_clips_7500_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_7500_tract_ids,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = hard_core_7500_raw_tracts
  )

buffer_clips_10000_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_10000_tract_ids,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = hard_core_10000_raw_tracts
  )

# intersect the buffers

## 3 km
# possibly
poss_inter_3000_hard <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard
)

# safely
safe_inter_3000_hard <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_3000_hard
    ) %>%
  transpose()


## 5 km
# possibly
poss_inter_5000_hard <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_hard
)

# safely
safe_inter_5000_hard <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_5000_hard
    ) %>%
  transpose()


## 7.5 km
# possibly
poss_inter_7500_hard <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_hard
)

# safely
safe_inter_7500_hard <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_7500_hard
    ) %>%
  transpose()


## 10 km
# possibly
poss_inter_10000_hard <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_hard
)

# safely
safe_inter_10000_hard <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_10000_hard
    ) %>%
  transpose()




#### 3000s or die

##### try buffer whatnot
buffer_clips_3000_hard_prec_1000 <- 
  map(
    .f = st_set_precision, 
    .x = buffer_clips_3000_hard, 
    precision = 1000)

# possibly
poss_inter_3000_hard_prec_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000
)

# safely
safe_inter_3000_hard_prec_1000 <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_3000_hard_prec_1000
    ) %>%
  transpose()

# validate it
buffer_clips_3000_hard_prec_1000_valid <- 
  map(
    .f = st_make_valid,
    .x = buffer_clips_3000_hard_prec_1000)

# possibly
poss_inter_3000_hard_prec_1000_valid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000_valid
)

# safely
safe_inter_3000_hard_prec_1000_valid <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_3000_hard_prec_1000_valid
    ) %>%
  transpose()

# try mapping
hard_3000_map <- 
  buffer_clips_3000_hard[[1]]

mapview::mapView(hard_3000_map, native.crs = TRUE)

hard_core_3000_prec_1000_valid_tracts <- 
  hard_core_3000_raw_tracts %>% 
  st_set_precision(precision = 1000) %>% 
  st_make_valid()

hard_core_3000_buffers_prec_1000_valid <- 
  buffers$buffer_3000_m %>% 
  st_set_precision(1000) %>% 
  st_make_valid()

# clip using the above
buffer_clips_3000_hard_prec_1000_valid_root <-
  map(
    .f = buffclipper,
    .x = hard_core_3000_tract_ids,
    buffer_sf = hard_core_3000_buffers_prec_1000_valid,
    tract_sf = hard_core_3000_prec_1000_valid_tracts
  )

# possibly
poss_inter_3000_hard_prec_1000_valid_root <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000_valid_root
)

# safely
safe_inter_3000_hard_prec_1000_valid_root <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_3000_hard_prec_1000_valid_root
    ) %>%
  transpose()

buffer_clips_3000_hard_prec_1000_valid_root_revalid <-
  map(
    .f = st_make_valid,
    .x = buffer_clips_3000_hard_prec_1000_valid_root)

# possibly
poss_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
)

# safely
safe_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
    .f = safely(buffintersector),
    .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
    ) %>%
  transpose()


# r try fixing the intersector function
buffintersector_prec_1000_valid <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(1000) %>% 
        st_make_valid() %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }

save(
  buffintersector_prec_1000_valid, 
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_1000_valid.rdata"
    )
)

# possibly
poss_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
  .f = possibly(buffintersector_prec_1000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
)

# safely
safe_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
    .f = safely(buffintersector_prec_1000_valid),
    .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
    ) %>%
  transpose()


# r try fixing the intersector function
buffintersector_prec_1_valid <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(1) %>% 
        st_make_valid() %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }

save(
  buffintersector_prec_1_valid, 
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_1_valid.rdata"
    )
)


# possibly
poss_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
  .f = possibly(buffintersector_prec_1_valid, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
)

# safely
safe_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
    .f = safely(buffintersector_prec_1_valid),
    .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
    ) %>%
  transpose()




# r try fixing the intersector function
buffintersector_prec_10_valid <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(10) %>% 
        st_make_valid() %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }

save(
  buffintersector_prec_10_valid, 
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_10_valid.rdata"
    )
)

# possibly
poss_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
  .f = possibly(buffintersector_prec_10_valid, 
                otherwise = "error"), 
  .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
)

# safely
safe_inter_3000_hard_prec_1000_valid_root_revalid <- 
  map(
    .f = safely(buffintersector_prec_10_valid),
    .x = buffer_clips_3000_hard_prec_1000_valid_root_revalid
    ) %>%
  transpose()


hard_core_3000_prec_100000_valid_tracts <- 
  hard_core_3000_raw_tracts %>% 
  st_set_precision(precision = 100000) %>% 
  st_make_valid()

hard_core_3000_buffers_prec_100000_valid <- 
  buffers$buffer_3000_m %>% 
  st_set_precision(100000) %>% 
  st_make_valid()

# clip 3000-meter buffers
buffer_clips_3000_hard_prec_100000_valid <-
  map(
    .f = buffclipper,
    .x = hard_core_3000_tract_ids,
    buffer_sf = hard_core_3000_buffers_prec_100000_valid,
    tract_sf = hard_core_3000_prec_100000_valid_tracts
  )

# validate again
buffer_clips_3000_come_ON <-
  buffer_clips_3000_hard_prec_100000_valid[[1]] %>% 
  st_set_precision(100000) %>% 
  st_make_valid() %>% 
  st_set_precision(100000)

load(
  file = 
    file.path("functions", 
              "buffintersector_prec_100000_valid.rdata"))

possible_buffintersector <- 
  possibly(buffintersector_prec_100000_valid, 
           otherwise = "error")

safe_buffintersector <- 
  safely(buffintersector_prec_100000_valid)

# safely
safe_3000_come_ON <- 
  buffer_clips_3000_come_ON %>% 
  safe_buffintersector()

grrr <- 
  st_snap_to_grid(buffer_clips_3000_come_ON, 26)

buffintersector(grrr)
safe_buffintersector(grrr)

mapview::mapView(grrr, native.crs = TRUE)

grrr2 <- 
  st_snap_to_grid(buffer_clips_3000_hard[[1]], 26)

buffintersector(grrr2)

# use grrr2!









```




##### clipping buffers using buffclipper_precvaltractbuff_timestwo

```{r clipped 3000-meter buffers for erroring tracts using buffclipper_precvaltractbuff_timestwo, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff_timestwo function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
buffer_clips_3000_m_precvaltractbuff_timestwo <-
  map(
    .f = buffclipper_precvaltractbuff_timestwo,
    .x = tract_ids_3000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_3000_m_precvaltractbuff_timestwo) <- 
  tract_ids_3000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_3000_m_precvaltractbuff_timestwo,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m_precvaltractbuff_timestwo.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_3000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r clipped 4000-meter buffers for erroring tracts using buffclipper_precvaltractbuff_timestwo, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff_timestwo function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_4000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
buffer_clips_4000_m_precvaltractbuff_timestwo <-
  map(
    .f = buffclipper_precvaltractbuff_timestwo,
    .x = tract_ids_4000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_4000_m_precvaltractbuff_timestwo) <- 
  tract_ids_4000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_4000_m_precvaltractbuff_timestwo,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_4000_m_precvaltractbuff_timestwo.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_4000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r clipped 5000-meter buffers for erroring tracts using buffclipper_precvaltractbuff_timestwo, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff_timestwo function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
buffer_clips_5000_m_precvaltractbuff_timestwo <-
  map(
    .f = buffclipper_precvaltractbuff_timestwo,
    .x = tract_ids_5000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_5000_m_precvaltractbuff_timestwo) <- 
  tract_ids_5000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_5000_m_precvaltractbuff_timestwo,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m_precvaltractbuff_timestwo.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_5000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r clipped 7500-meter buffers for erroring tracts using buffclipper_precvaltractbuff_timestwo, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff_timestwo function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
buffer_clips_7500_m_precvaltractbuff_timestwo <-
  map(
    .f = buffclipper_precvaltractbuff_timestwo,
    .x = tract_ids_7500_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_7500_m_precvaltractbuff_timestwo) <- 
  tract_ids_7500_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_7500_m_precvaltractbuff_timestwo,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m_precvaltractbuff_timestwo.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_7500_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r clipped 10000-meter buffers for erroring tracts using buffclipper_precvaltractbuff_timestwo, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff_timestwo function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
buffer_clips_10000_m_precvaltractbuff_timestwo <-
  map(
    .f = buffclipper_precvaltractbuff_timestwo,
    .x = tract_ids_10000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_10000_m_precvaltractbuff_timestwo) <- 
  tract_ids_10000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_10000_m_precvaltractbuff_timestwo,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m_precvaltractbuff_timestwo.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_10000_m_precvaltractbuff_timestwo)
invisible(gc())

```




###### using precvaltractbuff_timestwo

####### 3000 meters

```{r apply buffintersector to 3000-meter buffers using safely}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m_for_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_3000_m_for_precvaltractbuff_timestwo <- 
  buffer_clips_3000_m_for_precvaltractbuff[tract_ids_3000_m_precvaltractbuff_errors]

save(
  buffer_clips_3000_m_for_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 3000-meter file
safely_intersects_3000_m_precvaltractbuff_timestwo <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_for_precvaltractbuff_timestwo
) %>% 
  transpose()

save(
  safely_intersects_3000_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_3000_m_for_precvaltractbuff, 
   tract_ids_3000_m_precvaltractbuff_errors, 
   buffer_clips_3000_m_for_precvaltractbuff_timestwo,
   safely_intersects_3000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r apply buffintersector to 3000-meter buffers using possibly}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 3000-m file
possibly_intersects_3000_m_precvaltractbuff_timestwo <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_for_precvaltractbuff_timestwo
)

save(
  possibly_intersects_3000_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector,
   buffer_clips_3000_m_for_precvaltractbuff_timestwo, 
   possibly_intersects_3000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 3000-meter}

# load the 3000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvaltractbuff_timestwo.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_3000_m_precvaltractbuff_timestwo_true_false <- 
  possibly_intersects_3000_m_precvaltractbuff_timestwo %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_3000_m_precvaltractbuff_timestwo <- 
  possibly_intersects_3000_m_precvaltractbuff_timestwo %>% 
  subset(errors_3000_m_precvaltractbuff_timestwo_true_false)

# save the errors
save(
  errors_3000_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m_precvaltractbuff_timestwo.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_3000_m_precvaltractbuff_timestwo_errors <- 
  names(errors_3000_m_precvaltractbuff_timestwo)

# select the actual tracts with errors
buffer_clips_3000_m_precvaltractbuff_timestwo_throwing_errors <- 
  buffer_clips_3000_m_for_precvaltractbuff_timestwo[tract_ids_3000_m_precvaltractbuff_timestwo_errors]

# select the error messages
error_messages_3000_m_precvaltractbuff_timestwo <- 
  safely_intersects_3000_m_precvaltractbuff_timestwo$error[tract_ids_3000_m_precvaltractbuff_timestwo_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_3000_m_precvaltractbuff_timestwo_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_timestwo_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_precvaltractbuff_timestwo_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_timestwo_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvaltractbuff_timestwo.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_3000_m_for_precvaltractbuff_timestwo,
  errors_3000_m_precvaltractbuff_timestwo_true_false,
  errors_3000_m_precvaltractbuff_timestwo,
  safely_intersects_3000_m_precvaltractbuff_timestwo,
  possibly_intersects_3000_m_precvaltractbuff_timestwo,
  tract_ids_3000_m_precvaltractbuff_timestwo_errors,
  buffer_clips_3000_m_precvaltractbuff_timestwo_throwing_errors, 
  error_messages_3000_m_precvaltractbuff_timestwo
)

# clear working memory
invisible(gc())

```



####### 5000 meters

```{r apply buffintersector to 5000-meter buffers using safely}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m_for_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_5000_m_for_precvaltractbuff_timestwo <- 
  buffer_clips_5000_m_for_precvaltractbuff[tract_ids_5000_m_precvaltractbuff_errors]

save(
  buffer_clips_5000_m_for_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 5000-meter file
safely_intersects_5000_m_precvaltractbuff_timestwo <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_for_precvaltractbuff_timestwo
) %>% 
  transpose()

save(
  safely_intersects_5000_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_5000_m_for_precvaltractbuff, 
   tract_ids_5000_m_precvaltractbuff_errors, 
   buffer_clips_5000_m_for_precvaltractbuff_timestwo,
   safely_intersects_5000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r apply buffintersector to 5000-meter buffers using possibly}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 5000-m file
possibly_intersects_5000_m_precvaltractbuff_timestwo <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_for_precvaltractbuff_timestwo
)

save(
  possibly_intersects_5000_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector,
   buffer_clips_5000_m_for_precvaltractbuff_timestwo, 
   possibly_intersects_5000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 5000-meter}

# load the 5000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvaltractbuff_timestwo.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_5000_m_precvaltractbuff_timestwo_true_false <- 
  possibly_intersects_5000_m_precvaltractbuff_timestwo %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_5000_m_precvaltractbuff_timestwo <- 
  possibly_intersects_5000_m_precvaltractbuff_timestwo %>% 
  subset(errors_5000_m_precvaltractbuff_timestwo_true_false)

# save the errors
save(
  errors_5000_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m_precvaltractbuff_timestwo.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_5000_m_precvaltractbuff_timestwo_errors <- 
  names(errors_5000_m_precvaltractbuff_timestwo)

# select the actual tracts with errors
buffer_clips_5000_m_precvaltractbuff_timestwo_throwing_errors <- 
  buffer_clips_5000_m_for_precvaltractbuff_timestwo[tract_ids_5000_m_precvaltractbuff_timestwo_errors]

# select the error messages
error_messages_5000_m_precvaltractbuff_timestwo <- 
  safely_intersects_5000_m_precvaltractbuff_timestwo$error[tract_ids_5000_m_precvaltractbuff_timestwo_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_5000_m_precvaltractbuff_timestwo_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_timestwo_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_precvaltractbuff_timestwo_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvaltractbuff_timestwo_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvaltractbuff_timestwo.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_5000_m_for_precvaltractbuff_timestwo,
  errors_5000_m_precvaltractbuff_timestwo_true_false,
  errors_5000_m_precvaltractbuff_timestwo,
  safely_intersects_5000_m_precvaltractbuff_timestwo,
  possibly_intersects_5000_m_precvaltractbuff_timestwo,
  tract_ids_5000_m_precvaltractbuff_timestwo_errors,
  buffer_clips_5000_m_precvaltractbuff_timestwo_throwing_errors, 
  error_messages_5000_m_precvaltractbuff_timestwo
)

# clear working memory
invisible(gc())

```



####### 7500 meters

```{r apply buffintersector to 7500-meter buffers using safely}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m_for_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_7500_m_for_precvaltractbuff_timestwo <- 
  buffer_clips_7500_m_for_precvaltractbuff[tract_ids_7500_m_precvaltractbuff_errors]

save(
  buffer_clips_7500_m_for_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 7500-meter file
safely_intersects_7500_m_precvaltractbuff_timestwo <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_for_precvaltractbuff_timestwo
) %>% 
  transpose()

save(
  safely_intersects_7500_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_7500_m_for_precvaltractbuff, 
   tract_ids_7500_m_precvaltractbuff_errors, 
   buffer_clips_7500_m_for_precvaltractbuff_timestwo,
   safely_intersects_7500_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r apply buffintersector to 7500-meter buffers using possibly}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 7500-m file
possibly_intersects_7500_m_precvaltractbuff_timestwo <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_for_precvaltractbuff_timestwo
)

save(
  possibly_intersects_7500_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector,
   buffer_clips_7500_m_for_precvaltractbuff_timestwo, 
   possibly_intersects_7500_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 7500-meter}

# load the 7500-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_for_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvaltractbuff_timestwo.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_7500_m_precvaltractbuff_timestwo_true_false <- 
  possibly_intersects_7500_m_precvaltractbuff_timestwo %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_7500_m_precvaltractbuff_timestwo <- 
  possibly_intersects_7500_m_precvaltractbuff_timestwo %>% 
  subset(errors_7500_m_precvaltractbuff_timestwo_true_false)

# save the errors
save(
  errors_7500_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m_precvaltractbuff_timestwo.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_7500_m_precvaltractbuff_timestwo_errors <- 
  names(errors_7500_m_precvaltractbuff_timestwo)

# select the actual tracts with errors
buffer_clips_7500_m_precvaltractbuff_timestwo_throwing_errors <- 
  buffer_clips_7500_m_for_precvaltractbuff_timestwo[tract_ids_7500_m_precvaltractbuff_timestwo_errors]

# select the error messages
error_messages_7500_m_precvaltractbuff_timestwo <- 
  safely_intersects_7500_m_precvaltractbuff_timestwo$error[tract_ids_7500_m_precvaltractbuff_timestwo_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_7500_m_precvaltractbuff_timestwo_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_timestwo_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_precvaltractbuff_timestwo_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvaltractbuff_timestwo_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvaltractbuff_timestwo.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_7500_m_for_precvaltractbuff_timestwo,
  errors_7500_m_precvaltractbuff_timestwo_true_false,
  errors_7500_m_precvaltractbuff_timestwo,
  safely_intersects_7500_m_precvaltractbuff_timestwo,
  possibly_intersects_7500_m_precvaltractbuff_timestwo,
  tract_ids_7500_m_precvaltractbuff_timestwo_errors,
  buffer_clips_7500_m_precvaltractbuff_timestwo_throwing_errors, 
  error_messages_7500_m_precvaltractbuff_timestwo
)

# clear working memory
invisible(gc())

```



####### 10000 meters

```{r apply buffintersector to 10000-meter buffers using safely}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m_for_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_10000_m_for_precvaltractbuff_timestwo <- 
  buffer_clips_10000_m_for_precvaltractbuff[tract_ids_10000_m_precvaltractbuff_errors]

save(
  buffer_clips_10000_m_for_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 10000-meter file
safely_intersects_10000_m_precvaltractbuff_timestwo <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_for_precvaltractbuff_timestwo
) %>% 
  transpose()

save(
  safely_intersects_10000_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_10000_m_for_precvaltractbuff, 
   tract_ids_10000_m_precvaltractbuff_errors, 
   buffer_clips_10000_m_for_precvaltractbuff_timestwo,
   safely_intersects_10000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r apply buffintersector to 10000-meter buffers using possibly}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

# do 10000-m file
possibly_intersects_10000_m_precvaltractbuff_timestwo <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_for_precvaltractbuff_timestwo
)

save(
  possibly_intersects_10000_m_precvaltractbuff_timestwo,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffintersector,
   buffer_clips_10000_m_for_precvaltractbuff_timestwo, 
   possibly_intersects_10000_m_precvaltractbuff_timestwo)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 10000-meter}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_for_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvaltractbuff_timestwo.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff_timestwo.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_10000_m_precvaltractbuff_timestwo_true_false <- 
  possibly_intersects_10000_m_precvaltractbuff_timestwo %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_10000_m_precvaltractbuff_timestwo <- 
  possibly_intersects_10000_m_precvaltractbuff_timestwo %>% 
  subset(errors_10000_m_precvaltractbuff_timestwo_true_false)

# save the errors
save(
  errors_10000_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m_precvaltractbuff_timestwo.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_10000_m_precvaltractbuff_timestwo_errors <- 
  names(errors_10000_m_precvaltractbuff_timestwo)

# select the actual tracts with errors
buffer_clips_10000_m_precvaltractbuff_timestwo_throwing_errors <- 
  buffer_clips_10000_m_for_precvaltractbuff_timestwo[tract_ids_10000_m_precvaltractbuff_timestwo_errors]

# select the error messages
error_messages_10000_m_precvaltractbuff_timestwo <- 
  safely_intersects_10000_m_precvaltractbuff_timestwo$error[tract_ids_10000_m_precvaltractbuff_timestwo_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_10000_m_precvaltractbuff_timestwo_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_timestwo_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_precvaltractbuff_timestwo_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvaltractbuff_timestwo_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvaltractbuff_timestwo.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_10000_m_for_precvaltractbuff_timestwo,
  errors_10000_m_precvaltractbuff_timestwo_true_false,
  errors_10000_m_precvaltractbuff_timestwo,
  safely_intersects_10000_m_precvaltractbuff_timestwo,
  possibly_intersects_10000_m_precvaltractbuff_timestwo,
  tract_ids_10000_m_precvaltractbuff_timestwo_errors,
  buffer_clips_10000_m_precvaltractbuff_timestwo_throwing_errors, 
  error_messages_10000_m_precvaltractbuff_timestwo
)

# clear working memory
invisible(gc())

```


```{r}

one_case <- 
  buffer_clips_10000_m_buffintersector_revised_erroring[[1]]

error_one_case <- 
  error_messages_10000_m_buffintersector_revised_erroring[[1]]

st_is_valid(buffer_clips_10000_m_buffintersector_revised_erroring[[1]])
  
mapview::mapView(one_case, native.crs = TRUE)

```



```{r revised buffclipper making buffers and tracts precise and valid for debugging twice}

buffclipper_precvaltractbuff_timestwo_timestwo <- 
  function(tract_geoid_as_character, 
           buffer_sf, 
           tract_sf) {
    
    # extract one buffer layer and simplify it
    one_buffer_size <- 
      buffer_sf %>% 
      select(monitor_id) %>% 
      st_set_precision(precision = 100000) %>% 
      st_make_valid()
    
    # extract one tract and simplify it
    one_tract <- 
      tract_sf %>% 
      filter(geoid10 == tract_geoid_as_character) %>% 
      select(geoid10) %>% 
      st_set_precision(precision = 100000) %>% 
      st_make_valid()
    
    # clip buffers to only the one tract
    buffers_in_tract <- 
      one_buffer_size %>% 
      st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
      rowid_to_column("polygon_id") %>%   # add row numbers to id polygons in next step
      st_set_precision(precision = 100000) %>% 
      st_make_valid()
    
    # check if nrow from the above is zero, and if so, make a tibble and return it
    if(nrow(buffers_in_tract) == 0) {
      null_tibble <- 
        tibble(geoid10 = tract_geoid_as_character, 
               n.overlaps = as.integer(0), 
               origins = as.integer(0), 
               area = as.numeric(0), 
               monitor_id_overlaps = "none", 
               geometry = "none")

      return(null_tibble)
      
    } else {
      
      return(buffers_in_tract)
    
    }
  }
 
# save the function to disk
save(
  buffclipper_precvaltractbuff_timestwo_timestwo, 
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo_timestwo.rdata"
    )
)

rm(buffclipper_precvaltractbuff_timestwo_timestwo)
invisible(gc())

```



##### try buffintersector_prec_1000_valid on tracts that are STILL ERRORING

###### 3000-meter

```{r apply buffintersector_prec_100000_valid to 3000-meter buffers using safely}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_errors.rdata"
    )
)

# do 3000-meter file
safely_intersects_3000_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_3000_m_precvaltractbuff_throwing_errors
) %>% 
  transpose()

save(
  safely_intersects_3000_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_3000_m_precvaltractbuff_throwing_errors,
   tract_ids_3000_m_precvaltractbuff_errors, 
   safely_intersects_3000_m_precvaltractbuff_prec_100000_valid)
invisible(gc())

```


```{r apply buffintersector_prec_100000_valid to 3000-meter buffers using possibly}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_errors.rdata"
    )
)

# do 3000-m file
possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_precvaltractbuff_throwing_errors 
)


save(
  possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_3000_m_precvaltractbuff_throwing_errors,
   tract_ids_3000_m_precvaltractbuff_errors, 
   possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid)
invisible(gc())




```


```{r isolate the erroring tracts buffintersector_prec_100000_valid 3000-meter}

# load the 3000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_3000_m_precvaltractbuff_prec_100000_valid_true_false <- 
  possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_3000_m_precvaltractbuff_prec_100000_valid <- 
  possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid %>% 
  subset(errors_3000_m_precvaltractbuff_prec_100000_valid_true_false)

# save the errors
save(
  errors_3000_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors <- 
  names(errors_3000_m_precvaltractbuff_prec_100000_valid)

# select the actual tracts with errors
buffer_clips_3000_m_precvaltractbuff_prec_100000_valid_throwing_errors <- 
  buffer_clips_3000_m_precvaltractbuff_throwing_errors[tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors]

# select the error messages
error_messages_3000_m_precvaltractbuff_prec_100000_valid <- 
  safely_intersects_3000_m_precvaltractbuff_prec_100000_valid$error[tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_prec_100000_valid_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_3000_m_precvaltractbuff_throwing_errors,
  errors_3000_m_precvaltractbuff_prec_100000_valid_true_false,
  errors_3000_m_precvaltractbuff_prec_100000_valid,
  safely_intersects_3000_m_precvaltractbuff_prec_100000_valid,
  possibly_intersects_3000_m_precvaltractbuff_prec_100000_valid,
  tract_ids_3000_m_precvaltractbuff_prec_100000_valid_errors,
  buffer_clips_3000_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  error_messages_3000_m_precvaltractbuff_prec_100000_valid
)

# clear working memory
invisible(gc())

```



###### 5000-meter

```{r apply buffintersector_prec_100000_valid to 5000-meter buffers using safely}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_errors.rdata"
    )
)

# do 5000-meter file
safely_intersects_5000_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_5000_m_precvaltractbuff_throwing_errors
) %>% 
  transpose()

save(
  safely_intersects_5000_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_5000_m_precvaltractbuff_throwing_errors,
   tract_ids_5000_m_precvaltractbuff_errors, 
   safely_intersects_5000_m_precvaltractbuff_prec_100000_valid)
invisible(gc())

```


```{r apply buffintersector_prec_100000_valid to 5000-meter buffers using possibly}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_errors.rdata"
    )
)

# do 5000-m file
possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_precvaltractbuff_throwing_errors 
)


save(
  possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_5000_m_precvaltractbuff_throwing_errors,
   tract_ids_5000_m_precvaltractbuff_errors, 
   possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid)
invisible(gc())




```


```{r isolate the erroring tracts buffintersector_prec_100000_valid 5000-meter}

# load the 5000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_5000_m_precvaltractbuff_prec_100000_valid_true_false <- 
  possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_5000_m_precvaltractbuff_prec_100000_valid <- 
  possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid %>% 
  subset(errors_5000_m_precvaltractbuff_prec_100000_valid_true_false)

# save the errors
save(
  errors_5000_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors <- 
  names(errors_5000_m_precvaltractbuff_prec_100000_valid)

# select the actual tracts with errors
buffer_clips_5000_m_precvaltractbuff_prec_100000_valid_throwing_errors <- 
  buffer_clips_5000_m_precvaltractbuff_throwing_errors[tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors]

# select the error messages
error_messages_5000_m_precvaltractbuff_prec_100000_valid <- 
  safely_intersects_5000_m_precvaltractbuff_prec_100000_valid$error[tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvaltractbuff_prec_100000_valid_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_5000_m_precvaltractbuff_throwing_errors,
  errors_5000_m_precvaltractbuff_prec_100000_valid_true_false,
  errors_5000_m_precvaltractbuff_prec_100000_valid,
  safely_intersects_5000_m_precvaltractbuff_prec_100000_valid,
  possibly_intersects_5000_m_precvaltractbuff_prec_100000_valid,
  tract_ids_5000_m_precvaltractbuff_prec_100000_valid_errors,
  buffer_clips_5000_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  error_messages_5000_m_precvaltractbuff_prec_100000_valid
)

# clear working memory
invisible(gc())

```



###### 7500-meter

```{r apply buffintersector_prec_100000_valid to 7500-meter buffers using safely}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_errors.rdata"
    )
)

# do 7500-meter file
safely_intersects_7500_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_7500_m_precvaltractbuff_throwing_errors
) %>% 
  transpose()

save(
  safely_intersects_7500_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_7500_m_precvaltractbuff_throwing_errors,
   tract_ids_7500_m_precvaltractbuff_errors, 
   safely_intersects_7500_m_precvaltractbuff_prec_100000_valid)
invisible(gc())

```


```{r apply buffintersector_prec_100000_valid to 7500-meter buffers using possibly}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_errors.rdata"
    )
)

# do 7500-m file
possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_precvaltractbuff_throwing_errors 
)


save(
  possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_7500_m_precvaltractbuff_throwing_errors,
   tract_ids_7500_m_precvaltractbuff_errors, 
   possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid)
invisible(gc())




```


```{r isolate the erroring tracts buffintersector_prec_100000_valid 7500-meter}

# load the 7500-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvaltractbuff_throwing_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_7500_m_precvaltractbuff_prec_100000_valid_true_false <- 
  possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_7500_m_precvaltractbuff_prec_100000_valid <- 
  possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid %>% 
  subset(errors_7500_m_precvaltractbuff_prec_100000_valid_true_false)

# save the errors
save(
  errors_7500_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors <- 
  names(errors_7500_m_precvaltractbuff_prec_100000_valid)

# select the actual tracts with errors
buffer_clips_7500_m_precvaltractbuff_prec_100000_valid_throwing_errors <- 
  buffer_clips_7500_m_precvaltractbuff_throwing_errors[tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors]

# select the error messages
error_messages_7500_m_precvaltractbuff_prec_100000_valid <- 
  safely_intersects_7500_m_precvaltractbuff_prec_100000_valid$error[tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvaltractbuff_prec_100000_valid_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_7500_m_precvaltractbuff_throwing_errors,
  errors_7500_m_precvaltractbuff_prec_100000_valid_true_false,
  errors_7500_m_precvaltractbuff_prec_100000_valid,
  safely_intersects_7500_m_precvaltractbuff_prec_100000_valid,
  possibly_intersects_7500_m_precvaltractbuff_prec_100000_valid,
  tract_ids_7500_m_precvaltractbuff_prec_100000_valid_errors,
  buffer_clips_7500_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  error_messages_7500_m_precvaltractbuff_prec_100000_valid
)

# clear working memory
invisible(gc())

```


###### 10000-meter

```{r apply buffintersector_prec_100000_valid to 10000-meter buffers using safely}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_errors.rdata"
    )
)

# do 10000-meter file
safely_intersects_10000_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_10000_m_precvaltractbuff_throwing_errors
) %>% 
  transpose()

save(
  safely_intersects_10000_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_10000_m_precvaltractbuff_throwing_errors,
   tract_ids_10000_m_precvaltractbuff_errors, 
   safely_intersects_10000_m_precvaltractbuff_prec_100000_valid)
invisible(gc())

```


```{r apply buffintersector_prec_100000_valid to 10000-meter buffers using possibly}

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_errors.rdata"
    )
)

# do 10000-m file
possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_precvaltractbuff_throwing_errors 
)


save(
  possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

rm(buffintersector_prec_100000_valid, 
   buffer_clips_10000_m_precvaltractbuff_throwing_errors,
   tract_ids_10000_m_precvaltractbuff_errors, 
   possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid)
invisible(gc())




```


```{r isolate the erroring tracts buffintersector_prec_100000_valid 10000-meter}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_10000_m_precvaltractbuff_prec_100000_valid_true_false <- 
  possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_10000_m_precvaltractbuff_prec_100000_valid <- 
  possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid %>% 
  subset(errors_10000_m_precvaltractbuff_prec_100000_valid_true_false)

# save the errors
save(
  errors_10000_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors <- 
  names(errors_10000_m_precvaltractbuff_prec_100000_valid)

# select the actual tracts with errors
buffer_clips_10000_m_precvaltractbuff_prec_100000_valid_throwing_errors <- 
  buffer_clips_10000_m_precvaltractbuff_throwing_errors[tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors]

# select the error messages
error_messages_10000_m_precvaltractbuff_prec_100000_valid <- 
  safely_intersects_10000_m_precvaltractbuff_prec_100000_valid$error[tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvaltractbuff_prec_100000_valid_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_precvaltractbuff_prec_100000_valid, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_10000_m_precvaltractbuff_throwing_errors,
  errors_10000_m_precvaltractbuff_prec_100000_valid_true_false,
  errors_10000_m_precvaltractbuff_prec_100000_valid,
  safely_intersects_10000_m_precvaltractbuff_prec_100000_valid,
  possibly_intersects_10000_m_precvaltractbuff_prec_100000_valid,
  tract_ids_10000_m_precvaltractbuff_prec_100000_valid_errors,
  buffer_clips_10000_m_precvaltractbuff_prec_100000_valid_throwing_errors, 
  error_messages_10000_m_precvaltractbuff_prec_100000_valid
)

# clear working memory
invisible(gc())

```


```{r check the error messages}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvaltractbuff_prec_100000_valid.rdata"
    )
)


```




```{r tracts still erroring 3000 meters}

load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_throwing_errors.rdata"  # 1
    )
)


# isolate one tract with errors
check_one_case <-
  buffer_clips_3000_m_precvaltractbuff_throwing_errors$`47145030700`

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvaltractbuff.rdata"  # 1
    )
)

# 1023201.436900752 1490889.0819999997

# map the case
mapview::mapView(check_one_case, native.crs = TRUE)

```



#### fix remaining tracts using st_buffer NO CHANGE

```{r 3000 meters, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_made_valid_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_made_valid_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_3000_m_0_buffered <- 
  map(
    .f = st_buffer, 
    .x = buffer_clips_3000_m_made_valid_erroring, 
    dist = 0
  )

# run with safely
safely_intersects_3000_m_0_buffered <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_0_buffered
) %>% 
  transpose()

save(
  safely_intersects_3000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_0_buffered.rdata"
    )
)

# run with possibly
possibly_intersects_3000_m_0_buffered <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_0_buffered
)

save(
  possibly_intersects_3000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_0_buffered.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_3000_m_0_buffered_true_false <- 
  possibly_intersects_3000_m_0_buffered %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_3000_m_0_buffered <- 
  possibly_intersects_3000_m_0_buffered %>% 
  subset(errors_3000_m_0_buffered_true_false)

# get the numbers of the tracts with errors
tract_ids_3000_m_0_buffered_erroring <- 
  names(errors_3000_m_0_buffered)

# select the actual tracts with errors
buffer_clips_3000_m_0_buffered_erroring <- 
  buffer_clips_3000_m_0_buffered[tract_ids_3000_m_0_buffered_erroring]

# select the error messages
error_messages_3000_m_0_buffered_erroring <- 
  safely_intersects_3000_m_0_buffered$error[tract_ids_3000_m_0_buffered_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_0_buffered_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_3000_m_made_valid_erroring, 
  error_messages_3000_m_made_valid_erroring, 
  buffintersector,
  buffer_clips_3000_m_0_buffered, 
  safely_intersects_3000_m_0_buffered, 
  possibly_intersects_3000_m_0_buffered, 
  errors_3000_m_0_buffered_true_false, 
  errors_3000_m_0_buffered,
  tract_ids_3000_m_0_buffered_erroring, 
  buffer_clips_3000_m_0_buffered_erroring, 
  error_messages_3000_m_0_buffered_erroring
)
  
# cleanup
invisible(gc())

```


```{r 4000 meters, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_made_valid_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_made_valid_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_4000_m_0_buffered <- 
  map(
    .f = st_buffer, 
    .x = buffer_clips_4000_m_made_valid_erroring, 
    dist = 0
  )

# run with safely
safely_intersects_4000_m_0_buffered <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m_0_buffered
) %>% 
  transpose()

save(
  safely_intersects_4000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_0_buffered.rdata"
    )
)

# run with possibly
possibly_intersects_4000_m_0_buffered <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_0_buffered
)

save(
  possibly_intersects_4000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_0_buffered.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_4000_m_0_buffered_true_false <- 
  possibly_intersects_4000_m_0_buffered %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_4000_m_0_buffered <- 
  possibly_intersects_4000_m_0_buffered %>% 
  subset(errors_4000_m_0_buffered_true_false)

# get the numbers of the tracts with errors
tract_ids_4000_m_0_buffered_erroring <- 
  names(errors_4000_m_0_buffered)

# select the actual tracts with errors
buffer_clips_4000_m_0_buffered_erroring <- 
  buffer_clips_4000_m_0_buffered[tract_ids_4000_m_0_buffered_erroring]

# select the error messages
error_messages_4000_m_0_buffered_erroring <- 
  safely_intersects_4000_m_0_buffered$error[tract_ids_4000_m_0_buffered_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_0_buffered_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_4000_m_made_valid_erroring, 
  error_messages_4000_m_made_valid_erroring, 
  buffintersector,
  buffer_clips_4000_m_0_buffered, 
  safely_intersects_4000_m_0_buffered, 
  possibly_intersects_4000_m_0_buffered, 
  errors_4000_m_0_buffered_true_false, 
  errors_4000_m_0_buffered,
  tract_ids_4000_m_0_buffered_erroring, 
  buffer_clips_4000_m_0_buffered_erroring, 
  error_messages_4000_m_0_buffered_erroring
)
  
# cleanup
invisible(gc())

```


```{r 5000 meters, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_made_valid_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_made_valid_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_5000_m_0_buffered <- 
  map(
    .f = st_buffer, 
    .x = buffer_clips_5000_m_made_valid_erroring, 
    dist = 0
  )

# run with safely
safely_intersects_5000_m_0_buffered <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_0_buffered
) %>% 
  transpose()

save(
  safely_intersects_5000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_0_buffered.rdata"
    )
)

# run with possibly
possibly_intersects_5000_m_0_buffered <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_0_buffered
)

save(
  possibly_intersects_5000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_0_buffered.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_5000_m_0_buffered_true_false <- 
  possibly_intersects_5000_m_0_buffered %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_5000_m_0_buffered <- 
  possibly_intersects_5000_m_0_buffered %>% 
  subset(errors_5000_m_0_buffered_true_false)

# get the numbers of the tracts with errors
tract_ids_5000_m_0_buffered_erroring <- 
  names(errors_5000_m_0_buffered)

# select the actual tracts with errors
buffer_clips_5000_m_0_buffered_erroring <- 
  buffer_clips_5000_m_0_buffered[tract_ids_5000_m_0_buffered_erroring]

# select the error messages
error_messages_5000_m_0_buffered_erroring <- 
  safely_intersects_5000_m_0_buffered$error[tract_ids_5000_m_0_buffered_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_0_buffered_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_5000_m_made_valid_erroring, 
  error_messages_5000_m_made_valid_erroring, 
  buffintersector,
  buffer_clips_5000_m_0_buffered, 
  safely_intersects_5000_m_0_buffered, 
  possibly_intersects_5000_m_0_buffered, 
  errors_5000_m_0_buffered_true_false, 
  errors_5000_m_0_buffered,
  tract_ids_5000_m_0_buffered_erroring, 
  buffer_clips_5000_m_0_buffered_erroring, 
  error_messages_5000_m_0_buffered_erroring
)
  
# cleanup
invisible(gc())

```


```{r 7500 meters, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_made_valid_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_made_valid_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_7500_m_0_buffered <- 
  map(
    .f = st_buffer, 
    .x = buffer_clips_7500_m_made_valid_erroring, 
    dist = 0
  )

# run with safely
safely_intersects_7500_m_0_buffered <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_0_buffered
) %>% 
  transpose()

save(
  safely_intersects_7500_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_0_buffered.rdata"
    )
)

# run with possibly
possibly_intersects_7500_m_0_buffered <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_0_buffered
)

save(
  possibly_intersects_7500_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_0_buffered.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_7500_m_0_buffered_true_false <- 
  possibly_intersects_7500_m_0_buffered %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_7500_m_0_buffered <- 
  possibly_intersects_7500_m_0_buffered %>% 
  subset(errors_7500_m_0_buffered_true_false)

# get the numbers of the tracts with errors
tract_ids_7500_m_0_buffered_erroring <- 
  names(errors_7500_m_0_buffered)

# select the actual tracts with errors
buffer_clips_7500_m_0_buffered_erroring <- 
  buffer_clips_7500_m_0_buffered[tract_ids_7500_m_0_buffered_erroring]

# select the error messages
error_messages_7500_m_0_buffered_erroring <- 
  safely_intersects_7500_m_0_buffered$error[tract_ids_7500_m_0_buffered_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_0_buffered_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_7500_m_made_valid_erroring, 
  error_messages_7500_m_made_valid_erroring, 
  buffintersector,
  buffer_clips_7500_m_0_buffered, 
  safely_intersects_7500_m_0_buffered, 
  possibly_intersects_7500_m_0_buffered, 
  errors_7500_m_0_buffered_true_false, 
  errors_7500_m_0_buffered,
  tract_ids_7500_m_0_buffered_erroring, 
  buffer_clips_7500_m_0_buffered_erroring, 
  error_messages_7500_m_0_buffered_erroring
)
  
# cleanup
invisible(gc())

```


```{r 10000 meters, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_made_valid_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_made_valid_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_10000_m_0_buffered <- 
  map(
    .f = st_buffer, 
    .x = buffer_clips_10000_m_made_valid_erroring, 
    dist = 0
  )

# run with safely
safely_intersects_10000_m_0_buffered <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_0_buffered
) %>% 
  transpose()

save(
  safely_intersects_10000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_0_buffered.rdata"
    )
)

# run with possibly
possibly_intersects_10000_m_0_buffered <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_0_buffered
)

save(
  possibly_intersects_10000_m_0_buffered,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_0_buffered.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_10000_m_0_buffered_true_false <- 
  possibly_intersects_10000_m_0_buffered %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_10000_m_0_buffered <- 
  possibly_intersects_10000_m_0_buffered %>% 
  subset(errors_10000_m_0_buffered_true_false)

# get the numbers of the tracts with errors
tract_ids_10000_m_0_buffered_erroring <- 
  names(errors_10000_m_0_buffered)

# select the actual tracts with errors
buffer_clips_10000_m_0_buffered_erroring <- 
  buffer_clips_10000_m_0_buffered[tract_ids_10000_m_0_buffered_erroring]

# select the error messages
error_messages_10000_m_0_buffered_erroring <- 
  safely_intersects_10000_m_0_buffered$error[tract_ids_10000_m_0_buffered_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_0_buffered_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_0_buffered_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_10000_m_made_valid_erroring, 
  error_messages_10000_m_made_valid_erroring, 
  buffintersector,
  buffer_clips_10000_m_0_buffered, 
  safely_intersects_10000_m_0_buffered, 
  possibly_intersects_10000_m_0_buffered, 
  errors_10000_m_0_buffered_true_false, 
  errors_10000_m_0_buffered,
  tract_ids_10000_m_0_buffered_erroring, 
  buffer_clips_10000_m_0_buffered_erroring, 
  error_messages_10000_m_0_buffered_erroring
)
  
# cleanup
invisible(gc())

```


```{r load remaining errors no change, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_0_buffered_erroring.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_0_buffered_erroring.rdata"  # 2
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_0_buffered_erroring.rdata"  # 6
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_0_buffered_erroring.rdata"  # 14
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_0_buffered_erroring.rdata"  # 36
    )
)

```


##### try precision post-everything NO CHANGE

```{r 3000 meters, eval=FALSE, include=FALSE}

# load the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_0_buffered_erroring.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# set precision
buffer_clips_3000_m_val_buf_prec <- 
  map(
    .f = st_set_precision, 
    .x = buffer_clips_3000_m_0_buffered_erroring, 
    precision = 100000
  )

# run with safely
safely_intersects_3000_m_val_buf_prec <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_val_buf_prec
) %>% 
  transpose()

save(
  safely_intersects_3000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_val_buf_prec.rdata"
    )
)

# run with possibly
possibly_intersects_3000_m_val_buf_prec <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_val_buf_prec
)

save(
  possibly_intersects_3000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_val_buf_prec.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_3000_m_val_buf_prec_true_false <- 
  possibly_intersects_3000_m_val_buf_prec %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_3000_m_val_buf_prec <- 
  possibly_intersects_3000_m_val_buf_prec %>% 
  subset(errors_3000_m_val_buf_prec_true_false)

# get the numbers of the tracts with errors
tract_ids_3000_m_val_buf_prec_erroring <- 
  names(errors_3000_m_val_buf_prec)

# select the actual tracts with errors
buffer_clips_3000_m_val_buf_prec_erroring <- 
  buffer_clips_3000_m_val_buf_prec[tract_ids_3000_m_val_buf_prec_erroring]

# select the error messages
error_messages_3000_m_val_buf_prec_erroring <- 
  safely_intersects_3000_m_val_buf_prec$error[tract_ids_3000_m_val_buf_prec_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_val_buf_prec_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_val_buf_prec_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_3000_m_0_buffered_erroring, 
  error_messages_3000_m_0_buffered_erroring, 
  buffintersector,
  buffer_clips_3000_m_val_buf_prec, 
  safely_intersects_3000_m_val_buf_prec, 
  possibly_intersects_3000_m_val_buf_prec, 
  errors_3000_m_val_buf_prec_true_false, 
  errors_3000_m_val_buf_prec,
  tract_ids_3000_m_val_buf_prec_erroring, 
  buffer_clips_3000_m_val_buf_prec_erroring, 
  error_messages_3000_m_val_buf_prec_erroring
)
  
# cleanup
invisible(gc())

```


```{r 4000 meters, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_0_buffered_erroring.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# set precision
buffer_clips_4000_m_val_buf_prec <- 
  map(
    .f = st_set_precision, 
    .x = buffer_clips_4000_m_0_buffered_erroring, 
    precision = 100000
  )

# run with safely
safely_intersects_4000_m_val_buf_prec <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m_val_buf_prec
) %>% 
  transpose()

save(
  safely_intersects_4000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_val_buf_prec.rdata"
    )
)

# run with possibly
possibly_intersects_4000_m_val_buf_prec <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_val_buf_prec
)

save(
  possibly_intersects_4000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_val_buf_prec.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_4000_m_val_buf_prec_true_false <- 
  possibly_intersects_4000_m_val_buf_prec %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_4000_m_val_buf_prec <- 
  possibly_intersects_4000_m_val_buf_prec %>% 
  subset(errors_4000_m_val_buf_prec_true_false)

# get the numbers of the tracts with errors
tract_ids_4000_m_val_buf_prec_erroring <- 
  names(errors_4000_m_val_buf_prec)

# select the actual tracts with errors
buffer_clips_4000_m_val_buf_prec_erroring <- 
  buffer_clips_4000_m_val_buf_prec[tract_ids_4000_m_val_buf_prec_erroring]

# select the error messages
error_messages_4000_m_val_buf_prec_erroring <- 
  safely_intersects_4000_m_val_buf_prec$error[tract_ids_4000_m_val_buf_prec_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_val_buf_prec_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_val_buf_prec_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_4000_m_0_buffered_erroring, 
  error_messages_4000_m_0_buffered_erroring, 
  buffintersector,
  buffer_clips_4000_m_val_buf_prec, 
  safely_intersects_4000_m_val_buf_prec, 
  possibly_intersects_4000_m_val_buf_prec, 
  errors_4000_m_val_buf_prec_true_false, 
  errors_4000_m_val_buf_prec,
  tract_ids_4000_m_val_buf_prec_erroring, 
  buffer_clips_4000_m_val_buf_prec_erroring, 
  error_messages_4000_m_val_buf_prec_erroring
)
  
# cleanup
invisible(gc())

```


```{r 5000 meters, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_0_buffered_erroring.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# set precision
buffer_clips_5000_m_val_buf_prec <- 
  map(
    .f = st_set_precision, 
    .x = buffer_clips_5000_m_0_buffered_erroring, 
    precision = 100000
  )

# run with safely
safely_intersects_5000_m_val_buf_prec <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_val_buf_prec
) %>% 
  transpose()

save(
  safely_intersects_5000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_val_buf_prec.rdata"
    )
)

# run with possibly
possibly_intersects_5000_m_val_buf_prec <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_val_buf_prec
)

save(
  possibly_intersects_5000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_val_buf_prec.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_5000_m_val_buf_prec_true_false <- 
  possibly_intersects_5000_m_val_buf_prec %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_5000_m_val_buf_prec <- 
  possibly_intersects_5000_m_val_buf_prec %>% 
  subset(errors_5000_m_val_buf_prec_true_false)

# get the numbers of the tracts with errors
tract_ids_5000_m_val_buf_prec_erroring <- 
  names(errors_5000_m_val_buf_prec)

# select the actual tracts with errors
buffer_clips_5000_m_val_buf_prec_erroring <- 
  buffer_clips_5000_m_val_buf_prec[tract_ids_5000_m_val_buf_prec_erroring]

# select the error messages
error_messages_5000_m_val_buf_prec_erroring <- 
  safely_intersects_5000_m_val_buf_prec$error[tract_ids_5000_m_val_buf_prec_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_val_buf_prec_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_val_buf_prec_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_5000_m_0_buffered_erroring, 
  error_messages_5000_m_0_buffered_erroring, 
  buffintersector,
  buffer_clips_5000_m_val_buf_prec, 
  safely_intersects_5000_m_val_buf_prec, 
  possibly_intersects_5000_m_val_buf_prec, 
  errors_5000_m_val_buf_prec_true_false, 
  errors_5000_m_val_buf_prec,
  tract_ids_5000_m_val_buf_prec_erroring, 
  buffer_clips_5000_m_val_buf_prec_erroring, 
  error_messages_5000_m_val_buf_prec_erroring
)
  
# cleanup
invisible(gc())

```


```{r 7500 meters, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_0_buffered_erroring.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# set precision
buffer_clips_7500_m_val_buf_prec <- 
  map(
    .f = st_set_precision, 
    .x = buffer_clips_7500_m_0_buffered_erroring, 
    precision = 100000
  )

# run with safely
safely_intersects_7500_m_val_buf_prec <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_val_buf_prec
) %>% 
  transpose()

save(
  safely_intersects_7500_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_val_buf_prec.rdata"
    )
)

# run with possibly
possibly_intersects_7500_m_val_buf_prec <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_val_buf_prec
)

save(
  possibly_intersects_7500_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_val_buf_prec.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_7500_m_val_buf_prec_true_false <- 
  possibly_intersects_7500_m_val_buf_prec %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_7500_m_val_buf_prec <- 
  possibly_intersects_7500_m_val_buf_prec %>% 
  subset(errors_7500_m_val_buf_prec_true_false)

# get the numbers of the tracts with errors
tract_ids_7500_m_val_buf_prec_erroring <- 
  names(errors_7500_m_val_buf_prec)

# select the actual tracts with errors
buffer_clips_7500_m_val_buf_prec_erroring <- 
  buffer_clips_7500_m_val_buf_prec[tract_ids_7500_m_val_buf_prec_erroring]

# select the error messages
error_messages_7500_m_val_buf_prec_erroring <- 
  safely_intersects_7500_m_val_buf_prec$error[tract_ids_7500_m_val_buf_prec_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_val_buf_prec_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_val_buf_prec_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_7500_m_0_buffered_erroring, 
  error_messages_7500_m_0_buffered_erroring, 
  buffintersector,
  buffer_clips_7500_m_val_buf_prec, 
  safely_intersects_7500_m_val_buf_prec, 
  possibly_intersects_7500_m_val_buf_prec, 
  errors_7500_m_val_buf_prec_true_false, 
  errors_7500_m_val_buf_prec,
  tract_ids_7500_m_val_buf_prec_erroring, 
  buffer_clips_7500_m_val_buf_prec_erroring, 
  error_messages_7500_m_val_buf_prec_erroring
)
  
# cleanup
invisible(gc())

```


```{r 10000 meters, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_0_buffered_erroring.rdata"
    )
)

# save the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_0_buffered_erroring.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# set precision
buffer_clips_10000_m_val_buf_prec <- 
  map(
    .f = st_set_precision, 
    .x = buffer_clips_10000_m_0_buffered_erroring, 
    precision = 100000
  )

# run with safely
safely_intersects_10000_m_val_buf_prec <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_val_buf_prec
) %>% 
  transpose()

save(
  safely_intersects_10000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_val_buf_prec.rdata"
    )
)

# run with possibly
possibly_intersects_10000_m_val_buf_prec <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_val_buf_prec
)

save(
  possibly_intersects_10000_m_val_buf_prec,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_val_buf_prec.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_10000_m_val_buf_prec_true_false <- 
  possibly_intersects_10000_m_val_buf_prec %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_10000_m_val_buf_prec <- 
  possibly_intersects_10000_m_val_buf_prec %>% 
  subset(errors_10000_m_val_buf_prec_true_false)

# get the numbers of the tracts with errors
tract_ids_10000_m_val_buf_prec_erroring <- 
  names(errors_10000_m_val_buf_prec)

# select the actual tracts with errors
buffer_clips_10000_m_val_buf_prec_erroring <- 
  buffer_clips_10000_m_val_buf_prec[tract_ids_10000_m_val_buf_prec_erroring]

# select the error messages
error_messages_10000_m_val_buf_prec_erroring <- 
  safely_intersects_10000_m_val_buf_prec$error[tract_ids_10000_m_val_buf_prec_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_val_buf_prec_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_val_buf_prec_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_val_buf_prec_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_10000_m_0_buffered_erroring, 
  error_messages_10000_m_0_buffered_erroring, 
  buffintersector,
  buffer_clips_10000_m_val_buf_prec, 
  safely_intersects_10000_m_val_buf_prec, 
  possibly_intersects_10000_m_val_buf_prec, 
  errors_10000_m_val_buf_prec_true_false, 
  errors_10000_m_val_buf_prec,
  tract_ids_10000_m_val_buf_prec_erroring, 
  buffer_clips_10000_m_val_buf_prec_erroring, 
  error_messages_10000_m_val_buf_prec_erroring
)
  
# cleanup
invisible(gc())

```


```{r load remaining errors no change, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_val_buf_prec_erroring.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_val_buf_prec_erroring.rdata"  # 2
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_val_buf_prec_erroring.rdata"  # 6
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_val_buf_prec_erroring.rdata"  # 14
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_val_buf_prec_erroring.rdata"  # 36
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_val_buf_prec_erroring.rdata"
    )
)

```


```{r try fixing the intersector function, eval=FALSE, include=FALSE}

buffintersector_prec_100000_valid <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_set_precision(100000) %>% 
        st_make_valid() %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }

save(
  buffintersector_prec_100000_valid, 
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
    )
)

```


#### buffintersector precision then validate sequence NO CHANGE

```{r use buffintersector_prec_100000_valid for 3-km buffers, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_val_buf_prec_erroring.rdata"
    )
)

# load the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_val_buf_prec_erroring.rdata"
    )
)

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
    )
)

# run with safely
safely_intersects_3000_m_buffintersector_revised <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_3000_m_val_buf_prec_erroring
) %>% 
  transpose()

save(
  safely_intersects_3000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_buffintersector_revised.rdata"
    )
)

# run with possibly
possibly_intersects_3000_m_buffintersector_revised <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_val_buf_prec_erroring
)

save(
  possibly_intersects_3000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_buffintersector_revised.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_3000_m_buffintersector_revised_true_false <- 
  possibly_intersects_3000_m_buffintersector_revised %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_3000_m_buffintersector_revised <- 
  possibly_intersects_3000_m_buffintersector_revised %>% 
  subset(errors_3000_m_buffintersector_revised_true_false)

# get the numbers of the tracts with errors
tract_ids_3000_m_buffintersector_revised_erroring <- 
  names(errors_3000_m_buffintersector_revised)

# select the actual tracts with errors
buffer_clips_3000_m_buffintersector_revised_erroring <- 
  buffer_clips_3000_m_val_buf_prec_erroring[tract_ids_3000_m_buffintersector_revised_erroring]

# select the error messages
error_messages_3000_m_buffintersector_revised_erroring <- 
  safely_intersects_3000_m_buffintersector_revised$error[tract_ids_3000_m_buffintersector_revised_erroring]

# save the tract ids throwing errors
save(
  tract_ids_3000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_buffintersector_revised_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_3000_m_val_buf_prec_erroring, 
  error_messages_3000_m_val_buf_prec_erroring, 
  buffintersector_prec_100000_valid,
  safely_intersects_3000_m_buffintersector_revised, 
  possibly_intersects_3000_m_buffintersector_revised, 
  errors_3000_m_buffintersector_revised_true_false, 
  errors_3000_m_buffintersector_revised,
  tract_ids_3000_m_buffintersector_revised_erroring, 
  buffer_clips_3000_m_buffintersector_revised_erroring, 
  error_messages_3000_m_buffintersector_revised_erroring
)
  
# cleanup
invisible(gc())

```


```{r use buffintersector_prec_100000_valid for 4-km buffers, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_val_buf_prec_erroring.rdata"
    )
)

# load the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_val_buf_prec_erroring.rdata"
    )
)

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
    )
)

# run with safely
safely_intersects_4000_m_buffintersector_revised <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_4000_m_val_buf_prec_erroring
) %>% 
  transpose()

save(
  safely_intersects_4000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_buffintersector_revised.rdata"
    )
)

# run with possibly
possibly_intersects_4000_m_buffintersector_revised <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_val_buf_prec_erroring
)

save(
  possibly_intersects_4000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_buffintersector_revised.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_4000_m_buffintersector_revised_true_false <- 
  possibly_intersects_4000_m_buffintersector_revised %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_4000_m_buffintersector_revised <- 
  possibly_intersects_4000_m_buffintersector_revised %>% 
  subset(errors_4000_m_buffintersector_revised_true_false)

# get the numbers of the tracts with errors
tract_ids_4000_m_buffintersector_revised_erroring <- 
  names(errors_4000_m_buffintersector_revised)

# select the actual tracts with errors
buffer_clips_4000_m_buffintersector_revised_erroring <- 
  buffer_clips_4000_m_val_buf_prec_erroring[tract_ids_4000_m_buffintersector_revised_erroring]

# select the error messages
error_messages_4000_m_buffintersector_revised_erroring <- 
  safely_intersects_4000_m_buffintersector_revised$error[tract_ids_4000_m_buffintersector_revised_erroring]

# save the tract ids throwing errors
save(
  tract_ids_4000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_4000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_buffintersector_revised_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_4000_m_val_buf_prec_erroring, 
  error_messages_4000_m_val_buf_prec_erroring, 
  buffintersector_prec_100000_valid,
  safely_intersects_4000_m_buffintersector_revised, 
  possibly_intersects_4000_m_buffintersector_revised, 
  errors_4000_m_buffintersector_revised_true_false, 
  errors_4000_m_buffintersector_revised,
  tract_ids_4000_m_buffintersector_revised_erroring, 
  buffer_clips_4000_m_buffintersector_revised_erroring, 
  error_messages_4000_m_buffintersector_revised_erroring
)
  
# cleanup
invisible(gc())

```


```{r use buffintersector_prec_100000_valid for 5-km buffers, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_val_buf_prec_erroring.rdata"
    )
)

# load the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_val_buf_prec_erroring.rdata"
    )
)

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
    )
)

# run with safely
safely_intersects_5000_m_buffintersector_revised <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_5000_m_val_buf_prec_erroring
) %>% 
  transpose()

save(
  safely_intersects_5000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_buffintersector_revised.rdata"
    )
)

# run with possibly
possibly_intersects_5000_m_buffintersector_revised <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_val_buf_prec_erroring
)

save(
  possibly_intersects_5000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_buffintersector_revised.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_5000_m_buffintersector_revised_true_false <- 
  possibly_intersects_5000_m_buffintersector_revised %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_5000_m_buffintersector_revised <- 
  possibly_intersects_5000_m_buffintersector_revised %>% 
  subset(errors_5000_m_buffintersector_revised_true_false)

# get the numbers of the tracts with errors
tract_ids_5000_m_buffintersector_revised_erroring <- 
  names(errors_5000_m_buffintersector_revised)

# select the actual tracts with errors
buffer_clips_5000_m_buffintersector_revised_erroring <- 
  buffer_clips_5000_m_val_buf_prec_erroring[tract_ids_5000_m_buffintersector_revised_erroring]

# select the error messages
error_messages_5000_m_buffintersector_revised_erroring <- 
  safely_intersects_5000_m_buffintersector_revised$error[tract_ids_5000_m_buffintersector_revised_erroring]

# save the tract ids throwing errors
save(
  tract_ids_5000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_buffintersector_revised_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_5000_m_val_buf_prec_erroring, 
  error_messages_5000_m_val_buf_prec_erroring, 
  buffintersector_prec_100000_valid,
  safely_intersects_5000_m_buffintersector_revised, 
  possibly_intersects_5000_m_buffintersector_revised, 
  errors_5000_m_buffintersector_revised_true_false, 
  errors_5000_m_buffintersector_revised,
  tract_ids_5000_m_buffintersector_revised_erroring, 
  buffer_clips_5000_m_buffintersector_revised_erroring, 
  error_messages_5000_m_buffintersector_revised_erroring
)
  
# cleanup
invisible(gc())

```


```{r use buffintersector_prec_100000_valid for 7.5-km buffers, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_val_buf_prec_erroring.rdata"
    )
)

# load the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_val_buf_prec_erroring.rdata"
    )
)

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
    )
)

# run with safely
safely_intersects_7500_m_buffintersector_revised <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_7500_m_val_buf_prec_erroring
) %>% 
  transpose()

save(
  safely_intersects_7500_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_buffintersector_revised.rdata"
    )
)

# run with possibly
possibly_intersects_7500_m_buffintersector_revised <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_val_buf_prec_erroring
)

save(
  possibly_intersects_7500_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_buffintersector_revised.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_7500_m_buffintersector_revised_true_false <- 
  possibly_intersects_7500_m_buffintersector_revised %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_7500_m_buffintersector_revised <- 
  possibly_intersects_7500_m_buffintersector_revised %>% 
  subset(errors_7500_m_buffintersector_revised_true_false)

# get the numbers of the tracts with errors
tract_ids_7500_m_buffintersector_revised_erroring <- 
  names(errors_7500_m_buffintersector_revised)

# select the actual tracts with errors
buffer_clips_7500_m_buffintersector_revised_erroring <- 
  buffer_clips_7500_m_val_buf_prec_erroring[tract_ids_7500_m_buffintersector_revised_erroring]

# select the error messages
error_messages_7500_m_buffintersector_revised_erroring <- 
  safely_intersects_7500_m_buffintersector_revised$error[tract_ids_7500_m_buffintersector_revised_erroring]

# save the tract ids throwing errors
save(
  tract_ids_7500_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_buffintersector_revised_erroring.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_buffintersector_revised_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_buffintersector_revised_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_7500_m_val_buf_prec_erroring, 
  error_messages_7500_m_val_buf_prec_erroring, 
  buffintersector_prec_100000_valid,
  safely_intersects_7500_m_buffintersector_revised, 
  possibly_intersects_7500_m_buffintersector_revised, 
  errors_7500_m_buffintersector_revised_true_false, 
  errors_7500_m_buffintersector_revised,
  tract_ids_7500_m_buffintersector_revised_erroring, 
  buffer_clips_7500_m_buffintersector_revised_erroring, 
  error_messages_7500_m_buffintersector_revised_erroring
)
  
# cleanup
invisible(gc())

```


```{r use buffintersector_prec_100000_valid for 10-km buffers, eval=FALSE, include=FALSE}

# save the tracts with clipped buffers throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_val_buf_prec_erroring.rdata"
    )
)

# load the error messages
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_val_buf_prec_erroring.rdata"
    )
)

# load buffintersector_prec_100000_valid function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector_prec_100000_valid.rdata"
    )
)

# run with safely
safely_intersects_10000_m_buffintersector_revised <- 
  map(
  .f = safely(buffintersector_prec_100000_valid), 
  .x = buffer_clips_10000_m_val_buf_prec_erroring
) %>% 
  transpose()

save(
  safely_intersects_10000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_buffintersector_revised.rdata"
    )
)

# run with possibly
possibly_intersects_10000_m_buffintersector_revised <- 
  map(
  .f = possibly(buffintersector_prec_100000_valid, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_val_buf_prec_erroring
)

save(
  possibly_intersects_10000_m_buffintersector_revised,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_buffintersector_revised.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_10000_m_buffintersector_revised_true_false <- 
  possibly_intersects_10000_m_buffintersector_revised %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_10000_m_buffintersector_revised <- 
  possibly_intersects_10000_m_buffintersector_revised %>% 
  subset(errors_10000_m_buffintersector_revised_true_false)

# get the numbers of the tracts with errors
tract_ids_10000_m_buffintersector_revised_erroring <- 
  names(errors_10000_m_buffintersector_revised)

# select the actual tracts with errors
buffer_clips_10000_m_buffintersector_revised_erroring <- 
  buffer_clips_10000_m_val_buf_prec_erroring[tract_ids_10000_m_buffintersector_revised_erroring]

# select the error messages
error_messages_10000_m_buffintersector_revised_erroring <- 
  safely_intersects_10000_m_buffintersector_revised$error[tract_ids_10000_m_buffintersector_revised_erroring]

# save the tract ids throwing errors
save(
  tract_ids_10000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_buffintersector_revised_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_buffintersector_revised_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_buffintersector_revised_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_10000_m_val_buf_prec_erroring, 
  error_messages_10000_m_val_buf_prec_erroring, 
  buffintersector_prec_100000_valid,
  safely_intersects_10000_m_buffintersector_revised, 
  possibly_intersects_10000_m_buffintersector_revised, 
  errors_10000_m_buffintersector_revised_true_false, 
  errors_10000_m_buffintersector_revised,
  tract_ids_10000_m_buffintersector_revised_erroring, 
  buffer_clips_10000_m_buffintersector_revised_erroring, 
  error_messages_10000_m_buffintersector_revised_erroring
)
  
# cleanup
invisible(gc())

```




```{r make alabama small sample dataset}

# figuring out some testing tracts

# isolate alabama tracts
state_01_tracts <- 
  projected_tracts %>% 
  filter(str_detect(geoid10, "^01.*"))

# isolate alabama buffers
buffers_1000_m_01_tracts <- 
  buffers$buffer_1000_m %>% 
  filter(str_detect(monitor_id, "^01.*"))

# # the below makes an interactive map for manual tract-hunting in AL
# library(mapview)
# library(leaflet)
# mapView(state_01_tracts) +
#   mapView(buffers_1000_m_01_tracts)

# alabama monitor id for testing: "01-121-0002"
# tract for testing: "01121011300" 

# extract one tract and simplify it
one_tract_no_intersect_02270000100 <-
  projected_tracts %>%
  filter(geoid10 == "02270000100") %>%
  select(geoid10) %>% 
  st_cast("POLYGON")

one_tract_yes_intersect_01121011300 <- 
  projected_tracts %>%
  filter(geoid10 == "01121011300") %>%
  select(geoid10) %>% 
  st_cast("POLYGON")

# check if any intersections exist (this should have none)
intersect_check_nope <-
  one_buffer_size %>%
  st_intersects(one_tract_no_intersect_02270000100, .) %>% 
  pluck(1) # the index of the intersecting buffer as an integer

# check if any intersections exist (this should have one)
intersect_check_yup <-
  one_buffer_size %>%
  st_intersects(one_tract_yes_intersect_01121011300, .) %>% 
  pluck(1)  # the index of the intersecting buffer as an integer

# now we need to get the rows that match these indices

# isolate alabama tracts
al_tracts <- 
  projected_tracts %>% 
  filter(str_detect(geoid10, "^01.*"))

# isolate simple polygon alabama tracts
al_tracts_simple <- 
  projected_tracts_simple %>% 
  filter(str_detect(geoid10, "^01.*"))

# isolate alabama buffers
buffers_1000_m_01_al <- 
  buffers$buffer_1000_m %>% 
  filter(str_detect(monitor_id, "^01.*"))

save(
  al_tracts, 
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts.rdata"
    )
)

save(
  al_tracts_simple, 
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts_simple.rdata"
    )
)

save(
  buffers_1000_m_01_al, 
  file = 
    file.path(
      "intermediate_data", 
      "buffers_1000_m_01_al.rdata"
    )
)





# # load buffclipper_precheck_intersect function
# load(
#   file = 
#     file.path(
#       "functions", 
#       "buffclipper_precheck_intersect.rdata"
#     )
# )
# 
# # get list of tract geoids
# al_tracts_simple_geoid_characters <- 
#   al_tracts_simple %>% 
#   pull(geoid10)
# 
# # load tictoc
# library(tictoc)
# 
# # # apply buffer function for all tracts for 1000-meter buffer (TIME SUCK)
# # tic("not parallel")
# # al_buffer_clips_1000_m <-
# #   map(
# #     .f = buffclipper_precheck_intersect,
# #     .x = al_tracts_simple_geoid_characters,
# #     buffer_sf = buffers_1000_m_01_al,
# #     tract_sf = al_tracts_simple
# #   )
# # toc()
# # 
# # tic("parallel")
# # 
# # par_al_buffer_clips_1000_m <-
# #   future_map(
# #     .f = buffclipper_precheck_intersect,
# #     .x = al_tracts_simple_geoid_characters,
# #     buffer_sf = buffers_1000_m_01_al,
# #     tract_sf = al_tracts_simple, 
# #     .progress = TRUE
# #   )
# # toc()
# #
# # # name the sfs
# # names(al_buffer_clips_1000_m) <- 
# #   al_tracts_simple_geoid_characters
# # 
# # # save the result
# # save(
# #   al_buffer_clips_1000_m,
# #   file =
# #     file.path(
# #       "intermediate_data",
# #       "al_buffer_clips_1000_m.rdata"
# #       )
# #   )
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# buffclipper_precheck_intersect <-
#   function(tract_geoid_as_character,
#            buffer_sf,
#            tract_sf) {
# 
#     # extract one buffer layer and simplify it
#     one_buffer_size <-
#       buffer_sf %>%
#       select(monitor_id)
# 
#     # extract one tract and simplify it
#     one_tract <-
#       tract_sf %>%
#       filter(geoid10 == tract_geoid_as_character) %>%
#       select(geoid10)
# 
#     # check if any intersections exist
#     intersect_check <-
#       one_buffer_size %>%
#       st_intersects(one_tract, .) %>%
#       pluck(1)
#     
#     if(is.null(intersect_check)) {
#       null_tibble <-
#         tibble(geoid10 = tract_geoid_as_character,
#                n.overlaps = as.integer(0),
#                origins = as.integer(0),
#                area = as.numeric(0),
#                monitor_id_overlaps = "none",
#                geometry = "none")
# 
#       return(null_tibble)
#       
#     } else {
# 
#       # clip buffers to only the one tract
#       buffers_in_tract <-
#         one_buffer_size %>%
#         st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
#         rowid_to_column("polygon_id")  # add row numbers to id polygons in next step
# 
#       return(buffers_in_tract)
# 
#     }
#   }
# 
# # save the function to disk
# save(
#   buffclipper_precheck_intersect,
#   file =
#     file.path(
#       "functions",
#       "buffclipper_precheck_intersect.rdata"
#     )
# )
# 



 buffers_in_tract <-
        one_buffer_size %>%
        st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
        rowid_to_column("polygon_id")  # add row numbers to id polygons in next step

)

buffclipper_precheck_intersect <-
  function(tract_geoid_as_character,
           buffer_sf,
           tract_sf) {

    # extract one buffer layer and simplify it
    one_buffer_size <-
      buffer_sf %>%
      select(monitor_id)

    # extract one tract and simplify it
    one_tract <-
      tract_sf %>%
      filter(geoid10 == tract_geoid_as_character) %>%
      select(geoid10)

    # check if any intersections exist
    intersect_check <-
      one_buffer_size %>%
      st_intersects(one_tract, .) %>%
      pluck(1)

    if(is.null(intersect_check)) {
      null_tibble <-
        tibble(geoid10 = tract_geoid_as_character,
               n.overlaps = as.integer(0),
               origins = as.integer(0),
               area = as.numeric(0),
               monitor_id_overlaps = "none",
               geometry = "none")

      return(null_tibble)

    } else {

      # clip buffers to only the one tract
      buffers_in_tract <-
        one_buffer_size %>%
        st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
        rowid_to_column("polygon_id")  # add row numbers to id polygons in next step

      return(buffers_in_tract)

    }
  }




```



```{r simple buffclipper for debugging}

buffclipper <- 
  function(tract_geoid_as_character, 
           buffer_sf, 
           tract_sf) {
    
    # extract one buffer layer and simplify it
    one_buffer_size <- 
      buffer_sf %>% 
      select(monitor_id)
    
    # extract one tract and simplify it
    one_tract <- 
      tract_sf %>% 
      filter(geoid10 == tract_geoid_as_character) %>% 
      select(geoid10) 
    
    # clip buffers to only the one tract
    buffers_in_tract <- 
      one_buffer_size %>% 
      st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
      rowid_to_column("polygon_id")  # add row numbers to id polygons in next step
    
    # check if nrow from the above is zero, and if so, make a tibble and return it
    if(nrow(buffers_in_tract) == 0) {
      null_tibble <- 
        tibble(geoid10 = tract_geoid_as_character, 
               n.overlaps = as.integer(0), 
               origins = as.integer(0), 
               area = as.numeric(0), 
               monitor_id_overlaps = "none", 
               geometry = "none")

      return(null_tibble)
      
    } else {
      
      return(buffers_in_tract)
    
    }
  }
 
# save the function to disk
save(
  buffclipper, 
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# remove all objects from the environment
rm(list = ls(all.names = TRUE))

```


#### initial runs

##### 1000 meters

```{r apply buffintersector to 1000-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 1000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_1000_m.rdata"
    )
)

# do 1000-meter file
safely_intersects_1000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_1000_m
) %>% 
  transpose()

save(
  safely_intersects_1000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_1000_m.rdata"
    )
)

rm(buffer_clips_1000_m, 
   safely_intersects_1000_m)
invisible(gc())

```


```{r apply buffintersector to 1000-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 1000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_1000_m.rdata"
    )
)

# do 1000-m file
possibly_intersects_1000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_1000_m
)

save(
  possibly_intersects_1000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_1000_m.rdata"
    )
)

rm(buffer_clips_1000_m, 
   possibly_intersects_1000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 1000-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_1000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_1000_m_true_false <- 
  possibly_intersects_1000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_1000_m <- 
  possibly_intersects_1000_m %>% 
  subset(errors_1000_m_true_false)

# save the errors
save(
  errors_1000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_1000_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 1000-meter, eval=FALSE, include=FALSE}

# load the 1000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_1000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_1000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_1000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_1000_m_errors <- 
  names(errors_1000_m)

# select the actual tracts with errors
buffer_clips_1000_m_throwing_errors <- 
  buffer_clips_1000_m[tract_ids_1000_m_errors]

# select the error messages
error_messages_1000_m <- 
  safely_intersects_1000_m$error[tract_ids_1000_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_1000_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_1000_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_1000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_1000_m.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_1000_m,
  errors_1000_m,
  safely_intersects_1000_m,
  tract_ids_1000_m_errors,
  buffer_clips_1000_m_throwing_errors, 
  error_messages_1000_m
)

# clear working memory
gc()

```


##### 2000 meters

```{r apply buffintersector to 2000-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 2000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_2000_m.rdata"
    )
)

# do 2000-meter file
safely_intersects_2000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2000_m
) %>% 
  transpose()

save(
  safely_intersects_2000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2000_m.rdata"
    )
)

rm(buffer_clips_2000_m, 
   safely_intersects_2000_m)
invisible(gc())

```


```{r apply buffintersector to 2000-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 2000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m.rdata"
    )
)

# do 2000-m file
possibly_intersects_2000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2000_m
)

save(
  possibly_intersects_2000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2000_m.rdata"
    )
)

rm(buffer_clips_2000_m, 
   possibly_intersects_2000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 2000-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_2000_m_true_false <- 
  possibly_intersects_2000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_2000_m <- 
  possibly_intersects_2000_m %>% 
  subset(errors_2000_m_true_false)

# save the errors
save(
  errors_2000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_2000_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 2000-meter, eval=FALSE, include=FALSE}

# load the 2000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_2000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_2000_m_errors <- 
  names(errors_2000_m)

# select the actual tracts with errors
buffer_clips_2000_m_throwing_errors <- 
  buffer_clips_2000_m[tract_ids_2000_m_errors]

# select the error messages
error_messages_2000_m <- 
  safely_intersects_2000_m$error[tract_ids_2000_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_2000_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_2000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m.rdata"
    )
)

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_2000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffer_clips_2000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

# remove files from memory
rm(
  buffer_clips_2000_m,
  errors_2000_m,
  safely_intersects_2000_m,
  tract_ids_2000_m_errors,
  buffer_clips_2000_m_throwing_errors, 
  error_messages_2000_m
)

# clear working memory
gc()

```


##### 2500 meters big

```{r apply buffintersector to 2500-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 2500-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_2500_m.rdata"
    )
)

# do 2500-meter file
safely_intersects_2500_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2500_m
) %>% 
  transpose()

save(
  safely_intersects_2500_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2500_m.rdata"
    )
)

rm(buffer_clips_2500_m, 
   safely_intersects_2500_m)
invisible(gc())

```


```{r apply buffintersector to 2500-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 2500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m.rdata"
    )
)

# do 2500-m file
possibly_intersects_2500_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2500_m
)

save(
  possibly_intersects_2500_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2500_m.rdata"
    )
)

rm(buffer_clips_2500_m, 
   possibly_intersects_2500_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 2500-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2500_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_2500_m_true_false <- 
  possibly_intersects_2500_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_2500_m <- 
  possibly_intersects_2500_m %>% 
  subset(errors_2500_m_true_false)

# save the errors
save(
  errors_2500_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_2500_m.rdata"
    )
)

rm(possibly_intersects_2500_m, 
   errors_2500_m_true_false, 
   errors_2500_m)

invisible(gc())

```


```{r isolate error cases buffintersector 2500-meter, eval=FALSE, include=FALSE}

# load the 2500-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_2500_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2500_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_2500_m_errors <- 
  names(errors_2500_m)

# select the actual tracts with errors
buffer_clips_2500_m_throwing_errors <- 
  buffer_clips_2500_m[tract_ids_2500_m_errors]

# select the error messages
error_messages_2500_m <- 
  safely_intersects_2500_m$error[tract_ids_2500_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_2500_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_2500_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m.rdata"
    )
)

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_2500_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffer_clips_2500_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

# remove files from memory
rm(
  buffer_clips_2500_m,
  errors_2500_m,
  safely_intersects_2500_m,
  tract_ids_2500_m_errors,
  buffer_clips_2500_m_throwing_errors, 
  error_messages_2500_m
)

# clear working memory
gc()

```


##### 3000 meters

```{r apply buffintersector to 3000-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m.rdata"
    )
)

# do 3000-meter file
safely_intersects_3000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m
) %>% 
  transpose()

save(
  safely_intersects_3000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m.rdata"
    )
)

rm(buffer_clips_3000_m, 
   safely_intersects_3000_m)
invisible(gc())

```


```{r apply buffintersector to 3000-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m.rdata"
    )
)

# do 3000-m file
possibly_intersects_3000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m
)

save(
  possibly_intersects_3000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m.rdata"
    )
)

rm(buffer_clips_3000_m, 
   possibly_intersects_3000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 3000-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_3000_m_true_false <- 
  possibly_intersects_3000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_3000_m <- 
  possibly_intersects_3000_m %>% 
  subset(errors_3000_m_true_false)

# save the errors
save(
  errors_3000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 3000-meter, eval=FALSE, include=FALSE}

# load the 3000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_3000_m_errors <- 
  names(errors_3000_m)

# select the actual tracts with errors
buffer_clips_3000_m_throwing_errors <- 
  buffer_clips_3000_m[tract_ids_3000_m_errors]

# select the error messages
error_messages_3000_m <- 
  safely_intersects_3000_m$error[tract_ids_3000_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m.rdata"
    )
)

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_3000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffer_clips_3000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

# remove files from memory
rm(
  buffer_clips_3000_m,
  errors_3000_m,
  safely_intersects_3000_m,
  tract_ids_3000_m_errors,
  buffer_clips_3000_m_throwing_errors, 
  error_messages_3000_m
)

# clear working memory
gc()

```


##### 4000 meters big

```{r apply buffintersector to 4000-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 4000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_4000_m.rdata"
    )
)

# do 4000-meter file
safely_intersects_4000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m
) %>% 
  transpose()

save(
  safely_intersects_4000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m.rdata"
    )
)

rm(buffer_clips_4000_m, 
   safely_intersects_4000_m)
invisible(gc())

```


```{r apply buffintersector to 4000-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 4000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m.rdata"
    )
)

# do 4000-m file
possibly_intersects_4000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m
)

save(
  possibly_intersects_4000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m.rdata"
    )
)

rm(buffer_clips_4000_m, 
   possibly_intersects_4000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 4000-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_4000_m_true_false <- 
  possibly_intersects_4000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_4000_m <- 
  possibly_intersects_4000_m %>% 
  subset(errors_4000_m_true_false)

# save the errors
save(
  errors_4000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_4000_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 4000-meter, eval=FALSE, include=FALSE}

# load the 4000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_4000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_4000_m_errors <- 
  names(errors_4000_m)

# select the actual tracts with errors
buffer_clips_4000_m_throwing_errors <- 
  buffer_clips_4000_m[tract_ids_4000_m_errors]

# select the error messages
error_messages_4000_m <- 
  safely_intersects_4000_m$error[tract_ids_4000_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m.rdata"
    )
)

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_4000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffer_clips_4000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

# remove files from memory
rm(
  buffer_clips_4000_m,
  errors_4000_m,
  safely_intersects_4000_m,
  tract_ids_4000_m_errors,
  buffer_clips_4000_m_throwing_errors, 
  error_messages_4000_m
)

# clear working memory
gc()

```


##### 5000 meters big

```{r apply buffintersector to 5000-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m.rdata"
    )
)

# do 5000-meter file
safely_intersects_5000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m
) %>% 
  transpose()

save(
  safely_intersects_5000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m.rdata"
    )
)

rm(buffer_clips_5000_m, 
   safely_intersects_5000_m)
invisible(gc())

```


```{r apply buffintersector to 5000-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m.rdata"
    )
)

# do 5000-m file
possibly_intersects_5000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m
)

save(
  possibly_intersects_5000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m.rdata"
    )
)

rm(buffer_clips_5000_m, 
   possibly_intersects_5000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 5000-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_5000_m_true_false <- 
  possibly_intersects_5000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_5000_m <- 
  possibly_intersects_5000_m %>% 
  subset(errors_5000_m_true_false)

# save the errors
save(
  errors_5000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 5000-meter, eval=FALSE, include=FALSE}

# load the 5000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_5000_m_errors <- 
  names(errors_5000_m)

# select the actual tracts with errors
buffer_clips_5000_m_throwing_errors <- 
  buffer_clips_5000_m[tract_ids_5000_m_errors]

# select the error messages
error_messages_5000_m <- 
  safely_intersects_5000_m$error[tract_ids_5000_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m.rdata"
    )
)

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_5000_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffer_clips_5000_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

# remove files from memory
rm(
  buffer_clips_5000_m,
  errors_5000_m,
  safely_intersects_5000_m,
  tract_ids_5000_m_errors,
  buffer_clips_5000_m_throwing_errors, 
  error_messages_5000_m
)

# clear working memory
gc()

```


##### 7500 meters big

```{r apply buffintersector to 7500-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m.rdata"
    )
)

# do 7500-meter file
safely_intersects_7500_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m
) %>% 
  transpose()

save(
  safely_intersects_7500_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m.rdata"
    )
)

rm(buffer_clips_7500_m, 
   safely_intersects_7500_m)
invisible(gc())

```


```{r apply buffintersector to 7500-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m.rdata"
    )
)

# do 7500-m file
possibly_intersects_7500_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m
)

save(
  possibly_intersects_7500_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m.rdata"
    )
)

rm(buffer_clips_7500_m, 
   possibly_intersects_7500_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 7500-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_7500_m_true_false <- 
  possibly_intersects_7500_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_7500_m <- 
  possibly_intersects_7500_m %>% 
  subset(errors_7500_m_true_false)

# save the errors
save(
  errors_7500_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 7500-meter, eval=FALSE, include=FALSE}

# load the 7500-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_7500_m_errors <- 
  names(errors_7500_m)

# select the actual tracts with errors
buffer_clips_7500_m_throwing_errors <- 
  buffer_clips_7500_m[tract_ids_7500_m_errors]

# select the error messages
error_messages_7500_m <- 
  safely_intersects_7500_m$error[tract_ids_7500_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m.rdata"
    )
)

# # isolate one error message
# check_one_case_error_message <- 
#   error_messages_7500_m$`04013109801`
# 
# # isolate one tract with errors
# check_one_case <- 
#   buffer_clips_7500_m_throwing_errors$`04013109801`
# 
# buffer_fix <- 
#   st_buffer(check_one_case, 0)
# 
# precision_fix <- 
#   st_set_precision(check_one_case, 1000)
# 
# # map the case
# mapview::mapView(check_one_case, native.crs = TRUE)
# 
# buffer_thing <- 
#   buffintersector(precision_fix)

# remove files from memory
rm(
  buffer_clips_7500_m,
  errors_7500_m,
  safely_intersects_7500_m,
  tract_ids_7500_m_errors,
  buffer_clips_7500_m_throwing_errors, 
  error_messages_7500_m
)

# clear working memory
gc()

```


##### 10000 meters big

```{r apply buffintersector to 10000-meter buffers using safely, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-meter file
safely_intersects_10000_m <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m
) %>% 
  transpose()

save(
  safely_intersects_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   safely_intersects_10000_m)
invisible(gc())

```


```{r apply buffintersector to 10000-meter buffers using possibly, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# do 10000-m file
possibly_intersects_10000_m <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m
)

save(
  possibly_intersects_10000_m,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m.rdata"
    )
)

rm(buffer_clips_10000_m, 
   possibly_intersects_10000_m)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 10000-meter, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_10000_m_true_false <- 
  possibly_intersects_10000_m %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_10000_m <- 
  possibly_intersects_10000_m %>% 
  subset(errors_10000_m_true_false)

# save the errors
save(
  errors_10000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m.rdata"
    )
)

```


```{r isolate error cases buffintersector 10000-meter, eval=FALSE, include=FALSE}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_10000_m_errors <- 
  names(errors_10000_m)

# select the actual tracts with errors
buffer_clips_10000_m_throwing_errors <- 
  buffer_clips_10000_m[tract_ids_10000_m_errors]

# select the error messages
error_messages_10000_m <- 
  safely_intersects_10000_m$error[tract_ids_10000_m_errors]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_10000_m,
  errors_10000_m,
  safely_intersects_10000_m,
  tract_ids_10000_m_errors,
  buffer_clips_10000_m_throwing_errors, 
  error_messages_10000_m
)

# clear working memory
gc()

```


##### load remaining errors first

```{r load remaining errors 1, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_1000_m.rdata"  # 0
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m.rdata"  # 10
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m.rdata"  # 16
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m.rdata"  # 35
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m.rdata"  # 92
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m.rdata"  # 183
    )
)

```



#### fixing errors via precision = 1000

```{r 2000 meters 1000 precision, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_2000_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
    }, 
    .x = buffer_clips_2000_m_throwing_errors
  )

# run with safely
safely_intersects_2000_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2000_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_2000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2000_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_2000_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2000_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_2000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2000_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_2000_m_precise_1000_true_false <- 
  possibly_intersects_2000_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_2000_m_precise_1000 <- 
  possibly_intersects_2000_m_precise_1000 %>% 
  subset(errors_2000_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_2000_m_still_erroring <- 
  names(errors_2000_m_precise_1000)

# select the actual tracts with errors
buffer_clips_2000_m_still_erroring <- 
  buffer_clips_2000_m_throwing_errors_precise_1000[tract_ids_2000_m_still_erroring]

# select the error messages
error_messages_2000_m_still_erroring <- 
  safely_intersects_2000_m_precise_1000$error[tract_ids_2000_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_2000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_2000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_2000_m_throwing_errors, 
  error_messages_2000_m, 
  buffintersector, 
  buffer_clips_2000_m_throwing_errors_precise_1000, 
  safely_intersects_2000_m_precise_1000, 
  possibly_intersects_2000_m_precise_1000, 
  errors_2000_m_precise_1000_true_false, 
  errors_2000_m_precise_1000, 
  tract_ids_2000_m_still_erroring, 
  buffer_clips_2000_m_still_erroring, 
  error_messages_2000_m_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 2500 meters 1, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_2500_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
      }, 
    .x = buffer_clips_2500_m_throwing_errors
  )

# run with safely
safely_intersects_2500_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2500_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_2500_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2500_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_2500_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2500_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_2500_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2500_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_2500_m_precise_1000_true_false <- 
  possibly_intersects_2500_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_2500_m_precise_1000 <- 
  possibly_intersects_2500_m_precise_1000 %>% 
  subset(errors_2500_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_2500_m_still_erroring <- 
  names(errors_2500_m_precise_1000)

# select the actual tracts with errors
buffer_clips_2500_m_still_erroring <- 
  buffer_clips_2500_m_throwing_errors_precise_1000[tract_ids_2500_m_still_erroring]

# select the error messages
error_messages_2500_m_still_erroring <- 
  safely_intersects_2500_m_precise_1000$error[tract_ids_2500_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_2500_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_2500_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_2500_m_throwing_errors, 
  error_messages_2500_m, 
  buffintersector, 
  buffer_clips_2500_m_throwing_errors_precise_1000, 
  safely_intersects_2500_m_precise_1000, 
  possibly_intersects_2500_m_precise_1000, 
  errors_2500_m_precise_1000_true_false, 
  errors_2500_m_precise_1000, 
  tract_ids_2500_m_still_erroring, 
  buffer_clips_2500_m_still_erroring, 
  error_messages_2500_m_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 3000 meters the first, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_3000_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
    }, 
    .x = buffer_clips_3000_m_throwing_errors
  )

# run with safely
safely_intersects_3000_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_3000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_3000_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_3000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_3000_m_precise_1000_true_false <- 
  possibly_intersects_3000_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_3000_m_precise_1000 <- 
  possibly_intersects_3000_m_precise_1000 %>% 
  subset(errors_3000_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_3000_m_still_erroring <- 
  names(errors_3000_m_precise_1000)

# select the actual tracts with errors
buffer_clips_3000_m_still_erroring <- 
  buffer_clips_3000_m_throwing_errors_precise_1000[tract_ids_3000_m_still_erroring]

# select the error messages
error_messages_3000_m_still_erroring <- 
  safely_intersects_3000_m_precise_1000$error[tract_ids_3000_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_3000_m_throwing_errors, 
  error_messages_3000_m, 
  buffintersector, 
  buffer_clips_3000_m_throwing_errors_precise_1000, 
  safely_intersects_3000_m_precise_1000, 
  possibly_intersects_3000_m_precise_1000, 
  errors_3000_m_precise_1000_true_false, 
  errors_3000_m_precise_1000, 
  tract_ids_3000_m_still_erroring, 
  buffer_clips_3000_m_still_erroring, 
  error_messages_3000_m_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 4000 meters the first, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_4000_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
    }, 
    .x = buffer_clips_4000_m_throwing_errors
  )

# run with safely
safely_intersects_4000_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_4000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_4000_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_4000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_4000_m_precise_1000_true_false <- 
  possibly_intersects_4000_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_4000_m_precise_1000 <- 
  possibly_intersects_4000_m_precise_1000 %>% 
  subset(errors_4000_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_4000_m_still_erroring <- 
  names(errors_4000_m_precise_1000)

# select the actual tracts with errors
buffer_clips_4000_m_still_erroring <- 
  buffer_clips_4000_m_throwing_errors_precise_1000[tract_ids_4000_m_still_erroring]

# select the error messages
error_messages_4000_m_still_erroring <- 
  safely_intersects_4000_m_precise_1000$error[tract_ids_4000_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_4000_m_throwing_errors, 
  error_messages_4000_m, 
  buffintersector, 
  buffer_clips_4000_m_throwing_errors_precise_1000, 
  safely_intersects_4000_m_precise_1000, 
  possibly_intersects_4000_m_precise_1000, 
  errors_4000_m_precise_1000_true_false, 
  errors_4000_m_precise_1000, 
  tract_ids_4000_m_still_erroring, 
  buffer_clips_4000_m_still_erroring, 
  error_messages_4000_m_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 5000 meters the first, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_5000_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
    }, 
    .x = buffer_clips_5000_m_throwing_errors
  )

# run with safely
safely_intersects_5000_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_5000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_5000_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_5000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_5000_m_precise_1000_true_false <- 
  possibly_intersects_5000_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_5000_m_precise_1000 <- 
  possibly_intersects_5000_m_precise_1000 %>% 
  subset(errors_5000_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_5000_m_still_erroring <- 
  names(errors_5000_m_precise_1000)

# select the actual tracts with errors
buffer_clips_5000_m_still_erroring <- 
  buffer_clips_5000_m_throwing_errors_precise_1000[tract_ids_5000_m_still_erroring]

# select the error messages
error_messages_5000_m_still_erroring <- 
  safely_intersects_5000_m_precise_1000$error[tract_ids_5000_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_5000_m_throwing_errors, 
  error_messages_5000_m, 
  buffintersector, 
  buffer_clips_5000_m_throwing_errors_precise_1000, 
  safely_intersects_5000_m_precise_1000, 
  possibly_intersects_5000_m_precise_1000, 
  errors_5000_m_precise_1000_true_false, 
  errors_5000_m_precise_1000, 
  tract_ids_5000_m_still_erroring, 
  buffer_clips_5000_m_still_erroring, 
  error_messages_5000_m_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 7500 meters the first, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_7500_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
    }, 
    .x = buffer_clips_7500_m_throwing_errors
  )

# run with safely
safely_intersects_7500_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_7500_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_7500_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_7500_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_7500_m_precise_1000_true_false <- 
  possibly_intersects_7500_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_7500_m_precise_1000 <- 
  possibly_intersects_7500_m_precise_1000 %>% 
  subset(errors_7500_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_7500_m_still_erroring <- 
  names(errors_7500_m_precise_1000)

# select the actual tracts with errors
buffer_clips_7500_m_still_erroring <- 
  buffer_clips_7500_m_throwing_errors_precise_1000[tract_ids_7500_m_still_erroring]

# select the error messages
error_messages_7500_m_still_erroring <- 
  safely_intersects_7500_m_precise_1000$error[tract_ids_7500_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_7500_m_throwing_errors, 
  error_messages_7500_m, 
  buffintersector, 
  buffer_clips_7500_m_throwing_errors_precise_1000, 
  safely_intersects_7500_m_precise_1000, 
  possibly_intersects_7500_m_precise_1000, 
  errors_7500_m_precise_1000_true_false, 
  errors_7500_m_precise_1000, 
  tract_ids_7500_m_still_erroring, 
  buffer_clips_7500_m_still_erroring, 
  error_messages_7500_m_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 10000 meters the first, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_throwing_errors.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_10000_m_throwing_errors_precise_1000 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1000)
    }, 
    .x = buffer_clips_10000_m_throwing_errors
  )

# run with safely
safely_intersects_10000_m_precise_1000 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_throwing_errors_precise_1000
) %>% 
  transpose()

save(
  safely_intersects_10000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precise_1000.rdata"
    )
)

# run with possibly
possibly_intersects_10000_m_precise_1000 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_throwing_errors_precise_1000
)

save(
  possibly_intersects_10000_m_precise_1000,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precise_1000.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_10000_m_precise_1000_true_false <- 
  possibly_intersects_10000_m_precise_1000 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_10000_m_precise_1000 <- 
  possibly_intersects_10000_m_precise_1000 %>% 
  subset(errors_10000_m_precise_1000_true_false)

# get the numbers of the tracts with errors
tract_ids_10000_m_still_erroring <- 
  names(errors_10000_m_precise_1000)

# select the actual tracts with errors
buffer_clips_10000_m_still_erroring <- 
  buffer_clips_10000_m_throwing_errors_precise_1000[tract_ids_10000_m_still_erroring]

# select the error messages
error_messages_10000_m_still_erroring <- 
  safely_intersects_10000_m_precise_1000$error[tract_ids_10000_m_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_10000_m_throwing_errors, 
  error_messages_10000_m, 
  buffintersector, 
  buffer_clips_10000_m_throwing_errors_precise_1000, 
  safely_intersects_10000_m_precise_1000, 
  possibly_intersects_10000_m_precise_1000, 
  errors_10000_m_precise_1000_true_false, 
  errors_10000_m_precise_1000, 
  tract_ids_10000_m_still_erroring, 
  buffer_clips_10000_m_still_erroring, 
  error_messages_10000_m_still_erroring
)
  
# cleanup
invisible(gc())

```


###### load more remaining errors 

```{r load remaining errors 2, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m_still_erroring.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m_still_erroring.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_still_erroring.rdata"  # 4
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_still_erroring.rdata"  # 6
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_still_erroring.rdata"  # 9
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_still_erroring.rdata"  # 37
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_still_erroring.rdata"  # 71
    )
)

```



#### fixing remaining errors via precision = 1

```{r 2000 meters 1 precision, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_2000_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_2000_m_still_erroring
  )

# run with safely
safely_intersects_2000_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2000_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_2000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2000_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_2000_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2000_m_still_erroring_precise_1
)

save(
  possibly_intersects_2000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2000_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_2000_m_precise_1_true_false <- 
  possibly_intersects_2000_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_2000_m_precise_1 <- 
  possibly_intersects_2000_m_precise_1 %>% 
  subset(errors_2000_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_2000_m_still_still_erroring <- 
  names(errors_2000_m_precise_1)

# select the actual tracts with errors
buffer_clips_2000_m_still_still_erroring <- 
  buffer_clips_2000_m_still_erroring_precise_1[tract_ids_2000_m_still_still_erroring]

# select the error messages
error_messages_2000_m_still_still_erroring <- 
  safely_intersects_2000_m_precise_1$error[tract_ids_2000_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_2000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2000_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_2000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_2000_m_still_erroring,
  error_messages_2000_m_still_erroring,
  buffintersector,
  buffer_clips_2000_m_still_erroring_precise_1,
  safely_intersects_2000_m_precise_1,
  possibly_intersects_2000_m_precise_1,
  errors_2000_m_precise_1_true_false,
  errors_2000_m_precise_1,
  tract_ids_2000_m_still_still_erroring,
  buffer_clips_2000_m_still_still_erroring,
  error_messages_2000_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 2500 meters 2, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_2500_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_2500_m_still_erroring
  )

# run with safely
safely_intersects_2500_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_2500_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_2500_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_2500_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_2500_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_2500_m_still_erroring_precise_1
)

save(
  possibly_intersects_2500_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2500_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_2500_m_precise_1_true_false <- 
  possibly_intersects_2500_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_2500_m_precise_1 <- 
  possibly_intersects_2500_m_precise_1 %>% 
  subset(errors_2500_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_2500_m_still_still_erroring <- 
  names(errors_2500_m_precise_1)

# select the actual tracts with errors
buffer_clips_2500_m_still_still_erroring <- 
  buffer_clips_2500_m_still_erroring_precise_1[tract_ids_2500_m_still_still_erroring]

# select the error messages
error_messages_2500_m_still_still_erroring <- 
  safely_intersects_2500_m_precise_1$error[tract_ids_2500_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_2500_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_2500_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_2500_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_2500_m_still_erroring,
  error_messages_2500_m_still_erroring,
  buffintersector,
  buffer_clips_2500_m_still_erroring_precise_1,
  safely_intersects_2500_m_precise_1,
  possibly_intersects_2500_m_precise_1,
  errors_2500_m_precise_1_true_false,
  errors_2500_m_precise_1,
  tract_ids_2500_m_still_still_erroring,
  buffer_clips_2500_m_still_still_erroring,
  error_messages_2500_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 3000 meters the second, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_3000_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_3000_m_still_erroring
  )

# run with safely
safely_intersects_3000_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_3000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_3000_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_still_erroring_precise_1
)

save(
  possibly_intersects_3000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_3000_m_precise_1_true_false <- 
  possibly_intersects_3000_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_3000_m_precise_1 <- 
  possibly_intersects_3000_m_precise_1 %>% 
  subset(errors_3000_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_3000_m_still_still_erroring <- 
  names(errors_3000_m_precise_1)

# select the actual tracts with errors
buffer_clips_3000_m_still_still_erroring <- 
  buffer_clips_3000_m_still_erroring_precise_1[tract_ids_3000_m_still_still_erroring]

# select the error messages
error_messages_3000_m_still_still_erroring <- 
  safely_intersects_3000_m_precise_1$error[tract_ids_3000_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_3000_m_still_erroring,
  error_messages_3000_m_still_erroring,
  buffintersector,
  buffer_clips_3000_m_still_erroring_precise_1,
  safely_intersects_3000_m_precise_1,
  possibly_intersects_3000_m_precise_1,
  errors_3000_m_precise_1_true_false,
  errors_3000_m_precise_1,
  tract_ids_3000_m_still_still_erroring,
  buffer_clips_3000_m_still_still_erroring,
  error_messages_3000_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 4000 meters the second, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_4000_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_4000_m_still_erroring
  )

# run with safely
safely_intersects_4000_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_4000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_4000_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_still_erroring_precise_1
)

save(
  possibly_intersects_4000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_4000_m_precise_1_true_false <- 
  possibly_intersects_4000_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_4000_m_precise_1 <- 
  possibly_intersects_4000_m_precise_1 %>% 
  subset(errors_4000_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_4000_m_still_still_erroring <- 
  names(errors_4000_m_precise_1)

# select the actual tracts with errors
buffer_clips_4000_m_still_still_erroring <- 
  buffer_clips_4000_m_still_erroring_precise_1[tract_ids_4000_m_still_still_erroring]

# select the error messages
error_messages_4000_m_still_still_erroring <- 
  safely_intersects_4000_m_precise_1$error[tract_ids_4000_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_4000_m_still_erroring,
  error_messages_4000_m_still_erroring,
  buffintersector,
  buffer_clips_4000_m_still_erroring_precise_1,
  safely_intersects_4000_m_precise_1,
  possibly_intersects_4000_m_precise_1,
  errors_4000_m_precise_1_true_false,
  errors_4000_m_precise_1,
  tract_ids_4000_m_still_still_erroring,
  buffer_clips_4000_m_still_still_erroring,
  error_messages_4000_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 5000 meters, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_5000_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_5000_m_still_erroring
  )

# run with safely
safely_intersects_5000_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_5000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_5000_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_still_erroring_precise_1
)

save(
  possibly_intersects_5000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_5000_m_precise_1_true_false <- 
  possibly_intersects_5000_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_5000_m_precise_1 <- 
  possibly_intersects_5000_m_precise_1 %>% 
  subset(errors_5000_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_5000_m_still_still_erroring <- 
  names(errors_5000_m_precise_1)

# select the actual tracts with errors
buffer_clips_5000_m_still_still_erroring <- 
  buffer_clips_5000_m_still_erroring_precise_1[tract_ids_5000_m_still_still_erroring]

# select the error messages
error_messages_5000_m_still_still_erroring <- 
  safely_intersects_5000_m_precise_1$error[tract_ids_5000_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_5000_m_still_erroring,
  error_messages_5000_m_still_erroring,
  buffintersector,
  buffer_clips_5000_m_still_erroring_precise_1,
  safely_intersects_5000_m_precise_1,
  possibly_intersects_5000_m_precise_1,
  errors_5000_m_precise_1_true_false,
  errors_5000_m_precise_1,
  tract_ids_5000_m_still_still_erroring,
  buffer_clips_5000_m_still_still_erroring,
  error_messages_5000_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 7500 meters the second, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_7500_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_7500_m_still_erroring
  )

# run with safely
safely_intersects_7500_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_7500_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_7500_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_still_erroring_precise_1
)

save(
  possibly_intersects_7500_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_7500_m_precise_1_true_false <- 
  possibly_intersects_7500_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_7500_m_precise_1 <- 
  possibly_intersects_7500_m_precise_1 %>% 
  subset(errors_7500_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_7500_m_still_still_erroring <- 
  names(errors_7500_m_precise_1)

# select the actual tracts with errors
buffer_clips_7500_m_still_still_erroring <- 
  buffer_clips_7500_m_still_erroring_precise_1[tract_ids_7500_m_still_still_erroring]

# select the error messages
error_messages_7500_m_still_still_erroring <- 
  safely_intersects_7500_m_precise_1$error[tract_ids_7500_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_7500_m_still_erroring,
  error_messages_7500_m_still_erroring,
  buffintersector,
  buffer_clips_7500_m_still_erroring_precise_1,
  safely_intersects_7500_m_precise_1,
  possibly_intersects_7500_m_precise_1,
  errors_7500_m_precise_1_true_false,
  errors_7500_m_precise_1,
  tract_ids_7500_m_still_still_erroring,
  buffer_clips_7500_m_still_still_erroring,
  error_messages_7500_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r 10000 meters the second, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_still_erroring.rdata"
    )
)

# load buffintersector
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them precise
buffer_clips_10000_m_still_erroring_precise_1 <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 1)
    }, 
    .x = buffer_clips_10000_m_still_erroring
  )

# run with safely
safely_intersects_10000_m_precise_1 <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_still_erroring_precise_1
) %>% 
  transpose()

save(
  safely_intersects_10000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precise_1.rdata"
    )
)

# run with possibly
possibly_intersects_10000_m_precise_1 <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_still_erroring_precise_1
)

save(
  possibly_intersects_10000_m_precise_1,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precise_1.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_10000_m_precise_1_true_false <- 
  possibly_intersects_10000_m_precise_1 %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_10000_m_precise_1 <- 
  possibly_intersects_10000_m_precise_1 %>% 
  subset(errors_10000_m_precise_1_true_false)

# get the numbers of the tracts with errors
tract_ids_10000_m_still_still_erroring <- 
  names(errors_10000_m_precise_1)

# select the actual tracts with errors
buffer_clips_10000_m_still_still_erroring <- 
  buffer_clips_10000_m_still_erroring_precise_1[tract_ids_10000_m_still_still_erroring]

# select the error messages
error_messages_10000_m_still_still_erroring <- 
  safely_intersects_10000_m_precise_1$error[tract_ids_10000_m_still_still_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_still_still_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_still_still_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_still_still_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_10000_m_still_erroring,
  error_messages_10000_m_still_erroring,
  buffintersector,
  buffer_clips_10000_m_still_erroring_precise_1,
  safely_intersects_10000_m_precise_1,
  possibly_intersects_10000_m_precise_1,
  errors_10000_m_precise_1_true_false,
  errors_10000_m_precise_1,
  tract_ids_10000_m_still_still_erroring,
  buffer_clips_10000_m_still_still_erroring,
  error_messages_10000_m_still_still_erroring
)
  
# cleanup
invisible(gc())

```


```{r load remaining errors 3, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2000_m_still_still_erroring.rdata"  # 0
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_2500_m_still_still_erroring.rdata"  # 0
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_still_still_erroring.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_still_still_erroring.rdata"  # 2
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_still_still_erroring.rdata"  # 6
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_still_still_erroring.rdata"  # 16
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_still_still_erroring.rdata"  # 36
    )
)

```



#### fix remaining tracts with st_make_valid

```{r 3000 meters the third, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_still_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_still_still_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_3000_m_made_valid <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 0)
      st_make_valid(x)
    }, 
    .x = buffer_clips_3000_m_still_still_erroring
  )

# run with safely
safely_intersects_3000_m_made_valid <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_made_valid
) %>% 
  transpose()

save(
  safely_intersects_3000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_made_valid.rdata"
    )
)

# run with possibly
possibly_intersects_3000_m_made_valid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_made_valid
)

save(
  possibly_intersects_3000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_made_valid.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_3000_m_made_valid_true_false <- 
  possibly_intersects_3000_m_made_valid %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_3000_m_made_valid <- 
  possibly_intersects_3000_m_made_valid %>% 
  subset(errors_3000_m_made_valid_true_false)

# get the numbers of the tracts with errors
tract_ids_3000_m_made_valid_erroring <- 
  names(errors_3000_m_made_valid)

# select the actual tracts with errors
buffer_clips_3000_m_made_valid_erroring <- 
  buffer_clips_3000_m_made_valid[tract_ids_3000_m_made_valid_erroring]

# select the error messages
error_messages_3000_m_made_valid_erroring <- 
  safely_intersects_3000_m_made_valid$error[tract_ids_3000_m_made_valid_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_made_valid_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_made_valid_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_3000_m_still_still_erroring, 
  error_messages_3000_m_still_still_erroring, 
  buffintersector,
  buffer_clips_3000_m_made_valid, 
  safely_intersects_3000_m_made_valid, 
  possibly_intersects_3000_m_made_valid, 
  errors_3000_m_made_valid_true_false, 
  errors_3000_m_made_valid,
  tract_ids_3000_m_made_valid_erroring, 
  buffer_clips_3000_m_made_valid_erroring, 
  error_messages_3000_m_made_valid_erroring
)
  
# cleanup
invisible(gc())

```


```{r 4000 meters the third, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_still_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_still_still_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_4000_m_made_valid <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 0)
      st_make_valid(x)
    }, 
    .x = buffer_clips_4000_m_still_still_erroring
  )

# run with safely
safely_intersects_4000_m_made_valid <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m_made_valid
) %>% 
  transpose()

save(
  safely_intersects_4000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_made_valid.rdata"
    )
)

# run with possibly
possibly_intersects_4000_m_made_valid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_made_valid
)

save(
  possibly_intersects_4000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_made_valid.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_4000_m_made_valid_true_false <- 
  possibly_intersects_4000_m_made_valid %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_4000_m_made_valid <- 
  possibly_intersects_4000_m_made_valid %>% 
  subset(errors_4000_m_made_valid_true_false)

# get the numbers of the tracts with errors
tract_ids_4000_m_made_valid_erroring <- 
  names(errors_4000_m_made_valid)

# select the actual tracts with errors
buffer_clips_4000_m_made_valid_erroring <- 
  buffer_clips_4000_m_made_valid[tract_ids_4000_m_made_valid_erroring]

# select the error messages
error_messages_4000_m_made_valid_erroring <- 
  safely_intersects_4000_m_made_valid$error[tract_ids_4000_m_made_valid_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_made_valid_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_made_valid_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_4000_m_still_still_erroring, 
  error_messages_4000_m_still_still_erroring, 
  buffintersector,
  buffer_clips_4000_m_made_valid, 
  safely_intersects_4000_m_made_valid, 
  possibly_intersects_4000_m_made_valid, 
  errors_4000_m_made_valid_true_false, 
  errors_4000_m_made_valid,
  tract_ids_4000_m_made_valid_erroring, 
  buffer_clips_4000_m_made_valid_erroring, 
  error_messages_4000_m_made_valid_erroring
)
  
# cleanup
invisible(gc())

```


```{r 5000 meters the second, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_still_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_still_still_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_5000_m_made_valid <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 0)
      st_make_valid(x)
    }, 
    .x = buffer_clips_5000_m_still_still_erroring
  )

# run with safely
safely_intersects_5000_m_made_valid <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_made_valid
) %>% 
  transpose()

save(
  safely_intersects_5000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_made_valid.rdata"
    )
)

# run with possibly
possibly_intersects_5000_m_made_valid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_made_valid
)

save(
  possibly_intersects_5000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_made_valid.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_5000_m_made_valid_true_false <- 
  possibly_intersects_5000_m_made_valid %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_5000_m_made_valid <- 
  possibly_intersects_5000_m_made_valid %>% 
  subset(errors_5000_m_made_valid_true_false)

# get the numbers of the tracts with errors
tract_ids_5000_m_made_valid_erroring <- 
  names(errors_5000_m_made_valid)

# select the actual tracts with errors
buffer_clips_5000_m_made_valid_erroring <- 
  buffer_clips_5000_m_made_valid[tract_ids_5000_m_made_valid_erroring]

# select the error messages
error_messages_5000_m_made_valid_erroring <- 
  safely_intersects_5000_m_made_valid$error[tract_ids_5000_m_made_valid_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_made_valid_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_made_valid_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_5000_m_still_still_erroring, 
  error_messages_5000_m_still_still_erroring, 
  buffintersector,
  buffer_clips_5000_m_made_valid, 
  safely_intersects_5000_m_made_valid, 
  possibly_intersects_5000_m_made_valid, 
  errors_5000_m_made_valid_true_false, 
  errors_5000_m_made_valid,
  tract_ids_5000_m_made_valid_erroring, 
  buffer_clips_5000_m_made_valid_erroring, 
  error_messages_5000_m_made_valid_erroring
)
  
# cleanup
invisible(gc())

```


```{r 7500 meters the third, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_still_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_still_still_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_7500_m_made_valid <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 0)
      st_make_valid(x)
    }, 
    .x = buffer_clips_7500_m_still_still_erroring
  )

# run with safely
safely_intersects_7500_m_made_valid <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_made_valid
) %>% 
  transpose()

save(
  safely_intersects_7500_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_made_valid.rdata"
    )
)

# run with possibly
possibly_intersects_7500_m_made_valid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_made_valid
)

save(
  possibly_intersects_7500_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_made_valid.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_7500_m_made_valid_true_false <- 
  possibly_intersects_7500_m_made_valid %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_7500_m_made_valid <- 
  possibly_intersects_7500_m_made_valid %>% 
  subset(errors_7500_m_made_valid_true_false)

# get the numbers of the tracts with errors
tract_ids_7500_m_made_valid_erroring <- 
  names(errors_7500_m_made_valid)

# select the actual tracts with errors
buffer_clips_7500_m_made_valid_erroring <- 
  buffer_clips_7500_m_made_valid[tract_ids_7500_m_made_valid_erroring]

# select the error messages
error_messages_7500_m_made_valid_erroring <- 
  safely_intersects_7500_m_made_valid$error[tract_ids_7500_m_made_valid_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_made_valid_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_made_valid_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_7500_m_still_still_erroring, 
  error_messages_7500_m_still_still_erroring, 
  buffintersector,
  buffer_clips_7500_m_made_valid, 
  safely_intersects_7500_m_made_valid, 
  possibly_intersects_7500_m_made_valid, 
  errors_7500_m_made_valid_true_false, 
  errors_7500_m_made_valid,
  tract_ids_7500_m_made_valid_erroring, 
  buffer_clips_7500_m_made_valid_erroring, 
  error_messages_7500_m_made_valid_erroring
)
  
# cleanup
invisible(gc())

```


```{r 10000 meters the third, eval=FALSE, include=FALSE}

# load tracts throwing errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_still_still_erroring.rdata"
    )
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_still_still_erroring.rdata"
    )
)

load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# make them valid
buffer_clips_10000_m_made_valid <- 
  map(
    .f = function(x) {
      st_set_precision(x, precision = 0)
      st_make_valid(x)
    }, 
    .x = buffer_clips_10000_m_still_still_erroring
  )

# run with safely
safely_intersects_10000_m_made_valid <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_made_valid
) %>% 
  transpose()

save(
  safely_intersects_10000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_made_valid.rdata"
    )
)

# run with possibly
possibly_intersects_10000_m_made_valid <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_made_valid
)

save(
  possibly_intersects_10000_m_made_valid,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_made_valid.rdata"
    )
)

# figure out the errors

# make true/false vector for tracts throwing errors
errors_10000_m_made_valid_true_false <- 
  possibly_intersects_10000_m_made_valid %>% 
  str_detect(pattern = "error")

# make list of errors from just those tracts
errors_10000_m_made_valid <- 
  possibly_intersects_10000_m_made_valid %>% 
  subset(errors_10000_m_made_valid_true_false)

# get the numbers of the tracts with errors
tract_ids_10000_m_made_valid_erroring <- 
  names(errors_10000_m_made_valid)

# select the actual tracts with errors
buffer_clips_10000_m_made_valid_erroring <- 
  buffer_clips_10000_m_made_valid[tract_ids_10000_m_made_valid_erroring]

# select the error messages
error_messages_10000_m_made_valid_erroring <- 
  safely_intersects_10000_m_made_valid$error[tract_ids_10000_m_made_valid_erroring]

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_made_valid_erroring.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_made_valid_erroring, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_made_valid_erroring.rdata"
    )
)

# remove objects from the environment
rm(
  buffer_clips_10000_m_still_still_erroring, 
  error_messages_10000_m_still_still_erroring, 
  buffintersector,
  buffer_clips_10000_m_made_valid, 
  safely_intersects_10000_m_made_valid, 
  possibly_intersects_10000_m_made_valid, 
  errors_10000_m_made_valid_true_false, 
  errors_10000_m_made_valid,
  tract_ids_10000_m_made_valid_erroring, 
  buffer_clips_10000_m_made_valid_erroring, 
  error_messages_10000_m_made_valid_erroring
)
  
# cleanup
invisible(gc())

```


```{r load remaining errors 4, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_made_valid_erroring.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_made_valid_erroring.rdata"  # 2
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_made_valid_erroring.rdata"  # 6
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_made_valid_erroring.rdata"  # 14
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_made_valid_erroring.rdata"  # 36
    )
)

```



##### load remaining errors WHY WON'T THEY FIX THEMSELVES

```{r load remaining errors no change 5, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_made_valid_erroring.rdata.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_made_valid_erroring.rdata.rdata"  # 2
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_made_valid_erroring.rdata.rdata"  # 6
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_made_valid_erroring.rdata.rdata"  # 14
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_made_valid_erroring.rdata.rdata"  # 36
    )
)

```



#### remaking the buffers for the remaining errors

```{r revised buffclipper making buffers precise and valid for debugging, eval=FALSE, include=FALSE}

buffclipper_precvalbuffonly <- 
  function(tract_geoid_as_character, 
           buffer_sf, 
           tract_sf) {
    
    # extract one buffer layer and simplify it
    one_buffer_size <- 
      buffer_sf %>% 
      select(monitor_id) %>% 
      st_set_precision(precision = 100000) %>% 
      st_make_valid()
    
    # extract one tract and simplify it
    one_tract <- 
      tract_sf %>% 
      filter(geoid10 == tract_geoid_as_character) %>% 
      select(geoid10) 
    
    # clip buffers to only the one tract
    buffers_in_tract <- 
      one_buffer_size %>% 
      st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
      rowid_to_column("polygon_id")  # add row numbers to id polygons in next step
    
    # check if nrow from the above is zero, and if so, make a tibble and return it
    if(nrow(buffers_in_tract) == 0) {
      null_tibble <- 
        tibble(geoid10 = tract_geoid_as_character, 
               n.overlaps = as.integer(0), 
               origins = as.integer(0), 
               area = as.numeric(0), 
               monitor_id_overlaps = "none", 
               geometry = "none")

      return(null_tibble)
      
    } else {
      
      return(buffers_in_tract)
    
    }
  }
 
# save the function to disk
save(
  buffclipper_precvalbuffonly, 
  file = 
    file.path(
      "functions", 
      "buffclipper_precvalbuffonly.rdata"
    )
)

rm(buffclipper_precvalbuffonly)
invisible(gc())

```


```{r revised buffclipper making buffers and tracts precise and valid for debugging, eval=FALSE, include=FALSE}

buffclipper_precvaltractbuff_timestwo <- 
  function(tract_geoid_as_character, 
           buffer_sf, 
           tract_sf) {
    
    # extract one buffer layer and simplify it
    one_buffer_size <- 
      buffer_sf %>% 
      select(monitor_id) %>% 
      st_set_precision(precision = 100000) %>% 
      st_make_valid()
    
    # extract one tract and simplify it
    one_tract <- 
      tract_sf %>% 
      filter(geoid10 == tract_geoid_as_character) %>% 
      select(geoid10) %>% 
      st_set_precision(precision = 100000) %>% 
      st_make_valid()
    
    # clip buffers to only the one tract
    buffers_in_tract <- 
      one_buffer_size %>% 
      st_intersection(one_tract, .) %>%  # this clips the buffers (buffer sf is .)
      rowid_to_column("polygon_id")  # add row numbers to id polygons in next step
    
    # check if nrow from the above is zero, and if so, make a tibble and return it
    if(nrow(buffers_in_tract) == 0) {
      null_tibble <- 
        tibble(geoid10 = tract_geoid_as_character, 
               n.overlaps = as.integer(0), 
               origins = as.integer(0), 
               area = as.numeric(0), 
               monitor_id_overlaps = "none", 
               geometry = "none")

      return(null_tibble)
      
    } else {
      
      return(buffers_in_tract)
    
    }
  }
 
# save the function to disk
save(
  buffclipper_precvaltractbuff_timestwo, 
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff_timestwo.rdata"
    )
)

rm(buffclipper_precvaltractbuff_timestwo)
invisible(gc())

```



#### clipping buffers using buffclipper_precvalbuffonly

```{r clipped 3000-meter buffers for erroring tracts using buffclipper_precvalbuffonly, eval=FALSE, include=FALSE}

# load buffclipper_precvalbuffonly function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvalbuffonly.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
buffer_clips_3000_m_precvalbuffonly <-
  map(
    .f = buffclipper_precvalbuffonly,
    .x = tract_ids_3000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_3000_m_precvalbuffonly) <- 
  tract_ids_3000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_3000_m_precvalbuffonly,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m_precvalbuffonly.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_3000_m_precvalbuffonly)
invisible(gc())

```


```{r clipped 4000-meter buffers for erroring tracts using buffclipper_precvalbuffonly, eval=FALSE, include=FALSE}

# load buffclipper_precvalbuffonly function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvalbuffonly.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_4000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
buffer_clips_4000_m_precvalbuffonly <-
  map(
    .f = buffclipper_precvalbuffonly,
    .x = tract_ids_4000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_4000_m_precvalbuffonly) <- 
  tract_ids_4000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_4000_m_precvalbuffonly,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_4000_m_precvalbuffonly.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_4000_m_precvalbuffonly)
invisible(gc())

```


```{r clipped 5000-meter buffers for erroring tracts using buffclipper_precvalbuffonly, eval=FALSE, include=FALSE}

# load buffclipper_precvalbuffonly function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvalbuffonly.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
buffer_clips_5000_m_precvalbuffonly <-
  map(
    .f = buffclipper_precvalbuffonly,
    .x = tract_ids_5000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_5000_m_precvalbuffonly) <- 
  tract_ids_5000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_5000_m_precvalbuffonly,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m_precvalbuffonly.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_5000_m_precvalbuffonly)
invisible(gc())

```


```{r clipped 7500-meter buffers for erroring tracts using buffclipper_precvalbuffonly, eval=FALSE, include=FALSE}

# load buffclipper_precvalbuffonly function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvalbuffonly.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
buffer_clips_7500_m_precvalbuffonly <-
  map(
    .f = buffclipper_precvalbuffonly,
    .x = tract_ids_7500_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_7500_m_precvalbuffonly) <- 
  tract_ids_7500_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_7500_m_precvalbuffonly,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m_precvalbuffonly.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_7500_m_precvalbuffonly)
invisible(gc())

```


```{r clipped 10000-meter buffers for erroring tracts using buffclipper_precvalbuffonly, eval=FALSE, include=FALSE}

# load buffclipper_precvalbuffonly function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvalbuffonly.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
buffer_clips_10000_m_precvalbuffonly <-
  map(
    .f = buffclipper_precvalbuffonly,
    .x = tract_ids_10000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_10000_m_precvalbuffonly) <- 
  tract_ids_10000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_10000_m_precvalbuffonly,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m_precvalbuffonly.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_10000_m_precvalbuffonly)
invisible(gc())

```



#### clipping buffers using buffclipper_precvaltractbuff

```{r clipped 3000-meter buffers for erroring tracts using buffclipper_precvaltractbuff, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 3000-meter buffer (TIME SUCK)
buffer_clips_3000_m_precvaltractbuff <-
  map(
    .f = buffclipper_precvaltractbuff,
    .x = tract_ids_3000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_3000_m_precvaltractbuff) <- 
  tract_ids_3000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_3000_m_precvaltractbuff,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m_precvaltractbuff.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_3000_m_precvaltractbuff)
invisible(gc())

```


```{r clipped 4000-meter buffers for erroring tracts using buffclipper_precvaltractbuff, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_4000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 4000-meter buffer (TIME SUCK)
buffer_clips_4000_m_precvaltractbuff <-
  map(
    .f = buffclipper_precvaltractbuff,
    .x = tract_ids_4000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_4000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_4000_m_precvaltractbuff) <- 
  tract_ids_4000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_4000_m_precvaltractbuff,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_4000_m_precvaltractbuff.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_4000_m_precvaltractbuff)
invisible(gc())

```


```{r clipped 5000-meter buffers for erroring tracts using buffclipper_precvaltractbuff, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 5000-meter buffer (TIME SUCK)
buffer_clips_5000_m_precvaltractbuff <-
  map(
    .f = buffclipper_precvaltractbuff,
    .x = tract_ids_5000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_5000_m_precvaltractbuff) <- 
  tract_ids_5000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_5000_m_precvaltractbuff,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m_precvaltractbuff.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_5000_m_precvaltractbuff)
invisible(gc())

```


```{r clipped 7500-meter buffers for erroring tracts using buffclipper_precvaltractbuff, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 7500-meter buffer (TIME SUCK)
buffer_clips_7500_m_precvaltractbuff <-
  map(
    .f = buffclipper_precvaltractbuff,
    .x = tract_ids_7500_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_7500_m_precvaltractbuff) <- 
  tract_ids_7500_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_7500_m_precvaltractbuff,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m_precvaltractbuff.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_7500_m_precvaltractbuff)
invisible(gc())

```


```{r clipped 10000-meter buffers for erroring tracts using buffclipper_precvaltractbuff, eval=FALSE, include=FALSE}

# load buffclipper_precvaltractbuff function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper_precvaltractbuff.rdata"
    )
)

# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load list of tract ids with troubles
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_buffintersector_revised_erroring.rdata"
    )
)

# apply buffer function for all tracts for 10000-meter buffer (TIME SUCK)
buffer_clips_10000_m_precvaltractbuff <-
  map(
    .f = buffclipper_precvaltractbuff,
    .x = tract_ids_10000_m_buffintersector_revised_erroring,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = projected_tracts
  )

# name the sfs
names(buffer_clips_10000_m_precvaltractbuff) <- 
  tract_ids_10000_m_buffintersector_revised_erroring

# save the result
save(
  buffer_clips_10000_m_precvaltractbuff,
  file =
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m_precvaltractbuff.rdata"
      )
  )

# remove object from memory
rm(buffer_clips_10000_m_precvaltractbuff)
invisible(gc())

```



#### intersect using precvalbuffonly buffers

##### 3000 meters big

```{r apply buffintersector to 3000-meter buffers using safely 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m_precvalbuffonly.rdata"
    )
)

# do 3000-meter file
safely_intersects_3000_m_precvalbuffonly <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_precvalbuffonly
) %>% 
  transpose()

save(
  safely_intersects_3000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_3000_m_precvalbuffonly, 
   safely_intersects_3000_m_precvalbuffonly)
invisible(gc())

```


```{r apply buffintersector to 3000-meter buffers using possibly 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvalbuffonly.rdata"
    )
)

# do 3000-m file
possibly_intersects_3000_m_precvalbuffonly <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_precvalbuffonly
)

save(
  possibly_intersects_3000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_3000_m_precvalbuffonly, 
   possibly_intersects_3000_m_precvalbuffonly)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 3000-meter 2, eval=FALSE, include=FALSE}

# load the 3000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvalbuffonly.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m_precvalbuffonly.rdata"
    )
)

# load safely output
load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvalbuffonly.rdata"
    )
)

# load possibly output
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvalbuffonly.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_3000_m_precvalbuffonly_true_false <- 
  possibly_intersects_3000_m_precvalbuffonly %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_3000_m_precvalbuffonly <- 
  possibly_intersects_3000_m_precvalbuffonly %>% 
  subset(errors_3000_m_precvalbuffonly_true_false)

# save the errors
save(
  errors_3000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m_precvalbuffonly.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_3000_m_precvalbuffonly_errors <- 
  names(errors_3000_m_precvalbuffonly)

# select the actual tracts with errors
buffer_clips_3000_m_precvalbuffonly_throwing_errors <- 
  buffer_clips_3000_m_precvalbuffonly[tract_ids_3000_m_precvalbuffonly_errors]

# select the error messages
error_messages_3000_m_precvalbuffonly <- 
  safely_intersects_3000_m_precvalbuffonly$error[tract_ids_3000_m_precvalbuffonly_errors]

# save ids of tracts throwing errors
save(
  tract_ids_3000_m_precvalbuffonly_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvalbuffonly_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_precvalbuffonly_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvalbuffonly_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvalbuffonly.rdata"
    )
)

# remove objects from environment
rm(possibly_intersects_3000_m_precvalbuffonly, 
   errors_3000_m_precvalbuffonly_true_false, 
   errors_3000_m_precvalbuffonly,
   buffer_clips_3000_m_precvalbuffonly,
   safely_intersects_3000_m_precvalbuffonly,
   tract_ids_3000_m_precvalbuffonly_errors,
   buffer_clips_3000_m_precvalbuffonly_throwing_errors, 
   error_messages_3000_m_precvalbuffonly
   )

# clear working memory
invisible(gc())

```


##### 4000 meters again

```{r apply buffintersector to 4000-meter buffers using safely 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 4000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_4000_m_precvalbuffonly.rdata"
    )
)

# do 4000-meter file
safely_intersects_4000_m_precvalbuffonly <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_4000_m_precvalbuffonly
) %>% 
  transpose()

save(
  safely_intersects_4000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_4000_m_precvalbuffonly, 
   safely_intersects_4000_m_precvalbuffonly)
invisible(gc())

```


```{r apply buffintersector to 4000-meter buffers using possibly 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 4000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_precvalbuffonly.rdata"
    )
)

# do 4000-m file
possibly_intersects_4000_m_precvalbuffonly <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_4000_m_precvalbuffonly
)

save(
  possibly_intersects_4000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_4000_m_precvalbuffonly, 
   possibly_intersects_4000_m_precvalbuffonly)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 4000-meter 2, eval=FALSE, include=FALSE}

# load the 4000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_precvalbuffonly.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_4000_m_precvalbuffonly.rdata"
    )
)

# load safely output
load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_4000_m_precvalbuffonly.rdata"
    )
)

# load possibly output
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_4000_m_precvalbuffonly.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_4000_m_precvalbuffonly_true_false <- 
  possibly_intersects_4000_m_precvalbuffonly %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_4000_m_precvalbuffonly <- 
  possibly_intersects_4000_m_precvalbuffonly %>% 
  subset(errors_4000_m_precvalbuffonly_true_false)

# save the errors
save(
  errors_4000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_4000_m_precvalbuffonly.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_4000_m_precvalbuffonly_errors <- 
  names(errors_4000_m_precvalbuffonly)

# select the actual tracts with errors
buffer_clips_4000_m_precvalbuffonly_throwing_errors <- 
  buffer_clips_4000_m_precvalbuffonly[tract_ids_4000_m_precvalbuffonly_errors]

# select the error messages
error_messages_4000_m_precvalbuffonly <- 
  safely_intersects_4000_m_precvalbuffonly$error[tract_ids_4000_m_precvalbuffonly_errors]

# save ids of tracts throwing errors
save(
  tract_ids_4000_m_precvalbuffonly_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_4000_m_precvalbuffonly_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_4000_m_precvalbuffonly_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_4000_m_precvalbuffonly_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_4000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_precvalbuffonly.rdata"
    )
)

# remove objects from environment
rm(possibly_intersects_4000_m_precvalbuffonly, 
   errors_4000_m_precvalbuffonly_true_false, 
   errors_4000_m_precvalbuffonly,
   buffer_clips_4000_m_precvalbuffonly,
   safely_intersects_4000_m_precvalbuffonly,
   tract_ids_4000_m_precvalbuffonly_errors,
   buffer_clips_4000_m_precvalbuffonly_throwing_errors, 
   error_messages_4000_m_precvalbuffonly
   )

# clear working memory
invisible(gc())

```


##### 5000 meters again

```{r apply buffintersector to 5000-meter buffers using safely 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m_precvalbuffonly.rdata"
    )
)

# do 5000-meter file
safely_intersects_5000_m_precvalbuffonly <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_precvalbuffonly
) %>% 
  transpose()

save(
  safely_intersects_5000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_5000_m_precvalbuffonly, 
   safely_intersects_5000_m_precvalbuffonly)
invisible(gc())

```


```{r apply buffintersector to 5000-meter buffers using possibly 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvalbuffonly.rdata"
    )
)

# do 5000-m file
possibly_intersects_5000_m_precvalbuffonly <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_precvalbuffonly
)

save(
  possibly_intersects_5000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_5000_m_precvalbuffonly, 
   possibly_intersects_5000_m_precvalbuffonly)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 5000-meter 2, eval=FALSE, include=FALSE}

# load the 5000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvalbuffonly.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m_precvalbuffonly.rdata"
    )
)

# load safely output
load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvalbuffonly.rdata"
    )
)

# load possibly output
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvalbuffonly.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_5000_m_precvalbuffonly_true_false <- 
  possibly_intersects_5000_m_precvalbuffonly %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_5000_m_precvalbuffonly <- 
  possibly_intersects_5000_m_precvalbuffonly %>% 
  subset(errors_5000_m_precvalbuffonly_true_false)

# save the errors
save(
  errors_5000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m_precvalbuffonly.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_5000_m_precvalbuffonly_errors <- 
  names(errors_5000_m_precvalbuffonly)

# select the actual tracts with errors
buffer_clips_5000_m_precvalbuffonly_throwing_errors <- 
  buffer_clips_5000_m_precvalbuffonly[tract_ids_5000_m_precvalbuffonly_errors]

# select the error messages
error_messages_5000_m_precvalbuffonly <- 
  safely_intersects_5000_m_precvalbuffonly$error[tract_ids_5000_m_precvalbuffonly_errors]

# save ids of tracts throwing errors
save(
  tract_ids_5000_m_precvalbuffonly_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvalbuffonly_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_precvalbuffonly_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvalbuffonly_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvalbuffonly.rdata"
    )
)

# remove objects from environment
rm(possibly_intersects_5000_m_precvalbuffonly, 
   errors_5000_m_precvalbuffonly_true_false, 
   errors_5000_m_precvalbuffonly,
   buffer_clips_5000_m_precvalbuffonly,
   safely_intersects_5000_m_precvalbuffonly,
   tract_ids_5000_m_precvalbuffonly_errors,
   buffer_clips_5000_m_precvalbuffonly_throwing_errors, 
   error_messages_5000_m_precvalbuffonly
   )

# clear working memory
invisible(gc())

```


##### 7500 meters again

```{r apply buffintersector to 7500-meter buffers using safely 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m_precvalbuffonly.rdata"
    )
)

# do 7500-meter file
safely_intersects_7500_m_precvalbuffonly <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_precvalbuffonly
) %>% 
  transpose()

save(
  safely_intersects_7500_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_7500_m_precvalbuffonly, 
   safely_intersects_7500_m_precvalbuffonly)
invisible(gc())

```


```{r apply buffintersector to 7500-meter buffers using possibly 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvalbuffonly.rdata"
    )
)

# do 7500-m file
possibly_intersects_7500_m_precvalbuffonly <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_precvalbuffonly
)

save(
  possibly_intersects_7500_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_7500_m_precvalbuffonly, 
   possibly_intersects_7500_m_precvalbuffonly)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 7500-meter 2, eval=FALSE, include=FALSE}

# load the 7500-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvalbuffonly.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m_precvalbuffonly.rdata"
    )
)

# load safely output
load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvalbuffonly.rdata"
    )
)

# load possibly output
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvalbuffonly.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_7500_m_precvalbuffonly_true_false <- 
  possibly_intersects_7500_m_precvalbuffonly %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_7500_m_precvalbuffonly <- 
  possibly_intersects_7500_m_precvalbuffonly %>% 
  subset(errors_7500_m_precvalbuffonly_true_false)

# save the errors
save(
  errors_7500_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m_precvalbuffonly.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_7500_m_precvalbuffonly_errors <- 
  names(errors_7500_m_precvalbuffonly)

# select the actual tracts with errors
buffer_clips_7500_m_precvalbuffonly_throwing_errors <- 
  buffer_clips_7500_m_precvalbuffonly[tract_ids_7500_m_precvalbuffonly_errors]

# select the error messages
error_messages_7500_m_precvalbuffonly <- 
  safely_intersects_7500_m_precvalbuffonly$error[tract_ids_7500_m_precvalbuffonly_errors]

# save ids of tracts throwing errors
save(
  tract_ids_7500_m_precvalbuffonly_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvalbuffonly_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_precvalbuffonly_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvalbuffonly_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvalbuffonly.rdata"
    )
)

# remove objects from environment
rm(possibly_intersects_7500_m_precvalbuffonly, 
   errors_7500_m_precvalbuffonly_true_false, 
   errors_7500_m_precvalbuffonly,
   buffer_clips_7500_m_precvalbuffonly,
   safely_intersects_7500_m_precvalbuffonly,
   tract_ids_7500_m_precvalbuffonly_errors,
   buffer_clips_7500_m_precvalbuffonly_throwing_errors, 
   error_messages_7500_m_precvalbuffonly
   )

# clear working memory
invisible(gc())

```


##### 10000 meters again

```{r apply buffintersector to 10000-meter buffers using safely 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m_precvalbuffonly.rdata"
    )
)

# do 10000-meter file
safely_intersects_10000_m_precvalbuffonly <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_precvalbuffonly
) %>% 
  transpose()

save(
  safely_intersects_10000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_10000_m_precvalbuffonly, 
   safely_intersects_10000_m_precvalbuffonly)
invisible(gc())

```


```{r apply buffintersector to 10000-meter buffers using possibly 2, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvalbuffonly.rdata"
    )
)

# do 10000-m file
possibly_intersects_10000_m_precvalbuffonly <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_precvalbuffonly
)

save(
  possibly_intersects_10000_m_precvalbuffonly,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvalbuffonly.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_10000_m_precvalbuffonly, 
   possibly_intersects_10000_m_precvalbuffonly)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 10000-meter 2, eval=FALSE, include=FALSE}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvalbuffonly.rdata"
    )
)

# load the error cases
load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m_precvalbuffonly.rdata"
    )
)

# load safely output
load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvalbuffonly.rdata"
    )
)

# load possibly output
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvalbuffonly.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_10000_m_precvalbuffonly_true_false <- 
  possibly_intersects_10000_m_precvalbuffonly %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_10000_m_precvalbuffonly <- 
  possibly_intersects_10000_m_precvalbuffonly %>% 
  subset(errors_10000_m_precvalbuffonly_true_false)

# save the errors
save(
  errors_10000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m_precvalbuffonly.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_10000_m_precvalbuffonly_errors <- 
  names(errors_10000_m_precvalbuffonly)

# select the actual tracts with errors
buffer_clips_10000_m_precvalbuffonly_throwing_errors <- 
  buffer_clips_10000_m_precvalbuffonly[tract_ids_10000_m_precvalbuffonly_errors]

# select the error messages
error_messages_10000_m_precvalbuffonly <- 
  safely_intersects_10000_m_precvalbuffonly$error[tract_ids_10000_m_precvalbuffonly_errors]

# save ids of tracts throwing errors
save(
  tract_ids_10000_m_precvalbuffonly_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvalbuffonly_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_precvalbuffonly_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvalbuffonly_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_precvalbuffonly, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvalbuffonly.rdata"
    )
)

# remove objects from environment
rm(possibly_intersects_10000_m_precvalbuffonly, 
   errors_10000_m_precvalbuffonly_true_false, 
   errors_10000_m_precvalbuffonly,
   buffer_clips_10000_m_precvalbuffonly,
   safely_intersects_10000_m_precvalbuffonly,
   tract_ids_10000_m_precvalbuffonly_errors,
   buffer_clips_10000_m_precvalbuffonly_throwing_errors, 
   error_messages_10000_m_precvalbuffonly
   )

# clear working memory
invisible(gc())

```


##### load remaining errors again

```{r load remaining errors no change 6, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvalbuffonly.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_4000_m_precvalbuffonly.rdata"  # 0
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvalbuffonly.rdata"  # 5
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvalbuffonly.rdata"  # 10
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvalbuffonly.rdata"  # 25
    )
)

```




#### using precvaltractbuff

##### 3000 meters

```{r apply buffintersector to 3000-meter buffers using safely 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_3000_m_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvalbuffonly_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_3000_m_for_precvaltractbuff <- 
  buffer_clips_3000_m_precvaltractbuff[tract_ids_3000_m_precvalbuffonly_errors]

save(
  buffer_clips_3000_m_for_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_for_precvaltractbuff.rdata"
    )
)

# do 3000-meter file
safely_intersects_3000_m_precvaltractbuff <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_3000_m_for_precvaltractbuff
) %>% 
  transpose()

save(
  safely_intersects_3000_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_3000_m_precvaltractbuff, 
   tract_ids_3000_m_precvalbuffonly_errors, 
   buffer_clips_3000_m_for_precvaltractbuff,
   safely_intersects_3000_m_precvaltractbuff)
invisible(gc())

```


```{r apply buffintersector to 3000-meter buffers using possibly 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 3000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_for_precvaltractbuff.rdata"
    )
)

# do 3000-m file
possibly_intersects_3000_m_precvaltractbuff <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_3000_m_for_precvaltractbuff
)

save(
  possibly_intersects_3000_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector,
   buffer_clips_3000_m_for_precvaltractbuff, 
   possibly_intersects_3000_m_precvaltractbuff)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 3000-meter 3, eval=FALSE, include=FALSE}

# load the 3000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_for_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_3000_m_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_3000_m_precvaltractbuff.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_3000_m_precvaltractbuff_true_false <- 
  possibly_intersects_3000_m_precvaltractbuff %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_3000_m_precvaltractbuff <- 
  possibly_intersects_3000_m_precvaltractbuff %>% 
  subset(errors_3000_m_precvaltractbuff_true_false)

# save the errors
save(
  errors_3000_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_3000_m_precvaltractbuff.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_3000_m_precvaltractbuff_errors <- 
  names(errors_3000_m_precvaltractbuff)

# select the actual tracts with errors
buffer_clips_3000_m_precvaltractbuff_throwing_errors <- 
  buffer_clips_3000_m_for_precvaltractbuff[tract_ids_3000_m_precvaltractbuff_errors]

# select the error messages
error_messages_3000_m_precvaltractbuff <- 
  safely_intersects_3000_m_precvaltractbuff$error[tract_ids_3000_m_precvaltractbuff_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_3000_m_precvaltractbuff_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_3000_m_precvaltractbuff_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_3000_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvaltractbuff.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_3000_m_for_precvaltractbuff,
  errors_3000_m_precvaltractbuff_true_false,
  errors_3000_m_precvaltractbuff,
  safely_intersects_3000_m_precvaltractbuff,
  possibly_intersects_3000_m_precvaltractbuff,
  tract_ids_3000_m_precvaltractbuff_errors,
  buffer_clips_3000_m_precvaltractbuff_throwing_errors, 
  error_messages_3000_m_precvaltractbuff
)

# clear working memory
invisible(gc())

```


##### 4000 meters (not needed!  0 tracts!)

##### 5000 meters yet again

```{r apply buffintersector to 5000-meter buffers using safely 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_5000_m_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvalbuffonly_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_5000_m_for_precvaltractbuff <- 
  buffer_clips_5000_m_precvaltractbuff[tract_ids_5000_m_precvalbuffonly_errors]

save(
  buffer_clips_5000_m_for_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_for_precvaltractbuff.rdata"
    )
)

# do 5000-meter file
safely_intersects_5000_m_precvaltractbuff <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_5000_m_for_precvaltractbuff
) %>% 
  transpose()

save(
  safely_intersects_5000_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_5000_m_precvaltractbuff, 
   tract_ids_5000_m_precvalbuffonly_errors, 
   buffer_clips_5000_m_for_precvaltractbuff,
   safely_intersects_5000_m_precvaltractbuff)
invisible(gc())

```


```{r apply buffintersector to 5000-meter buffers using possibly 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 5000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_for_precvaltractbuff.rdata"
    )
)

# do 5000-m file
possibly_intersects_5000_m_precvaltractbuff <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_5000_m_for_precvaltractbuff
)

save(
  possibly_intersects_5000_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector,
   buffer_clips_5000_m_for_precvaltractbuff, 
   possibly_intersects_5000_m_precvaltractbuff)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 5000-meter 3, eval=FALSE, include=FALSE}

# load the 5000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_for_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_5000_m_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_5000_m_precvaltractbuff.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_5000_m_precvaltractbuff_true_false <- 
  possibly_intersects_5000_m_precvaltractbuff %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_5000_m_precvaltractbuff <- 
  possibly_intersects_5000_m_precvaltractbuff %>% 
  subset(errors_5000_m_precvaltractbuff_true_false)

# save the errors
save(
  errors_5000_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_5000_m_precvaltractbuff.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_5000_m_precvaltractbuff_errors <- 
  names(errors_5000_m_precvaltractbuff)

# select the actual tracts with errors
buffer_clips_5000_m_precvaltractbuff_throwing_errors <- 
  buffer_clips_5000_m_for_precvaltractbuff[tract_ids_5000_m_precvaltractbuff_errors]

# select the error messages
error_messages_5000_m_precvaltractbuff <- 
  safely_intersects_5000_m_precvaltractbuff$error[tract_ids_5000_m_precvaltractbuff_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_5000_m_precvaltractbuff_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_5000_m_precvaltractbuff_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_5000_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvaltractbuff.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_5000_m_for_precvaltractbuff,
  errors_5000_m_precvaltractbuff_true_false,
  errors_5000_m_precvaltractbuff,
  safely_intersects_5000_m_precvaltractbuff,
  possibly_intersects_5000_m_precvaltractbuff,
  tract_ids_5000_m_precvaltractbuff_errors,
  buffer_clips_5000_m_precvaltractbuff_throwing_errors, 
  error_messages_5000_m_precvaltractbuff
)

# clear working memory
invisible(gc())

```


##### 7500 meters yet again

```{r apply buffintersector to 7500-meter buffers using safely 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_7500_m_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvalbuffonly_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_7500_m_for_precvaltractbuff <- 
  buffer_clips_7500_m_precvaltractbuff[tract_ids_7500_m_precvalbuffonly_errors]

save(
  buffer_clips_7500_m_for_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_for_precvaltractbuff.rdata"
    )
)

# do 7500-meter file
safely_intersects_7500_m_precvaltractbuff <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_7500_m_for_precvaltractbuff
) %>% 
  transpose()

save(
  safely_intersects_7500_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_7500_m_precvaltractbuff, 
   tract_ids_7500_m_precvalbuffonly_errors, 
   buffer_clips_7500_m_for_precvaltractbuff,
   safely_intersects_7500_m_precvaltractbuff)
invisible(gc())

```


```{r apply buffintersector to 7500-meter buffers using possibly 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 7500-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_for_precvaltractbuff.rdata"
    )
)

# do 7500-m file
possibly_intersects_7500_m_precvaltractbuff <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_7500_m_for_precvaltractbuff
)

save(
  possibly_intersects_7500_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector,
   buffer_clips_7500_m_for_precvaltractbuff, 
   possibly_intersects_7500_m_precvaltractbuff)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 7500-meter 3, eval=FALSE, include=FALSE}

# load the 7500-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_for_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_7500_m_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_7500_m_precvaltractbuff.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_7500_m_precvaltractbuff_true_false <- 
  possibly_intersects_7500_m_precvaltractbuff %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_7500_m_precvaltractbuff <- 
  possibly_intersects_7500_m_precvaltractbuff %>% 
  subset(errors_7500_m_precvaltractbuff_true_false)

# save the errors
save(
  errors_7500_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m_precvaltractbuff.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_7500_m_precvaltractbuff_errors <- 
  names(errors_7500_m_precvaltractbuff)

# select the actual tracts with errors
buffer_clips_7500_m_precvaltractbuff_throwing_errors <- 
  buffer_clips_7500_m_for_precvaltractbuff[tract_ids_7500_m_precvaltractbuff_errors]

# select the error messages
error_messages_7500_m_precvaltractbuff <- 
  safely_intersects_7500_m_precvaltractbuff$error[tract_ids_7500_m_precvaltractbuff_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_7500_m_precvaltractbuff_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_7500_m_precvaltractbuff_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_7500_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvaltractbuff.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_7500_m_for_precvaltractbuff,
  errors_7500_m_precvaltractbuff_true_false,
  errors_7500_m_precvaltractbuff,
  safely_intersects_7500_m_precvaltractbuff,
  possibly_intersects_7500_m_precvaltractbuff,
  tract_ids_7500_m_precvaltractbuff_errors,
  buffer_clips_7500_m_precvaltractbuff_throwing_errors, 
  error_messages_7500_m_precvaltractbuff
)

# clear working memory
invisible(gc())

```


##### 10000 meters yet again

```{r apply buffintersector to 10000-meter buffers using safely 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data",
      "buffer_clips_10000_m_precvaltractbuff.rdata"
    )
)

# load tract ids erroring in precvalbuffonly
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvalbuffonly_errors.rdata"
    )
)

# isolate those still erroring
buffer_clips_10000_m_for_precvaltractbuff <- 
  buffer_clips_10000_m_precvaltractbuff[tract_ids_10000_m_precvalbuffonly_errors]

save(
  buffer_clips_10000_m_for_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_for_precvaltractbuff.rdata"
    )
)

# do 10000-meter file
safely_intersects_10000_m_precvaltractbuff <- 
  map(
  .f = safely(buffintersector), 
  .x = buffer_clips_10000_m_for_precvaltractbuff
) %>% 
  transpose()

save(
  safely_intersects_10000_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector, 
   buffer_clips_10000_m_precvaltractbuff, 
   tract_ids_10000_m_precvalbuffonly_errors, 
   buffer_clips_10000_m_for_precvaltractbuff,
   safely_intersects_10000_m_precvaltractbuff)
invisible(gc())

```


```{r apply buffintersector to 10000-meter buffers using possibly 3, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
      )
  )

# load 10000-meter file
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_for_precvaltractbuff.rdata"
    )
)

# do 10000-m file
possibly_intersects_10000_m_precvaltractbuff <- 
  map(
  .f = possibly(buffintersector, 
                otherwise = "error"), 
  .x = buffer_clips_10000_m_for_precvaltractbuff
)

save(
  possibly_intersects_10000_m_precvaltractbuff,
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff.rdata"
    )
)

rm(buffintersector,
   buffer_clips_10000_m_for_precvaltractbuff, 
   possibly_intersects_10000_m_precvaltractbuff)
invisible(gc())

```


```{r isolate the erroring tracts buffintersector 10000-meter 3, eval=FALSE, include=FALSE}

# load the 10000-meter buffers clipped to tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_for_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "safely_intersects_10000_m_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff.rdata"
    )
)

# make true/false vector for tracts throwing errors
errors_10000_m_precvaltractbuff_true_false <- 
  possibly_intersects_10000_m_precvaltractbuff %>% 
  str_detect(pattern = "error")

# make list of just those tracts
errors_10000_m_precvaltractbuff <- 
  possibly_intersects_10000_m_precvaltractbuff %>% 
  subset(errors_10000_m_precvaltractbuff_true_false)

# save the errors
save(
  errors_10000_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m_precvaltractbuff.rdata"
    )
)

# get the numbers of the tracts with errors
tract_ids_10000_m_precvaltractbuff_errors <- 
  names(errors_10000_m_precvaltractbuff)

# select the actual tracts with errors
buffer_clips_10000_m_precvaltractbuff_throwing_errors <- 
  buffer_clips_10000_m_for_precvaltractbuff[tract_ids_10000_m_precvaltractbuff_errors]

# select the error messages
error_messages_10000_m_precvaltractbuff <- 
  safely_intersects_10000_m_precvaltractbuff$error[tract_ids_10000_m_precvaltractbuff_errors]

# save the ids of tracts still throwing errors
save(
  tract_ids_10000_m_precvaltractbuff_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_errors.rdata"
    )
)

# save the tracts with clipped buffers throwing errors
save(
  buffer_clips_10000_m_precvaltractbuff_throwing_errors, 
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_m_precvaltractbuff_throwing_errors.rdata"
    )
)

# save the error messages
save(
  error_messages_10000_m_precvaltractbuff, 
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvaltractbuff.rdata"
    )
)

# remove files from memory
rm(
  buffer_clips_10000_m_for_precvaltractbuff,
  errors_10000_m_precvaltractbuff_true_false,
  errors_10000_m_precvaltractbuff,
  safely_intersects_10000_m_precvaltractbuff,
  possibly_intersects_10000_m_precvaltractbuff,
  tract_ids_10000_m_precvaltractbuff_errors,
  buffer_clips_10000_m_precvaltractbuff_throwing_errors, 
  error_messages_10000_m_precvaltractbuff
)

# clear working memory
invisible(gc())

```


#### figure out the errors

```{r load remaining errors 7, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_3000_m_precvaltractbuff.rdata"  # 1
    )
)


load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_5000_m_precvaltractbuff.rdata"  # 1
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvaltractbuff.rdata"  # 8
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvaltractbuff.rdata"  # 21
    )
)

```



#### THE TENACIOUS ERRORS (or those I wish to toss out the window)

```{r load hard-core error tracts, eval=FALSE, include=FALSE}

# load the erroring tract ids
load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_3000_m_precvaltractbuff_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_5000_m_precvaltractbuff_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_7500_m_precvaltractbuff_errors.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "tract_ids_10000_m_precvaltractbuff_errors.rdata"
    )
)

# call them hard cores
hard_core_3000_tract_ids <- 
  tract_ids_3000_m_precvaltractbuff_errors

hard_core_5000_tract_ids <- 
  tract_ids_5000_m_precvaltractbuff_errors

hard_core_7500_tract_ids <- 
  tract_ids_7500_m_precvaltractbuff_errors

hard_core_10000_tract_ids <- 
  tract_ids_10000_m_precvaltractbuff_errors

# save the hard cores
save(
  hard_core_3000_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_3000_tract_ids.rdata"
    )
)

save(
  hard_core_5000_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_5000_tract_ids.rdata"
    )
)

save(
  hard_core_7500_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_7500_tract_ids.rdata"
    )
)

save(
  hard_core_10000_tract_ids, 
  file = 
    file.path(
      "intermediate_data", 
      "hard_core_10000_tract_ids.rdata"
    )
)


# load projected tracts data
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
)

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# isolate the erroring tracts
hard_core_3000_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_3000_tract_ids)

hard_core_5000_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_5000_tract_ids)

hard_core_7500_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_7500_tract_ids)

hard_core_10000_raw_tracts <-
  projected_tracts %>% 
  filter(geoid10 %in% hard_core_10000_tract_ids)


# save the erroring tracts
save(
  hard_core_3000_raw_tracts, 
     file = 
       file.path(
         "intermediate_data", 
         "hard_core_3000_raw_tracts.rdata"
       )
  )

save(
  hard_core_5000_raw_tracts, 
     file = 
       file.path(
         "intermediate_data", 
         "hard_core_5000_raw_tracts.rdata"
       )
  )

save(
  hard_core_7500_raw_tracts, 
     file = 
       file.path(
         "intermediate_data", 
         "hard_core_7500_raw_tracts.rdata"
       )
  )

save(
  hard_core_10000_raw_tracts, 
     file = 
       file.path(
         "intermediate_data", 
         "hard_core_10000_raw_tracts.rdata"
       )
  )

# load buffclipper function
load(
  file = 
    file.path(
      "functions", 
      "buffclipper.rdata"
    )
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# clip 3000-meter buffers
buffer_clips_3000_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_3000_tract_ids,
    buffer_sf = buffers$buffer_3000_m,
    tract_sf = hard_core_3000_raw_tracts
  ) %>% 
  set_names(hard_core_3000_tract_ids)

buffer_clips_5000_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_5000_tract_ids,
    buffer_sf = buffers$buffer_5000_m,
    tract_sf = hard_core_5000_raw_tracts
  ) %>% 
  set_names(hard_core_5000_tract_ids)

buffer_clips_7500_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_7500_tract_ids,
    buffer_sf = buffers$buffer_7500_m,
    tract_sf = hard_core_7500_raw_tracts
  ) %>% 
  set_names(hard_core_7500_tract_ids)

buffer_clips_10000_hard <-
  map(
    .f = buffclipper,
    .x = hard_core_10000_tract_ids,
    buffer_sf = buffers$buffer_10000_m,
    tract_sf = hard_core_10000_raw_tracts
  ) %>% 
  set_names(hard_core_10000_tract_ids)

# save the clips
save(
  buffer_clips_3000_hard, 
     file = 
       file.path(
         "intermediate_data", 
         "buffer_clips_3000_hard.rdata"
       )
  )

save(
  buffer_clips_5000_hard, 
     file = 
       file.path(
         "intermediate_data", 
         "buffer_clips_5000_hard.rdata"
       )
  )

save(
  buffer_clips_7500_hard, 
     file = 
       file.path(
         "intermediate_data", 
         "buffer_clips_7500_hard.rdata"
       )
  )

save(
  buffer_clips_10000_hard, 
     file = 
       file.path(
         "intermediate_data", 
         "buffer_clips_10000_hard.rdata"
       )
  )

# rm(list = ls(all.names = TRUE))
# invisible(gc())

```


```{r 3000-m fix the holdouts, eval=FALSE, include=FALSE}

# load clipped tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_3000_hard.rdata"
    )
  
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

snapped_3000_to_26_m <-   # smallest resolution that worked
  st_snap_to_grid(buffer_clips_3000_hard$`47145030700`, 26)

intersected_snapped_3000_to_26_m <- 
  buffintersector(snapped_3000_to_26_m)

holdout_3000_list <- 
  list()

holdout_3000_list$`47145030700` <- 
  intersected_snapped_3000_to_26_m

save(
  holdout_3000_list, 
  file = 
    file.path(
      "intermediate_data", 
      "holdout_3000_list.rdata"
    )
)

# remove all objects from the environment
rm(list = ls(all.names = TRUE))
invisible(gc())

```


```{r 5000s or die, eval=FALSE, include=FALSE}

# load clipped tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_5000_hard.rdata"
    )
  
)

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

snapped_5000_to_20_m <-   # smallest resolution that worked
  st_snap_to_grid(buffer_clips_5000_hard$`47145030800`, 20)

intersected_snapped_5000_to_20_m <- 
  buffintersector(snapped_5000_to_20_m)

holdout_5000_list <- 
  list()

holdout_5000_list$`47145030800` <- 
  intersected_snapped_5000_to_20_m

save(
  holdout_5000_list, 
  file = 
    file.path(
      "intermediate_data", 
      "holdout_5000_list.rdata"
    )
)

# remove all objects from the environment
rm(list = ls(all.names = TRUE))
invisible(gc())

```


```{r 7500s or die, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
  
)

# load clipped tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_7500_hard.rdata"
    )
  
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_7500_m_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_7500_m.rdata"
    )
)


# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# safe buffintersector
safe_buffintersector <- 
  safely(buffintersector)

# make list of holdouts
holdout_7500_list <- 
  list()

# buffer_clips_7500_hard$`27123041900`
snapped_7500_tract_27123041900_to_21 <- 
  buffer_clips_7500_hard$`27123041900` %>% 
  st_snap_to_grid(size = 21)

intersected_snapped_7500_tract_27123041900_to_21 <- 
  safe_buffintersector(snapped_7500_tract_27123041900_to_21)

holdout_7500_list$`27123041900` <- 
  intersected_snapped_7500_tract_27123041900_to_21$result


# buffer_clips_7500_hard$`27053022000`
snapped_7500_tract_27053022000_to_22 <- 
  buffer_clips_7500_hard$`27053022000` %>% 
  st_snap_to_grid(size = 22)

intersected_snapped_7500_tract_27053022000_to_22 <- 
  safe_buffintersector(snapped_7500_tract_27053022000_to_22)

holdout_7500_list$`27053022000` <- 
  intersected_snapped_7500_tract_27053022000_to_22$result


# buffer_clips_7500_hard$`27053125600`
snapped_7500_tract_27053125600_to_14 <- 
  buffer_clips_7500_hard$`27053125600` %>% 
  st_snap_to_grid(size = 14) %>% 
  st_buffer(0)

intersected_snapped_7500_tract_27053125600_to_14 <- 
  safe_buffintersector(snapped_7500_tract_27053125600_to_14)

holdout_7500_list$`27053125600` <- 
  intersected_snapped_7500_tract_27053125600_to_14$result


# buffer_clips_7500_hard$`27053109100`
snapped_7500_tract_27053109100_to_36 <- 
  buffer_clips_7500_hard$`27053109100` %>% 
  st_snap_to_grid(size = 36) %>% 
  st_buffer(0)

intersected_snapped_7500_tract_27053109100_to_36 <- 
  safe_buffintersector(snapped_7500_tract_27053109100_to_36)

holdout_7500_list$`27053109100` <-
  intersected_snapped_7500_tract_27053109100_to_36$result


# buffer_clips_7500_hard$`29510110500`
snapped_7500_tract_29510110500_to_16 <- 
  buffer_clips_7500_hard$`29510110500` %>% 
  st_snap_to_grid(size = 16)

intersected_snapped_7500_tract_29510110500_to_16 <- 
  safe_buffintersector(snapped_7500_tract_29510110500_to_16)

holdout_7500_list$`29510110500` <- 
  intersected_snapped_7500_tract_29510110500_to_16$result


# buffer_clips_7500_hard$`34017015001`
snapped_7500_tract_34017015001_to_16 <- 
  buffer_clips_7500_hard$`34017015001` %>% 
  st_snap_to_grid(size = 16) %>% 
  st_buffer(0)

intersected_snapped_7500_tract_34017015001_to_16 <- 
  safe_buffintersector(snapped_7500_tract_34017015001_to_16)

holdout_7500_list$`34017015001` <- 
  intersected_snapped_7500_tract_34017015001_to_16$result


# buffer_clips_7500_hard$`36061016700`
snapped_7500_tract_36061016700_to_14 <- 
  buffer_clips_7500_hard$`36061016700` %>% 
  st_snap_to_grid(size = 14) %>% 
  st_buffer(0)

intersected_snapped_7500_tract_36061016700_to_14 <- 
  safe_buffintersector(snapped_7500_tract_36061016700_to_14)

holdout_7500_list$`36061016700` <- 
  intersected_snapped_7500_tract_36061016700_to_14$result


# buffer_clips_7500_hard$`39061004200`
snapped_7500_tract_39061004200_to_22 <- 
  buffer_clips_7500_hard$`39061004200` %>% 
  st_snap_to_grid(size = 22) 

intersected_snapped_7500_tract_39061004200_to_22 <- 
  safe_buffintersector(snapped_7500_tract_39061004200_to_22)

holdout_7500_list$`39061004200` <- 
  intersected_snapped_7500_tract_39061004200_to_22$result

save(
  holdout_7500_list, 
  file = 
    file.path(
      "intermediate_data", 
      "holdout_7500_list.rdata"
    )
)

# # remove all objects from the environment
# rm(list = ls(all.names = TRUE))
# invisible(gc())

```


```{r 10000s or die, eval=FALSE, include=FALSE}

# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

# load clipped tracts
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffer_clips_10000_hard.rdata"
    )
  
)

# load errors
load(
  file = 
    file.path(
      "intermediate_data", 
      "error_messages_10000_m_precvaltractbuff.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "errors_10000_m.rdata"
    )
)


# load buffintersector function
load(
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

safe_buffintersector <- 
  safely(buffintersector)

# make list of holdouts
holdout_10000_list <- 
  list()

# buffer_clips_10000_hard$`17119404100`  DONE
snapped_10000_tract_17119404100_to_11 <- 
  buffer_clips_10000_hard$`17119404100` %>% 
  st_snap_to_grid(size = 11) %>% 
  st_buffer(dist = 0)

intersected_snapped_10000_tract_17119404100_to_11 <- 
  safe_buffintersector(snapped_10000_tract_17119404100_to_11)

holdout_10000_list$`17119404100` <- 
  intersected_snapped_10000_tract_17119404100_to_11$result


# buffer_clips_10000_hard$`17119400903`  DONE
snapped_10000_tract_17119400903_to_11 <- 
  buffer_clips_10000_hard$`17119400903` %>% 
  st_snap_to_grid(size = 11) 

intersected_snapped_10000_tract_17119400903_to_11 <- 
  safe_buffintersector(snapped_10000_tract_17119400903_to_11)

holdout_10000_list$`17119400903` <- 
  intersected_snapped_10000_tract_17119400903_to_11$result


# buffer_clips_10000_hard$`18097322600`  DONE
snapped_10000_tract_18097322600_to_21 <- 
  buffer_clips_10000_hard$`18097322600` %>% 
  st_snap_to_grid(size = 21)

intersected_snapped_10000_tract_18097322600_to_21 <- 
  safe_buffintersector(snapped_10000_tract_18097322600_to_21)

holdout_10000_list$`18097322600` <- 
  intersected_snapped_10000_tract_18097322600_to_21$result


# buffer_clips_10000_hard$`27123041700`  DONE
snapped_10000_tract_27123041700_to_12 <- 
  buffer_clips_10000_hard$`27123041700` %>% 
  st_snap_to_grid(size = 12) 

intersected_snapped_10000_tract_27123041700_to_12 <- 
  safe_buffintersector(snapped_10000_tract_27123041700_to_12)

holdout_10000_list$`27123041700` <-
  intersected_snapped_10000_tract_27123041700_to_12$result


# buffer_clips_10000_hard$`27123033300`  DONE
snapped_10000_tract_27123033300_to_45 <- 
  buffer_clips_10000_hard$`27123033300` %>% 
  st_snap_to_grid(size = 45)

intersected_snapped_10000_tract_27123033300_to_45 <- 
  safe_buffintersector(snapped_10000_tract_27123033300_to_45)

holdout_10000_list$`27123033300` <- 
  intersected_snapped_10000_tract_27123033300_to_45$result


# buffer_clips_10000_hard$`27123041302`  DONE
snapped_10000_tract_27123041302_to_34 <- 
  buffer_clips_10000_hard$`27123041302` %>% 
  st_snap_to_grid(size = 34)

intersected_snapped_10000_tract_27123041302_to_34 <- 
  safe_buffintersector(snapped_10000_tract_27123041302_to_34)

holdout_10000_list$`27123041302` <- 
  intersected_snapped_10000_tract_27123041302_to_34$result


# buffer_clips_10000_hard$`27123041800`  DONE
snapped_10000_tract_27123041800_to_33 <- 
  buffer_clips_10000_hard$`27123041800` %>% 
  st_snap_to_grid(size = 33) 

intersected_snapped_10000_tract_27123041800_to_33 <- 
  safe_buffintersector(snapped_10000_tract_27123041800_to_33)

holdout_10000_list$`27123041800` <- 
  intersected_snapped_10000_tract_27123041800_to_33$result


# buffer_clips_10000_hard$`27123036700`  DONE
snapped_10000_tract_27123036700_to_60 <- 
  buffer_clips_10000_hard$`27123036700` %>% 
  st_snap_to_grid(size = 60) %>% 
  st_buffer(dist = 0)

intersected_snapped_10000_tract_27123036700_to_60 <- 
  safe_buffintersector(snapped_10000_tract_27123036700_to_60)

holdout_10000_list$`27123036700` <- 
  intersected_snapped_10000_tract_27123036700_to_60$result


# buffer_clips_10000_hard$`27053022102`  DONE
snapped_10000_tract_27053022102_to_24 <- 
  buffer_clips_10000_hard$`27053022102` %>% 
  st_snap_to_grid(size = 24) 

intersected_snapped_10000_tract_27053022102_to_24 <- 
  safe_buffintersector(snapped_10000_tract_27053022102_to_24)

holdout_10000_list$`27053022102` <- 
  intersected_snapped_10000_tract_27053022102_to_24$result


# buffer_clips_10000_hard$`27053022802`  DONE
snapped_10000_tract_27053022802_to_10 <- 
  buffer_clips_10000_hard$`27053022802` %>% 
  st_snap_to_grid(size = 10) 

intersected_snapped_10000_tract_27053022802_to_10 <- 
  safe_buffintersector(snapped_10000_tract_27053022802_to_10)

holdout_10000_list$`27053022802` <- 
  intersected_snapped_10000_tract_27053022802_to_10$result


# buffer_clips_10000_hard$`27053023000`  DONE
snapped_10000_tract_27053023000_to_35 <- 
  buffer_clips_10000_hard$`27053023000` %>% 
  st_snap_to_grid(size = 35) %>% 
  st_buffer(dist = 0)

intersected_snapped_10000_tract_27053023000_to_35 <- 
  safe_buffintersector(snapped_10000_tract_27053023000_to_35)

holdout_10000_list$`27053023000` <- 
  intersected_snapped_10000_tract_27053023000_to_35$result


# buffer_clips_10000_hard$`27053106400`  DONE
snapped_10000_tract_27053106400_to_10 <- 
  buffer_clips_10000_hard$`27053106400` %>% 
  st_snap_to_grid(size = 10) 

intersected_snapped_10000_tract_27053106400_to_10 <- 
  safe_buffintersector(snapped_10000_tract_27053106400_to_10)

holdout_10000_list$`27053106400` <- 
  intersected_snapped_10000_tract_27053106400_to_10$result


# buffer_clips_10000_hard$`27053011800`  DONE
snapped_10000_tract_27053011800_to_10 <- 
  buffer_clips_10000_hard$`27053011800` %>% 
  st_snap_to_grid(size = 10)

intersected_snapped_10000_tract_27053011800_to_10 <- 
  safe_buffintersector(snapped_10000_tract_27053011800_to_10)

holdout_10000_list$`27053011800` <- 
  intersected_snapped_10000_tract_27053011800_to_10$result


# buffer_clips_10000_hard$`29510111100`  DONE
snapped_10000_tract_29510111100_to_11 <- 
  buffer_clips_10000_hard$`29510111100` %>% 
  st_snap_to_grid(size = 11) 

intersected_snapped_10000_tract_29510111100_to_11 <- 
  safe_buffintersector(snapped_10000_tract_29510111100_to_11)

holdout_10000_list$`29510111100` <- 
  intersected_snapped_10000_tract_29510111100_to_11$result


# buffer_clips_10000_hard$`29510115100`  DONE
snapped_10000_tract_29510115100_to_11 <- 
  buffer_clips_10000_hard$`29510115100` %>% 
  st_snap_to_grid(size = 47) 

intersected_snapped_10000_tract_29510115100_to_11 <- 
  safe_buffintersector(snapped_10000_tract_29510115100_to_11)

holdout_10000_list$`29510115100` <- 
  intersected_snapped_10000_tract_29510115100_to_11$result


# buffer_clips_10000_hard$`29510119300`  DONE
snapped_10000_tract_29510119300_to_24 <- 
  buffer_clips_10000_hard$`29510119300` %>% 
  st_snap_to_grid(size = 24)

intersected_snapped_10000_tract_29510119300_to_24 <- 
  safe_buffintersector(snapped_10000_tract_29510119300_to_24)

holdout_10000_list$`29510119300` <- 
  intersected_snapped_10000_tract_29510119300_to_24$result


# buffer_clips_10000_hard$`34007610800`  DONE
snapped_10000_tract_34007610800_to_35 <- 
  buffer_clips_10000_hard$`34007610800` %>% 
  st_snap_to_grid(size = 35) 

intersected_snapped_10000_tract_34007610800_to_35 <- 
  safe_buffintersector(snapped_10000_tract_34007610800_to_35)

holdout_10000_list$`34007610800` <- 
  intersected_snapped_10000_tract_34007610800_to_35$result


# buffer_clips_10000_hard$`36061023802`  DONE
snapped_10000_tract_36061023802_to_31 <- 
  buffer_clips_10000_hard$`36061023802` %>% 
  st_snap_to_grid(size = 31)

intersected_snapped_10000_tract_36061023802_to_31 <- 
  safe_buffintersector(snapped_10000_tract_36061023802_to_31)

holdout_10000_list$`36061023802` <- 
  intersected_snapped_10000_tract_36061023802_to_31$result


# buffer_clips_10000_hard$`39061006000`  DONE
snapped_10000_tract_39061006000_to_18 <- 
  buffer_clips_10000_hard$`39061006000` %>% 
  st_snap_to_grid(size = 18)

intersected_snapped_10000_tract_39061006000_to_18 <- 
  safe_buffintersector(snapped_10000_tract_39061006000_to_18)

holdout_10000_list$`39061006000` <- 
  intersected_snapped_10000_tract_39061006000_to_18$result


# buffer_clips_10000_hard$`42101028902`  DONE
snapped_10000_tract_42101028902_to_02 <- 
  buffer_clips_10000_hard$`42101028902` %>% 
  st_snap_to_grid(size = 2) 

intersected_snapped_10000_tract_42101028902_to_02 <- 
  safe_buffintersector(snapped_10000_tract_42101028902_to_02)

holdout_10000_list$`42101028902` <- 
  intersected_snapped_10000_tract_42101028902_to_02$result


# buffer_clips_10000_hard$`42101029300`  DONE
snapped_10000_tract_42101029300_to_11 <- 
  buffer_clips_10000_hard$`42101029300` %>% 
  st_snap_to_grid(size = 11) %>% 
  st_buffer(dist = 0)

intersected_snapped_10000_tract_42101029300_to_11 <- 
  safe_buffintersector(snapped_10000_tract_42101029300_to_11)

holdout_10000_list$`42101029300` <- 
  intersected_snapped_10000_tract_42101029300_to_11$result

# save the list of results
save(
  holdout_10000_list, 
  file = 
    file.path(
      "intermediate_data", 
      "holdout_10000_list.rdata"
    )
)

# remove all objects from the environment
rm(list = ls(all.names = TRUE))
invisible(gc())

```


```{r notes on errors, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "holdout_10000_list.rdata"
    )
)

# collect the non-errors

# notes on needs for each size

# 1-km
## possibly_intersects_1000_m 
## DONE

# 2-km 
## possibly_intersects_2000_m 
## possibly_intersects_2000_m_precise_1000
## possibly_intersects_2000_m_precise_1
## DONE

# 2.5-km
## possibly_intersects_2500_m
## possibly_intersects_2500_m_precise_1000
## possibly_intersects_2500_m_precise_1
## DONE

# 3-km 
## possibly_intersects_3000_m
## possibly_intersects_3000_m_precise_1000
## possibly_intersects_3000_m_precise_1
## possibly_intersects_3000_m_made_valid # could skip

# 4-km 
## possibly_intersects_4000_m
## possibly_intersects_4000_m_precise_1000
## possibly_intersects_4000_m_precise_1
## possibly_intersects_4000_m_made_valid # could skip

# 5-km
## possibly_intersects_5000_m
## possibly_intersects_5000_m_precise_1000
## possibly_intersects_5000_m_precise_1
## possibly_intersects_5000_m_made_valid # could skip

# 7.5-km
## possibly_intersects_7500_m
## possibly_intersects_7500_m_precise_1000
## possibly_intersects_7500_m_precise_1
## possibly_intersects_7500_m_made_valid

# 10-km
## possibly_intersects_10000_m
## possibly_intersects_10000_m_precise_1000
## possibly_intersects_10000_m_precise_1
## possibly_intersects_10000_m_made_valid # could skip


```





```{r notes, eval=FALSE, include=FALSE}

# initial run

# needs for 1-km
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_1000_m.rdata"
    )
)

# needs for 2-km
load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_2000_m.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "possibly_intersects_10000_m_precvaltractbuff.rdata"
    )
)

```


```{r dags}

# list of variables for reference

# # make list of needed variables
# sf1_totalcensus_var_list <- 
#   list(
#     total_pop_sf1_p1,
#     race_sf1_p5,
#     race_sf1_pct23, 
#     hisp_lat_origin_sf1_pct11,
#     sex_by_age_sf1_p12,
#     age_median_sf1_p13,
#     occupancy_sf1_h3,
#     housing_tenure_sf1_h4,
#     housing_tenure_people_sf1_h11
#   )

my_dag <- dagify(pm ~ segregation,
                 segregation ~ wealth + other,
                 pm ~ other,
                 exposure = "segregation",
                 outcome = "pm"
                 )

ggdag_parents(my_dag, "segregation") + 
  theme_dag() 

```







### within-tract intersections for the buffers


```{r buffer intersection function without precision or buffer fixes for debugging, eval=FALSE, include=FALSE}

buffintersector <- 
  function(buffers_in_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if("monitor_id" %in% colnames(buffers_in_tract_sf)){
      
      concordance_vector <- 
        setNames(
          object = buffers_in_tract_sf$monitor_id,  # object to named
          nm = buffers_in_tract_sf$polygon_id  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_in_tract_sf %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
      
    } else {
      return(buffers_in_tract_sf)
    }
  }
 
# save the function to disk
save(
  buffintersector, 
  file = 
    file.path(
      "functions", 
      "buffintersector.rdata"
    )
)

rm(buffintersector)
invisible(gc())

```




```{r buffer intersection function without precision or buffer fixes for debugging, eval=FALSE, include=FALSE}

buffer_intersector_old <- 
  function(buffers_clipped_to_tract_sf) {
    # make concordance vector to replace "origin" values (rows) with monitor ids
    
    if(!("sf" %in% class(buffers_clipped_to_tract_sf))){
      
      return("no_buffers_here")
      
    } else {
      
      concordance_vector <-
        setNames(
          object = buffers_clipped_to_tract_sf$monitor_id,  # object to named
          nm = buffers_clipped_to_tract_sf$buffer_index  # names (polygon #s)
        )
      
      # find buffer intersections and areas by monitor
      buffer_intersections <- 
        buffers_clipped_to_tract_sf %>% 
        st_intersection() %>% 
        mutate(area = st_area(geometry),  # add areas
               monitor_id_overlaps =  # add column of monitor ids
                 map(
                   .x = origins,  # go through the origin column (with polygon #s)
                   .f = function(a) concordance_vector[a]  # replace with monitor ids
                   )
               ) %>% 
        select(-c(polygon_id, monitor_id))  # remove origin polygon id and monitor id
      return(buffer_intersections)
    }
  }
 
# save the function to disk
save(
  buffer_intersector_old, 
  file = 
    file.path(
      "functions", 
      "buffer_intersector_old.rdata"
    )
)

# remove all objects from the environment
rm(list = ls(all.names = TRUE))

```



```{r}

# isolate tract with no buffers in it
al_tract_1_buffer_intersections <- 
  al_buffer_tract_intersections_polygons$buffer_1000_m[[1]] 

# isolate tract with one buffer in it
al_tract_7_buffer_intersections <- 
  al_buffer_tract_intersections_polygons$buffer_1000_m[[7]] 

# isolate tract with two buffers in it
al_tract_145_buffer_intersections <- 
  al_buffer_tract_intersections_polygons$buffer_1000_m[[145]] 

# get tract row ids
al_polygon_tract_index <- 
  al_tracts_simple %>% 
  pull(al_polygon_tract_index)

# get buffer row ids <- 
al_buffer_index <- 
  al_buffers$buffer_1000_m %>% 
  pull(al_buffer_index)

buffers_full_in_single_tract <-   # geometry still ok
  buffer_filter(tract_buffer_sgbp_row = buffer_tract_intersections_polygons$buffer_1000_m[[7]], 
                      buffer_sf = buffers$buffer_1000_m)

single_clipped_tract_2 <- 
  tract_buffer_filter(tract_buffer_sgbp_row = buffer_tract_intersections_polygons$buffer_1000_m[[7]], 
                      buffer_sf = buffers$buffer_1000_m)

```


```{r al buffer clipper after intersections testing}

# load relevant files
load(
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts_simple.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "al_buffers.rdata"
    )
)

load(
  file = 
    file.path(
      "intermediate_data", 
      "al_buffer_tract_intersections_polygons.rdata"
    )
)

# select buffers in that tract from buffer tibble
little_buffer_tibble <- 
  al_buffers$buffer_1000_m %>% 
  filter(al_buffer_index %in% al_tract_145_buffer_intersections)

# select tract from tract tibble 
single_tract_tibble <- 
  al_tracts_simple[145,] 

# clip buffers in the tract to the tract
al_intersection_tract_145_buffers_clipped <-
  little_buffer_tibble %>%
  st_intersection(single_tract_tibble, .) # this clips the buffers (buffer sf is .)

# little filter function
tract_buffer_filter <- 
  function(tract_buffer_sgbp_row, 
           buffer_sf) {
    initial_filter_sf <- 
      buffer_sf %>% 
        filter(al_buffer_index %in% tract_buffer_sgbp_row)
    if(nrow(initial_filter_sf) == 0){
      return("no_buffers_here")
    } else {
      return(initial_filter_sf)
    }
  }

# make buffers by tract
al_buffers_by_tract_1000_m_sf_list <- 
  map(.f = tract_buffer_filter, 
      .x = al_buffer_tract_intersections_polygons$buffer_1000_m, 
      buffer_sf = al_buffers$buffer_1000_m
  )

# make buffer clipper function
buffer_clipper_single_tract <- 
  function(tract_sf, 
           buffers_by_tract_sf){
    
    if(!("sf" %in% class(buffers_by_tract_sf))){
      
      return("no_buffers_here")
      
    } else {
      
      tract_buffer_intersection <- 
        tract_sf %>% 
        st_intersection(buffers_by_tract_sf)
    }
    
  }

# make tract sf into a list of single-feature sfs
al_tracts_simple_list <- 
  split(al_tracts_simple, 
        seq(nrow(al_tracts_simple)))

# buffer_clipper_multi_tract <- 
#   function(buffer_clipper_function,
#            tract_list,
#            buffers_by_tract_list){
#     # future::plan(strategy = "multiprocess")
#     map2(
#       .f = buffer_clipper_function,
#       .x = tract_list,
#       .y = buffers_by_tract_list
#     )
#   }

# clip 1000-meter buffers for all tracts
al_tracts_clipped_buffers_1000_m <- 
  map2(
    .f = buffer_clipper_single_tract, 
    .x = al_tracts_simple_list, 
    .y = al_buffers_by_tract_1000_m_sf_list
  )

# # visual check of result
# library(mapview)
# mapview::mapView(list(tracts_clipped_buffers[[145]], al_tracts_simple[145,]), native.crs = TRUE)


# remove all objects from the environment
rm(list = ls(all.names = TRUE))

```



```{r make alabama sample testing dataset}

# load buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "buffers.rdata"
    )
)

# load projected tracts data as multipolygons
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts.rdata"
    )
  )

# load projected tracts data as singlepolygons
load(
  file = 
    file.path(
      "intermediate_data", 
      "projected_tracts_simple.rdata"
    )
)

# isolate alabama tracts
al_tracts <- 
  projected_tracts %>% 
  filter(str_detect(geoid10, "^01.*")) %>% 
  rowid_to_column("al_multipolygon_tract_index")

# isolate simple polygon alabama tracts
al_tracts_simple <- 
  projected_tracts_simple %>% 
  filter(str_detect(geoid10, "^01.*")) %>% 
  rowid_to_column("al_polygon_tract_index")

al_buffer_select_enumerate <- 
  function(buffer_sf) {
    al_buffer_output <- 
      filter(buffer_sf, str_detect(buffer_sf$monitor_id, "^01.*")) %>% 
      rowid_to_column("al_buffer_index")
  }

# isolate alabama buffers
al_buffers <-
  map(
    .f = al_buffer_select_enumerate, 
    .x = buffers
  )

# save the files
save(
  al_tracts, 
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts.rdata"
    )
)

save(
  al_tracts_simple, 
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts_simple.rdata"
    )
)

save(
  al_buffers, 
  file = 
    file.path(
      "intermediate_data", 
      "al_buffers.rdata"
    )
)

# extract one tract and simplify it
one_tract_no_intersect_02270000100 <-
  projected_tracts %>%
  filter(geoid10 == "02270000100") %>%
  select(geoid10) %>% 
  st_cast("POLYGON")

one_tract_yes_intersect_01121011300 <- 
  projected_tracts %>%
  filter(geoid10 == "01121011300") %>%
  select(geoid10) %>% 
  st_cast("POLYGON")

# one buffer size
one_buffer_size <-
  buffers$buffer_1000_m %>%
  select(monitor_id)

# check if any intersections exist (this should have none)
intersect_check_nope <-
  one_buffer_size %>%
  st_intersects(one_tract_no_intersect_02270000100, .) %>% 
  pluck(1) # the index of the intersecting buffer as an integer

# check if any intersections exist (this should have one)
intersect_check_yup <-
  one_buffer_size %>%
  st_intersects(one_tract_yes_intersect_01121011300, .) %>% 
  pluck(1)  # the index of the intersecting buffer as an integer

# remove all objects from the environment
rm(list = ls(all.names = TRUE))

```



```{r al calculate buffer intersections with tracts}

# load al buffers
load(
  file = 
    file.path(
      "intermediate_data", 
      "al_buffers.rdata"
    )
)

# load al projected tracts as multipolygons
load(
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts_simple.rdata"
    )
)

# load al projected tracts as singlepolygons
load(
  file = 
    file.path(
      "intermediate_data", 
      "al_tracts.rdata"
    )
)

# calculate for all buffer sizes for singlepolygons
al_buffer_tract_intersections_polygons <- 
  map(
    .f = function(x, y) st_intersects(y, x), 
    .x = al_buffers, 
    y = al_tracts_simple
  )

# calculate for all buffer sizes for multipolygons
al_buffer_tract_intersections_multipolygons <- 
  map(
    .f = function(x, y) st_intersects(y, x), 
    .x = al_buffers, 
    y = al_tracts
  )

# save the results
save(
  al_buffer_tract_intersections_polygons, 
  file = 
    file.path(
      "intermediate_data", 
      "al_buffer_tract_intersections_polygons.rdata"
    )
)

save(
  al_buffer_tract_intersections_multipolygons, 
  file = 
    file.path(
      "intermediate_data", 
      "al_buffer_tract_intersections_multipolygons.rdata"
    )
)

# remove all objects from the environment
rm(list = ls(all.names = TRUE))

```


```{r try applying the buffer intersector, eval=FALSE, include=FALSE}

load(
  file = 
    file.path(
      "intermediate_data", 
      "clipped_buffers.rdata"
      )
  )

load(
  file = 
    file.path(
      "functions", 
      "buffer_intersector_tract.rdata"
    )
)

# do 1000-m file and catch errors
safely_intersects_1000_m <- 
  future_map(
  .f = safely(buffer_intersector_tract), 
  .x = clipped_buffers_1000_m
) %>% 
  transpose()

# do 1000-m file on the wild side
buffer_intersections_1000_m <- 
  future_map(
  .f = buffer_intersector_tract, 
  .x = clipped_buffers_1000_m
)

```




```{r buffer erroring tracts by 0}

# load functions to save and load intermediate files
load(file = file.path("functions", "intermediate_object_loader.rdata"))
load(file = file.path("functions", "intermediate_object_saver.rdata"))
load(file = file.path("functions", "safe_buffer_intersector_nation.rdata"))
load(file = file.path("functions", "buffer_intersector_tract.rdata"))

# load files
intermediate_object_loader("erroring_tracts", 
                           "indices_tracts_erroring_post_snap_precise")

# make function to buffer tracts by zero
buffer_zero_function <- 
  function(buffers_by_tract) {
    map(.x = buffers_by_tract,
        .f = function(x) st_buffer(x, dist = 0))
  }

# make tracts precise and try again
erroring_tracts_buffer_zero <- 
  map(.x = erroring_tracts, 
      .f = buffer_zero_function)

# safely intersect all buffer sizes for all erroring tracts
safely_intersected_buffered_erroring_tracts <-
  map(.f = safe_buffer_intersector_nation,
      .x = erroring_tracts_buffer_zero,
      buffer_intersector_little_function = buffer_intersector_tract #,
    # .progress = TRUE
  )

# investigate errors
buffer_zero_remaining_errors <-
  map(.f = function(x) Filter(Negate(is.null),
                              x$error),
      .x = safely_intersected_buffered_erroring_tracts)

# count errors
buffer_zero_error_counts <-
  map(
    .x = buffer_zero_remaining_errors,
    .f = length
  )

# get buffer indices of tracts still erroring
buffer_zero_still_erroring_indices <-
  map(
    .f = names,
    .x = buffer_zero_remaining_errors
  )

# indices of tracts still erroring
indices_tracts_erroring_post_snap_precise_buffer_zero <- 
  map2(.x = indices_tracts_erroring_post_snap_precise,
       .y = buffer_zero_still_erroring_indices, 
       .f = intersect)

# counts of tracts still erroring
counts_erroring_post_snap_precise_buffer_zero <- 
  map(.x = indices_tracts_erroring_post_snap_precise_buffer_zero, 
      length)



# select the tracts still erroring
tracts_still_erroring_after_snapping <-
  map2(
    .x = erroring_tracts, 
    .y = snapped_tracts_error_indices,
    .f = function(x, y) x[y]
  )

```
